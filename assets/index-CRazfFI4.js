var Ft=Object.defineProperty;var Gt=(c,t,e)=>t in c?Ft(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var M=(c,t,e)=>Gt(c,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();const Ht=200;function T(c,t){return{x:c,y:t}}function Nt(c,t){return{x:c.x+t.x,y:c.y+t.y}}function Ot(c,t){return{x:c.x*t,y:c.y*t}}function qt(c){switch(c){case"up":return T(0,-1);case"down":return T(0,1);case"left":return T(-1,0);case"right":return T(1,0)}}function Yt(c,t,e=Ht){const i=qt(t.direction),s=e*t.deltaTime,o=Ot(i,s);return Nt(c,o)}function yt(c,t,e,i){const s=i/2;return{x:Math.max(s,Math.min(t-s,c.x)),y:Math.max(s,Math.min(e-s,c.y))}}function ot(c,t){const e=c.x-t.x,i=c.y-t.y;return Math.sqrt(e*e+i*i)}function Tt(c,t,e,i){return ot(c,e)<t+i}function Xt(c,t,e,i){return Tt(c,t,e,i)}function jt(c,t,e,i=15){return Tt(c,t,e,i)}const zt={coins:{min:0,max:Number.MAX_SAFE_INTEGER},energy:{min:0,max:100},mood:{min:0,max:100},thirst:{min:0,max:100},hunger:{min:0,max:100},karma:{min:-Number.MAX_SAFE_INTEGER,max:Number.MAX_SAFE_INTEGER},speed:{min:50,max:200},bathroom:{min:0,max:100}};function it(c,t,e=zt){return{coins:O(c.coins+(t.coins??0),e.coins.min,e.coins.max),energy:O(c.energy+(t.energy??0),e.energy.min,e.energy.max),mood:O(c.mood+(t.mood??0),e.mood.min,e.mood.max),thirst:O(c.thirst+(t.thirst??0),e.thirst.min,e.thirst.max),hunger:O(c.hunger+(t.hunger??0),e.hunger.min,e.hunger.max),karma:O(c.karma+(t.karma??0),e.karma.min,e.karma.max),speed:O(c.speed+(t.speed??0),e.speed.min,e.speed.max),lightBattery:O(c.lightBattery+(t.lightBattery??0),0,100),bathroom:O(c.bathroom+(t.bathroom??0),e.bathroom.min,e.bathroom.max)}}function O(c,t,e){return Math.max(t,Math.min(e,c))}const V={energyDecayPerPixel:.01,moodDecayPerSecond:.1,moodDecayFromLowEnergy:.2,lowEnergyThreshold:30,thirstDecayPerSecond:.75,hungerDecayPerSecond:.5,karmaDecayPerSecond:.01,bathroomDecayPerSecond:.3};function Ut(c,t=V){return-(c*t.energyDecayPerPixel)}function _t(c,t,e,i,s,o=V){const a=t,n=100-e,r=100-i,u=((a+n+r)/3-s)*2*c,f=-(c*o.moodDecayPerSecond);return u+f}function Kt(c,t=V){return c*t.thirstDecayPerSecond}function Vt(c,t=V){return c*t.hungerDecayPerSecond}function Jt(c,t,e=V){return t>0?-(c*e.karmaDecayPerSecond):t<0?c*e.karmaDecayPerSecond:0}function Qt(c,t=V){return c*t.bathroomDecayPerSecond}function Zt(c,t,e,i=V){const s=Ut(c,i),o=_t(t,e.energy,e.thirst,e.hunger,e.mood,i),a=Kt(t,i),n=Vt(t,i),r=Jt(t,e.karma,i),l=Qt(t,i);return{energy:s,mood:o,thirst:a,hunger:n,karma:r,bathroom:l}}const Wt={caffeine:{type:"caffeine",duration:10,intensity:.3,effects:{timeScale:1.2,speed:20,energy:15,thirst:-10}},alcohol:{type:"alcohol",duration:12,intensity:.5,effects:{timeScale:.8,speed:-15,mood:20,energy:-10,thirst:15}},mdma:{type:"mdma",duration:24,intensity:.8,effects:{timeScale:1.5,speed:30,mood:40,energy:25,thirst:20,hunger:-15}},weed:{type:"weed",duration:18,intensity:.4,effects:{timeScale:.7,mood:15,hunger:20,speed:-10}},molly:{type:"molly",duration:18,intensity:1,effects:{timeScale:.3,mood:25,energy:10,thirst:20,hunger:-5}},shrooms:{type:"shrooms",duration:48,intensity:.8,effects:{timeScale:.5,mood:25,hunger:-8,karma:8}},acid:{type:"acid",duration:45,intensity:1,effects:{timeScale:.2,mood:12,hunger:-10,thirst:-8}},dmt:{type:"dmt",duration:10,intensity:1,effects:{timeScale:.1,mood:50,energy:40,hunger:-30,thirst:-20,karma:25}},salvia:{type:"salvia",duration:12,intensity:.8,effects:{timeScale:.2,mood:20,hunger:-15,thirst:-10}},whipits:{type:"whipits",duration:5,intensity:1,effects:{timeScale:.1,speed:-90,mood:8,energy:5}},"energy-drink":{type:"energy-drink",duration:30,intensity:.6,effects:{timeScale:2,speed:40,energy:30,thirst:-15}},"mystery-pill":{type:"mystery-pill",duration:24,intensity:.8,effects:{timeScale:.8,speed:15,mood:20,energy:15}},"mystery-snowball":{type:"mystery-snowball",duration:12,intensity:.7,effects:{timeScale:2,speed:50,energy:20,mood:10}},cigarette:{type:"cigarette",duration:5,intensity:.3,effects:{timeScale:1,mood:5,energy:-5,thirst:-5}},joint:{type:"joint",duration:18,intensity:.4,effects:{timeScale:.7,mood:15,hunger:20,thirst:15,speed:-10}},vodka:{type:"vodka",duration:24,intensity:.5,effects:{timeScale:.8,speed:-20,mood:15,energy:-15,thirst:20}},mda:{type:"mda",duration:30,intensity:.7,effects:{timeScale:.9,speed:15,mood:25,energy:20,thirst:15}},"2c-i":{type:"2c-i",duration:36,intensity:.8,effects:{timeScale:.7,mood:20,hunger:-15,thirst:-10}},cocaine:{type:"cocaine",duration:30,intensity:.9,effects:{timeScale:1.2,speed:20,mood:25,energy:30,hunger:-10,thirst:-15}},ketamine:{type:"ketamine",duration:10,intensity:.8,effects:{timeScale:.2,speed:-80,mood:20,energy:15,hunger:-5,thirst:-10}},cannabis:{type:"cannabis",duration:24,intensity:.5,effects:{timeScale:.8,mood:20,hunger:25,speed:-15,energy:-5}}};function te(c,t=1){var i,s,o,a,n,r,l;const e=Wt[c];if(!e)throw new Error(`Unknown drug type: ${c}`);return{type:c,duration:e.duration,intensity:Math.min(1,Math.max(0,t)),effects:{timeScale:(i=e.effects)==null?void 0:i.timeScale,speed:(s=e.effects)==null?void 0:s.speed,energy:(o=e.effects)==null?void 0:o.energy,mood:(a=e.effects)==null?void 0:a.mood,thirst:(n=e.effects)==null?void 0:n.thirst,hunger:(r=e.effects)==null?void 0:r.hunger,karma:(l=e.effects)==null?void 0:l.karma}}}function ee(c,t){const e=t,s=c.active.map(o=>{const a=Math.max(0,o.duration-e);return{...o,duration:a}}).filter(o=>o.duration>0);return{...c,active:s}}function ie(c,t){if(c.active.length>=c.maxStack){const i=[...c.active].sort((s,o)=>s.duration-o.duration);return i.shift(),i.push(t),{...c,active:i}}const e=c.active.findIndex(i=>i.type===t.type);if(e!==-1){const i=c.active[e],s={...t,intensity:Math.min(1,i.intensity+t.intensity*.5),duration:i.duration+t.duration*.5},o=[...c.active];return o[e]=s,{...c,active:o}}return{...c,active:[...c.active,t]}}function bt(c){let t=1;for(const e of c.active)e.effects.timeScale&&(t*=e.effects.timeScale);return t}function G(c,t){return c.active.some(e=>e.type===t&&e.duration>0)}const It={baseSpeed:100,energyThreshold:30,thirstThreshold:30,hungerThreshold:30,moodThreshold:30,maxSpeedMultiplier:1.5,minSpeedMultiplier:.3};function se(c,t=It){let e=1;if(c.energy<t.energyThreshold){const i=c.energy/t.energyThreshold;e*=.3+i*.7}else c.energy>80&&(e*=1.2);if(c.thirst>100-t.thirstThreshold){const i=(100-c.thirst)/t.thirstThreshold;e*=.6+i*.4}else c.thirst<20&&(e*=1.1);if(c.hunger>100-t.hungerThreshold){const i=(100-c.hunger)/t.hungerThreshold;e*=.7+i*.3}else c.hunger<20&&(e*=1.05);if(c.mood<t.moodThreshold){const i=c.mood/t.moodThreshold;e*=.8+i*.2}else c.mood>80&&(e*=1.05);return Math.max(t.minSpeedMultiplier,Math.min(t.maxSpeedMultiplier,e))}function At(c,t,e=It){const i=se(t,e);return c*i}const st={Water:{type:"Water",quantity:0,hotkey:"W",effects:{thirst:-35,mood:3,bathroom:15}},"Grilled Cheese":{type:"Grilled Cheese",quantity:0,hotkey:"J",effects:{hunger:-25,mood:8,bathroom:12}},"Energy Bar":{type:"Energy Bar",quantity:0,hotkey:"E",effects:{hunger:-15,mood:4,energy:20,bathroom:8}},Trinket:{type:"Trinket",quantity:0,hotkey:"T",effects:{mood:12,energy:8}},Clothing:{type:"Clothing",quantity:0,hotkey:"C",effects:{mood:15,energy:10}},"Fruit Salad":{type:"Fruit Salad",quantity:0,hotkey:"F",effects:{hunger:-20,mood:6,bathroom:10}},Smoothie:{type:"Smoothie",quantity:0,hotkey:"S",effects:{hunger:-18,mood:5,bathroom:12}},Popsicle:{type:"Popsicle",quantity:0,hotkey:"O",effects:{hunger:-8,mood:3,bathroom:5}},Burrito:{type:"Burrito",quantity:0,hotkey:"B",effects:{hunger:-28,mood:9,bathroom:20}},Taco:{type:"Taco",quantity:0,hotkey:"A",effects:{hunger:-22,mood:7,bathroom:18}},"Ice Cream":{type:"Ice Cream",quantity:0,hotkey:"I",effects:{hunger:-12,mood:6,bathroom:8}},"Corn Dog":{type:"Corn Dog",quantity:0,hotkey:"D",effects:{hunger:-25,mood:8,bathroom:15}},"Funnel Cake":{type:"Funnel Cake",quantity:0,hotkey:"U",effects:{hunger:-20,mood:10,bathroom:12}},Nachos:{type:"Nachos",quantity:0,hotkey:"N",effects:{hunger:-24,mood:7,bathroom:16}},"Cotton Candy":{type:"Cotton Candy",quantity:0,hotkey:"Y",effects:{hunger:-5,mood:2,bathroom:3}},"Bacon Pancakes":{type:"Bacon Pancakes",quantity:0,hotkey:"K",effects:{hunger:-32,mood:12,bathroom:22}},"Dusty Donut":{type:"Dusty Donut",quantity:0,hotkey:"H",effects:{hunger:-18,mood:8,bathroom:12}},"Playa Pizza":{type:"Playa Pizza",quantity:0,hotkey:"Z",effects:{hunger:-28,mood:10,bathroom:20}},"Burner Burger":{type:"Burner Burger",quantity:0,hotkey:"X",effects:{hunger:-35,mood:15,bathroom:25}},Pickles:{type:"Pickles",quantity:0,hotkey:"Q",effects:{hunger:-8,mood:4,bathroom:6}},"Gas Can":{type:"Gas Can",quantity:0,effects:{}},"Light Bulb":{type:"Light Bulb",quantity:0,effects:{}},"Light Bulb White":{type:"Light Bulb White",quantity:0,effects:{}},"Light Bulb Red":{type:"Light Bulb Red",quantity:0,effects:{}},"Light Bulb Green":{type:"Light Bulb Green",quantity:0,effects:{}},"Light Bulb Blue":{type:"Light Bulb Blue",quantity:0,effects:{}},"Light Bulb Orange":{type:"Light Bulb Orange",quantity:0,effects:{}},"Light Bulb Purple":{type:"Light Bulb Purple",quantity:0,effects:{}},"Light Bulb Rainbow":{type:"Light Bulb Rainbow",quantity:0,effects:{}},Battery:{type:"Battery",quantity:0,hotkey:"B",effects:{}},Beer:{type:"Beer",quantity:0,hotkey:"M",effects:{mood:15,energy:-5,bathroom:25,thirst:-20}},Vodka:{type:"Vodka",quantity:0,hotkey:"K",effects:{mood:20,energy:-10,bathroom:30,thirst:-15,speed:-10}},Ducting:{type:"Ducting",quantity:0,effects:{}},Bucket:{type:"Bucket",quantity:0,effects:{}},"Zip Tie":{type:"Zip Tie",quantity:0,effects:{}},Glitter:{type:"Glitter",quantity:0,effects:{}},Rope:{type:"Rope",quantity:0,effects:{}},"Plastic Bag":{type:"Plastic Bag",quantity:0,effects:{}},"Furry Hat":{type:"Furry Hat",quantity:0,effects:{mood:5}},Boots:{type:"Boots",quantity:0,effects:{mood:3}},"Cat Head":{type:"Cat Head",quantity:0,effects:{mood:4}},Costume:{type:"Costume",quantity:0,hotkey:"X",effects:{mood:25,energy:10}},Totem:{type:"Totem",quantity:0,effects:{mood:5}},"Swamp Cooler":{type:"Swamp Cooler",quantity:0,effects:{}},Cape:{type:"Cape",quantity:0,hotkey:"P",effects:{speed:25}},POI:{type:"POI",quantity:0,hotkey:"I",effects:{lightBattery:10}},"Fire Spinning":{type:"Fire Spinning",quantity:0,hotkey:"F",effects:{lightBattery:15,mood:10}}};function oe(){return{items:new Map}}function H(c,t,e=1){const i=c.items.get(t)||0;c.items.set(t,i+e)}function rt(c,t,e=1){const i=c.items.get(t)||0;if(i>=e){const s=i-e;return s<=0?c.items.delete(t):c.items.set(t,s),!0}return!1}function Rt(c,t,e=1){return(c.items.get(t)||0)>=e}function St(c,t,e){if(console.log("useItem called:",t,"current stats:",e),!Rt(c,t,1))return console.log("useItem failed: no item in inventory"),{success:!1,newStats:e};const i=st[t];if(!i)return console.log("useItem failed: no item definition"),{success:!1,newStats:e};if(console.log("useItem: item effects:",i.effects),rt(c,t,1),t.includes("Light Bulb")){const o={...e};return o.lightBattery=30,console.log("useItem: light bulb used, battery charged to 30%"),{success:!0,newStats:o}}if(t==="Battery"){const o={...e};return o.lightBattery=100,console.log("useItem: battery used, battery fully charged"),{success:!0,newStats:o}}const s=it(e,i.effects);return console.log("useItem: new stats after applying effects:",s),{success:!0,newStats:s}}function Mt(c){const t=[];return c.items.forEach((e,i)=>{const s=st[i];t.push({type:i,quantity:e,hotkey:s==null?void 0:s.hotkey})}),t.sort((e,i)=>i.quantity-e.quantity)}function Dt(c){return["Totem","Cape","POI","Fire Spinning","Costume"].includes(c)}function Et(c,t){return!Dt(t)||!Rt(c.inventory,t,1)?!1:(c.equippedItem&&xt(c),c.equippedItem=t,!0)}function xt(c){c.equippedItem&&(c.equippedItem=void 0)}class ae{constructor(){M(this,"notifications",[]);M(this,"nextId",0)}addNotification(t,e,i,s){const o=Date.now(),a=500;if(e==="persistent"){this.notifications=this.notifications.filter(l=>l.type!=="persistent"||l.message!==t);const r={id:`notification_${this.nextId++}`,message:t,type:e,value:i,timestamp:o,duration:i===0?1/0:i,worldPosition:{...s},alpha:1,count:1,persistent:!0};this.notifications.push(r);return}const n=this.notifications.find(r=>r.type===e&&r.value===i&&o-r.timestamp<a);if(n){n.count+=1,n.timestamp=o,n.alpha=1;const r=t.replace(/^\+?(\d+)/,"").trim();n.message=`+${n.count} ${r}`}else{const r={id:`notification_${this.nextId++}`,message:t,type:e,value:i,timestamp:o,duration:2e3,worldPosition:{...s},alpha:1,count:1};this.notifications.push(r)}}updateNotifications(t){const e=Date.now();this.notifications=this.notifications.filter(i=>{if(i.persistent)return i.alpha=1,!0;const o=(e-i.timestamp)/i.duration;return o>=1?!1:(i.alpha=1-o,!0)})}clearNotifications(){this.notifications=[]}updatePersistentNotificationPosition(t,e){const i=this.notifications.find(s=>s.persistent&&s.message===t);i&&(i.worldPosition={...e})}removePersistentNotification(t){this.notifications=this.notifications.filter(e=>!(e.persistent&&e.message===t))}getGroupedNotifications(){const t=new Map;return this.notifications.forEach(e=>{const i=`${e.type}_${e.value>0?"positive":"negative"}`;t.has(i)||t.set(i,[]),t.get(i).push(e)}),t}}function ne(c,t){const e=W(),i=c>0?`+${c} Coin`:`${c} Coin`;e.addNotification(i,"coin",c,t)}function L(c,t,e){const i=W(),s=t>0?`+${t} ${c.charAt(0).toUpperCase()+c.slice(1)}`:`${t} ${c.charAt(0).toUpperCase()+c.slice(1)}`;i.addNotification(s,c,t,e)}function J(c,t){W().addNotification(`+1 ${c}`,"item",1,t)}let dt=null;function W(){return dt||(dt=new ae),dt}class re{constructor(){M(this,"actions",[]);this.initializeDefaultActions()}initializeDefaultActions(){this.addAction({id:"rest",name:"Rest",hotkey:"R",description:"Rest to restore energy",cooldown:1e3,lastUsed:0,enabled:!0})}addAction(t){this.actions.push(t)}getActionByHotkey(t){return this.actions.find(e=>e.hotkey.toLowerCase()===t.toLowerCase())}canUseAction(t){const e=this.actions.find(s=>s.id===t);return!e||!e.enabled?!1:Date.now()-e.lastUsed>=e.cooldown}useAction(t){const e=this.actions.find(i=>i.id===t);!e||!this.canUseAction(t)||(e.lastUsed=Date.now())}}let ut=null;function ce(){return ut||(ut=new re),ut}const le={minutesPerRealSecond:60,hoursPerDay:24,minutesPerHour:60},wt={minutesPerRealSecond:1,hoursPerDay:24,minutesPerHour:60},he={minutesPerRealSecond:60,hoursPerDay:24,minutesPerHour:60};function de(){return{day:1,hour:8,minute:0,totalMinutes:0*24*60+8*60}}function ue(c,t,e=1,i=le){const o=t*i.minutesPerRealSecond*e,a=c.totalMinutes+o,n=i.hoursPerDay*i.minutesPerHour,r=Math.floor(a/n)+1,l=a%n,d=Math.floor(l/i.minutesPerHour),h=Math.floor(l%i.minutesPerHour);return{day:r,hour:d,minute:h,totalMinutes:a}}function at(c){return c.hour<6||c.hour>=21}function fe(c,t="#f5deb3"){const e=c.hour,i=t.replace("#",""),s=parseInt(i.substr(0,2),16),o=parseInt(i.substr(2,2),16),a=parseInt(i.substr(4,2),16);let n=1;e>=6&&e<8?n=.3+(e-6)*.35:e>=8&&e<18?n=1:e>=18&&e<20?n=1-(e-18)*.35:n=.3;const r=Math.floor(s*n),l=Math.floor(o*n),d=Math.floor(a*n);return`rgb(${r}, ${l}, ${d})`}const xe={totem:{id:"totem",result:"Totem",ingredients:[{item:"Light Bulb",quantity:2},{item:"Glitter",quantity:1},{item:"Rope",quantity:1}],description:"A spiritual totem that raises mood and attracts wombats"},"swamp-cooler":{id:"swamp-cooler",result:"Swamp Cooler",ingredients:[{item:"Water",quantity:1},{item:"Battery",quantity:1},{item:"Bucket",quantity:1},{item:"Ducting",quantity:1}],description:"A cooling device that creates an energy and mood aura when placed"},cape:{id:"cape",result:"Cape",ingredients:[{item:"Clothing",quantity:1},{item:"Zip Tie",quantity:1},{item:"Glitter",quantity:2}],description:"A magical cape that increases your movement speed"},costume:{id:"costume",result:"Costume",ingredients:[{item:"Furry Hat",quantity:1},{item:"Boots",quantity:1},{item:"Cat Head",quantity:1}],description:"A complete costume that greatly boosts your mood and energy"}};function ge(c,t){return t.ingredients.every(e=>(c.items.get(e.item)||0)>=e.quantity)}function Q(c,t){const e=[];for(const[i,s]of Object.entries(xe))ge(c,s)&&(s.ingredients.forEach(a=>{rt(c,a.item,a.quantity)}),H(c,s.result,1),W().addNotification(`🔨 Crafted ${s.result}! ${s.description}`,"craft",5e3,t),e.push(s.result),console.log(`🔨 Auto-crafted ${s.result} using recipe ${i}`));return e}const me=[{id:"virgin-burner",name:"Virgin Burner",description:"Fresh to the playa, wide-eyed and ready for adventure",emoji:"🌟",requirements:{time:{maxHours:2},stats:{karma:{min:0,max:50}}},quote:`"I have no idea what I'm doing but this is amazing!"`,color:"#FFD700"},{id:"moop-warrior",name:"Moop Warrior",description:"Dedicated to keeping the playa clean, one piece of trash at a time",emoji:"🗑️",requirements:{stats:{karma:{min:100}},achievements:["moop-collector"]},quote:'"Leave no trace... except for these amazing memories!"',color:"#4CAF50"},{id:"psychedelic-explorer",name:"Psychedelic Explorer",description:"Journeyed deep into altered states and emerged enlightened",emoji:"🌈",requirements:{drugs:[{type:"acid",count:2},{type:"shrooms",count:1}],stats:{mood:{min:80}}},quote:'"The colors... the colors are alive!"',color:"#9C27B0"},{id:"party-animal",name:"Party Animal",description:"The life of every party, keeping the energy flowing all night long",emoji:"🎉",requirements:{stats:{energy:{min:90}},items:[{type:"Beer",quantity:5},{type:"Vodka",quantity:2}]},quote:'"What happens at Burning Man stays at Burning Man... mostly!"',color:"#FF5722"},{id:"art-car-nomad",name:"Art Car Nomad",description:"Hitched rides on every moving sculpture, seeing the playa from every angle",emoji:"🚗",requirements:{achievements:["art-car-rider"],stats:{karma:{min:75}}},quote:`"The journey is the destination, especially when you're on fire!"`,color:"#FF9800"},{id:"light-walker",name:"Light Walker",description:"Illuminated the darkness, bringing beauty to the night",emoji:"💡",requirements:{items:[{type:"Light Bulb",quantity:10}],stats:{lightBattery:{min:80}}},quote:'"In darkness, we find our light... and share it with the world."',color:"#FFEB3B"},{id:"craft-master",name:"Craft Master",description:"Mastered the art of creation, building wonders from playa dust",emoji:"🔨",requirements:{items:[{type:"Totem",quantity:1},{type:"Cape",quantity:1},{type:"Costume",quantity:1}]},quote:'"From dust we came, to dust we return... but in between, we build miracles!"',color:"#795548"},{id:"spiritual-seeker",name:"Spiritual Seeker",description:"Found enlightenment through meditation, connection, and inner peace",emoji:"🧘",requirements:{stats:{mood:{min:95},karma:{min:150}},time:{minHours:6}},quote:'"The temple burns, but the spirit remains eternal."',color:"#607D8B"},{id:"survivalist",name:"Desert Survivalist",description:"Thrived in the harsh conditions, mastering the art of playa living",emoji:"🏜️",requirements:{stats:{energy:{min:70},mood:{min:70},karma:{min:50}},time:{minHours:8}},quote:'"The playa provides... but only to those who respect her power."',color:"#8D6E63"},{id:"legendary-burner",name:"Legendary Burner",description:"Achieved true mastery of the Burning Man experience",emoji:"🔥",requirements:{stats:{mood:{min:90},energy:{min:90},karma:{min:200},coins:{min:100}},time:{minHours:10},achievements:["moop-collector","art-car-rider","not-a-darkwad"]},quote:'"I am the playa, and the playa is me. We are one."',color:"#E91E63"}],pe=[{id:"first-moop",name:"First Cleanup",description:"Picked up your first piece of moop",emoji:"🗑️",unlocked:!1},{id:"moop-collector",name:"Moop Collector",description:"Collected 50 pieces of moop",emoji:"🧹",unlocked:!1},{id:"art-car-rider",name:"Art Car Rider",description:"Rode an art car for the first time",emoji:"🚗",unlocked:!1},{id:"not-a-darkwad",name:"Not a Darkwad",description:"Found your first light bulb",emoji:"💡",unlocked:!1},{id:"psychedelic-pioneer",name:"Psychedelic Pioneer",description:"Experienced multiple altered states",emoji:"🌈",unlocked:!1},{id:"craft-artisan",name:"Craft Artisan",description:"Created your first crafted item",emoji:"🔨",unlocked:!1},{id:"party-survivor",name:"Party Survivor",description:"Consumed various party substances",emoji:"🍻",unlocked:!1},{id:"desert-wanderer",name:"Desert Wanderer",description:"Spent significant time exploring the playa",emoji:"🏜️",unlocked:!1},{id:"spiritual-journey",name:"Spiritual Journey",description:"Achieved high karma through good deeds",emoji:"✨",unlocked:!1},{id:"burning-man-master",name:"Burning Man Master",description:"Completed the ultimate Burning Man experience",emoji:"👑",unlocked:!1}];function kt(c,t,e,i,s){const o=[...me].sort((a,n)=>{const r=Object.keys(a.requirements).length;return Object.keys(n.requirements).length-r});for(const a of o)if(ye(a,c,t,e,i,s))return a;return null}function ye(c,t,e,i,s,o){const a=c.requirements;if(a.stats)for(const[n,r]of Object.entries(a.stats)){const l=t[n];if(r.min!==void 0&&l<r.min||r.max!==void 0&&l>r.max)return!1}if(a.achievements){for(const n of a.achievements)if(!e.has(n))return!1}if(a.items){for(const n of a.items)if((i.items.get(n.type)||0)<n.quantity)return!1}if(a.drugs){for(const n of a.drugs)if(s<n.count)return!1}return!(a.time&&(a.time.minHours!==void 0&&o<a.time.minHours||a.time.maxHours!==void 0&&o>a.time.maxHours))}function be(c,t,e,i,s,o,a){const n=[...c];return n.forEach(r=>{if(r.unlocked)return;let l=!1;switch(r.id){case"first-moop":l=a>=1;break;case"moop-collector":l=a>=50;break;case"art-car-rider":l=e.has("art-car-rider");break;case"not-a-darkwad":l=e.has("not-a-darkwad");break;case"psychedelic-pioneer":l=s>=5;break;case"craft-artisan":l=(i.items.get("Totem")||0)>0||(i.items.get("Cape")||0)>0||(i.items.get("Costume")||0)>0;break;case"party-survivor":l=(i.items.get("Beer")||0)>0||(i.items.get("Vodka")||0)>0;break;case"desert-wanderer":l=o>=4;break;case"spiritual-journey":l=t.karma>=100;break;case"burning-man-master":l=t.karma>=200&&o>=8&&e.size>=3;break}l&&!r.unlocked&&(r.unlocked=!0,r.unlockedAt=Date.now(),console.log(`🏆 Award unlocked: ${r.name} - ${r.description}`))}),n}class Se{constructor(){M(this,"worlds",new Map);this.initializeDefaultWorlds()}registerWorld(t){this.worlds.set(t.id,t)}getWorld(t){return this.worlds.get(t)}getAllWorldIds(){return Array.from(this.worlds.keys())}hasWorld(t){return this.worlds.has(t)}initializeDefaultWorlds(){this.registerWorld({id:"camp",name:"Camp",width:1600,height:1200,backgroundColor:"#f5deb3",timeScale:1,spawnPosition:T(800,600),boundaries:[{side:"left",exitWorldId:"playa",exitPosition:T(1200,1500),triggerDistance:50,useRelativePositioning:!0},{side:"right",exitWorldId:"playa",exitPosition:T(1200,1500),triggerDistance:50,useRelativePositioning:!0},{side:"top",exitWorldId:"playa",exitPosition:T(1200,1500),triggerDistance:50,useRelativePositioning:!0},{side:"bottom",exitWorldId:"playa",exitPosition:T(1200,1500),triggerDistance:50,useRelativePositioning:!0}],description:"Your home base at Burning Man"}),this.registerWorld({id:"playa",name:"The Playa",width:4e3,height:3e3,backgroundColor:"#f5deb3",timeScale:1,spawnPosition:T(2e3,1500),boundaries:[{side:"right",exitWorldId:"camp",exitPosition:T(100,600),triggerDistance:50},{side:"left",exitWorldId:"danceStage",exitPosition:T(1400,400),triggerDistance:50},{side:"area",exitWorldId:"camp",exitPosition:T(800,600),areaPosition:T(1200,1500),areaWidth:100,areaHeight:75,triggerDistance:0,useRelativePositioning:!0}],description:"The vast open playa of Burning Man"}),this.registerWorld({id:"danceStage",name:"Dance Stage",width:1200,height:800,backgroundColor:"#1a1a2e",timeScale:1,spawnPosition:T(600,400),boundaries:[{side:"right",exitWorldId:"playa",exitPosition:T(100,400),triggerDistance:50}],description:"The main dance stage with pulsing lights"})}}const Me=new Se;function ft(c){return Me.getWorld(c)}class we{constructor(t){M(this,"worldStates",new Map);M(this,"storage");M(this,"storagePrefix","world_state_");this.storage=t}getWorldState(t){return this.worldStates.has(t)||this.worldStates.set(t,this.createEmptyWorldState(t)),this.worldStates.get(t)}updateWorldState(t,e){const s={...this.getWorldState(t),...e};this.worldStates.set(t,s)}addWorldItem(t,e){const i=this.getWorldState(t);i.items.push(e),this.updateWorldState(t,{items:i.items})}removeWorldItem(t,e){const i=this.getWorldState(t);i.items=i.items.filter(s=>s.id!==e),this.updateWorldState(t,{items:i.items})}updateWorldItem(t,e,i){const s=this.getWorldState(t),o=s.items.findIndex(a=>a.id===e);o!==-1&&(s.items[o]={...s.items[o],...i},this.updateWorldState(t,{items:s.items}))}addWorldNPC(t,e){const i=this.getWorldState(t);i.npcs.push(e),this.updateWorldState(t,{npcs:i.npcs})}updateWorldNPC(t,e,i){const s=this.getWorldState(t),o=s.npcs.findIndex(a=>a.id===e);o!==-1&&(s.npcs[o]={...s.npcs[o],...i},this.updateWorldState(t,{npcs:s.npcs}))}addWorldEvent(t,e){const i=this.getWorldState(t);i.events.push(e),this.updateWorldState(t,{events:i.events})}triggerWorldEvent(t,e){const i=this.getWorldState(t),s=i.events.findIndex(o=>o.id===e);s!==-1&&(i.events[s].triggered=!0,this.updateWorldState(t,{events:i.events}))}markWorldVisited(t){this.updateWorldState(t,{lastVisited:Date.now()})}markWorldLoaded(t,e){this.updateWorldState(t,{isLoaded:e})}async saveAllWorldStates(){const t=Array.from(this.worldStates.entries()).map(([e,i])=>{const s=`${this.storagePrefix}${e}`;return this.storage.save(s,JSON.stringify(i))});await Promise.all(t)}async loadAllWorldStates(){const e=["camp","playa","danceStage"].map(async i=>{const s=`${this.storagePrefix}${i}`;try{const o=await this.storage.load(s);if(o&&typeof o=="string"){const a=JSON.parse(o);this.worldStates.set(i,a)}}catch(o){console.warn(`Failed to load world state for ${i}:`,o),this.worldStates.set(i,this.createEmptyWorldState(i))}});await Promise.all(e)}createEmptyWorldState(t){return{worldId:t,items:[],npcs:[],events:[],lastVisited:Date.now(),isLoaded:!1}}getLoadedWorldIds(){return Array.from(this.worldStates.entries()).filter(([t,e])=>e.isLoaded).map(([t,e])=>t)}clearAllWorldStates(){this.worldStates.clear()}}class ke{constructor(t,e){M(this,"currentWorldId");M(this,"loadedWorlds",new Set);M(this,"worldStateManager");M(this,"transitionInProgress",!1);M(this,"lastExitDirection");M(this,"originalExitDirection");this.currentWorldId=t,this.worldStateManager=e,this.loadedWorlds.add(t)}getCurrentWorld(){return ft(this.currentWorldId)}getCurrentWorldId(){return this.currentWorldId}getState(){return{currentWorldId:this.currentWorldId,loadedWorlds:new Set(this.loadedWorlds),worldStates:new Map,transitionInProgress:this.transitionInProgress}}checkWorldTransition(t,e){if(this.transitionInProgress)return null;const i=this.getCurrentWorld();if(!i)return null;for(const s of i.boundaries){const o=this.getDistanceToBoundary(t,s,i),a=s.triggerDistance||e;if(o<=a){this.lastExitDirection=s.side,this.currentWorldId==="camp"&&(this.originalExitDirection=this.lastExitDirection);const n=this.calculateExitPosition(s,i);return this.initiateWorldTransition(s.exitWorldId,n)}}return null}getDistanceToBoundary(t,e,i){switch(e.side){case"left":return t.x;case"right":return i.width-t.x;case"top":return t.y;case"bottom":return i.height-t.y;case"area":if(e.areaPosition&&e.areaWidth&&e.areaHeight){const s=e.areaPosition.x-e.areaWidth/2,o=e.areaPosition.x+e.areaWidth/2,a=e.areaPosition.y-e.areaHeight/2,n=e.areaPosition.y+e.areaHeight/2;if(t.x>=s&&t.x<=o&&t.y>=a&&t.y<=n)return 0}return 1/0;default:return 1/0}}calculateExitPosition(t,e){if(t.useRelativePositioning){if(t.exitWorldId==="camp"&&this.originalExitDirection)return this.calculateRelativeExitPosition(t,e,this.originalExitDirection);if(this.lastExitDirection)return this.calculateRelativeExitPosition(t,e,this.lastExitDirection)}return t.exitPosition}calculateRelativeExitPosition(t,e,i){const s=t.exitPosition,o=t.exitWorldId==="playa"?150:400;switch(i){case"left":return{x:s.x-o,y:s.y};case"right":return{x:s.x+o,y:s.y};case"top":return{x:s.x,y:s.y-o};case"bottom":return{x:s.x,y:s.y+o};default:return s}}initiateWorldTransition(t,e){this.transitionInProgress=!0,this.worldStateManager.markWorldVisited(this.currentWorldId),this.loadedWorlds.has(t)||this.loadedWorlds.add(t),this.currentWorldId=t,t==="camp"&&(this.originalExitDirection=void 0),this.worldStateManager.markWorldVisited(t),this.transitionInProgress=!1;const i=ft(t),s=i?`Entering ${i.name}`:void 0;return{success:!0,newWorldId:t,newPosition:e,message:s}}getWorldStateManager(){return this.worldStateManager}isWorldLoaded(t){return this.loadedWorlds.has(t)}getLoadedWorldIds(){return Array.from(this.loadedWorlds)}forceTransitionToWorld(t,e){return ft(t)?this.initiateWorldTransition(t,e):{success:!1,newWorldId:this.currentWorldId,newPosition:e,message:`World ${t} not found`}}getCurrentTimeScale(){const t=this.getCurrentWorld();return(t==null?void 0:t.timeScale)||1}getCurrentWorldBackgroundColor(){const t=this.getCurrentWorld();return(t==null?void 0:t.backgroundColor)||"#34495e"}getCurrentWorldDimensions(){const t=this.getCurrentWorld();return{width:(t==null?void 0:t.width)||1600,height:(t==null?void 0:t.height)||1200}}}function Z(c,t){switch(c){case"playa":return ve(t);case"camp":return Be();case"danceStage":return Pe();default:return[]}}function Ce(c){return c<=1?.2:c<=2?.4:c<=3?.6:c<=4?.8:c<=5||c<=6||c<=7?1:c===8?.67:c===9?.33:.1}function Ct(c,t){return t==="man"?c<=1?{progress:0,isBurning:!1,isBurned:!1}:c===2?{progress:.1,isBurning:!1,isBurned:!1}:c===3?{progress:.3,isBurning:!1,isBurned:!1}:c===4?{progress:.5,isBurning:!1,isBurned:!1}:c===5?{progress:.7,isBurning:!1,isBurned:!1}:c===6?{progress:.9,isBurning:!1,isBurned:!1}:c===7?{progress:1,isBurning:!1,isBurned:!1}:c===8?{progress:1,isBurning:!0,isBurned:!1,handsUp:!0}:c>=9?{progress:0,isBurning:!1,isBurned:!0}:{progress:0,isBurning:!1,isBurned:!1}:c<=1?{progress:0,isBurning:!1,isBurned:!1}:c===2?{progress:.15,isBurning:!1,isBurned:!1}:c===3?{progress:.35,isBurning:!1,isBurned:!1}:c===4?{progress:.55,isBurning:!1,isBurned:!1}:c===5?{progress:.75,isBurning:!1,isBurned:!1}:c===6?{progress:.9,isBurning:!1,isBurned:!1}:c===7?{progress:1,isBurning:!1,isBurned:!1}:c===8?{progress:1,isBurning:!1,isBurned:!1}:c===9?{progress:1,isBurning:!0,isBurned:!1}:c>=10?{progress:0,isBurning:!1,isBurned:!0}:{progress:0,isBurning:!1,isBurned:!1}}function ve(c){const t=[],e=(c==null?void 0:c.day)||1;c==null||c.hour;const i=Ct(e,"man");let s=!1,o=0,a=0,n=!1;if(e===7&&c&&c.hour>=12)s=!1,o=0,a=0,n=!1;else if(e===8&&c){if(c.hour<8)s=!1,o=0,a=0,n=!1;else if(c.hour<12)s=!1,o=0,a=0,n=!0;else if(c.hour<15){s=!0;const h=c.hour-12;o=Math.max(0,Math.min(.3,h/3*.3)),a=0,n=!0}else if(c.hour<17){s=!0;const h=c.hour-15;o=Math.max(.3,Math.min(.6,.3+h/2*.3)),a=0,n=!0}else if(c.hour<19){s=!0;const h=c.hour-17;o=Math.max(.6,Math.min(.85,.6+h/2*.25)),a=0,n=!0}else if(c.hour<20){s=!0;const h=c.hour-19;o=Math.max(.85,Math.min(1,.85+h/1*.15)),a=0,n=!0}else s=!0,o=1,a=0,n=!0;c.hour<8||c.hour<12||c.hour<15||c.hour<17||c.hour<19||c.hour<20}else if(e===9&&c){s=!0,o=1;const h=c.hour;a=Math.max(0,Math.min(1,h/24)),n=!1}t.push({id:"the-man",type:"man",position:T(2e3,1500),size:180,color:s?"#ff0000":i.isBurned?"#444444":"#ff6b35",description:a>0?"The Man - now just ashes":o>=1?"The Man - now just a bonfire":e===7&&c&&c.hour>=12?"The Man - hands down, final day":e===8&&c&&c.hour<8?"The Man - hands raised, ready to burn!":e===8&&c&&c.hour>=8&&c.hour<12?"The Man - fireworks celebration!":e===8&&c&&c.hour>=12&&c.hour<15?"The Man - small fire starting!":e===8&&c&&c.hour>=15&&c.hour<17?"The Man - arms and head falling!":e===8&&c&&c.hour>=17&&c.hour<19?"The Man - legs falling, torso collapsing!":e===8&&c&&c.hour>=19&&c.hour<20?"The Man - final collapse!":s?"The Man is burning!":i.isBurned?"The Man has burned":"The Man - the center of Burning Man",buildingProgress:i.progress,isBurning:s,isBurned:i.isBurned,handsUp:i.handsUp,destructionProgress:o,ashesProgress:a,isBonfire:o>=1,fireworksActive:n,pieces:{head:o>.1,leftArm:o>.3,rightArm:o>.5,leftLeg:o>.7,rightLeg:o>.9,torso:o>1}});const r=Ct(e,"temple"),l=e===9;let d=0;if(l&&c){const h=c.hour-6;d=.3+Math.max(0,Math.min(1,h/12))*.7,c.hour>=18&&c.hour-18}return t.push({id:"the-temple",type:"temple",position:T(2e3,600),size:120,color:l?"#ff0000":r.isBurned?"#444444":"#8b4513",description:d>=1?"The Temple - now just a bonfire":l?"The Temple is burning!":r.isBurned?"The Temple has burned":"The Temple - a place of reflection and remembrance",buildingProgress:r.progress,isBurning:l,isBurned:r.isBurned,destructionProgress:d,isBonfire:d>=1,pieces:{roof:d>.2,leftWall:d>.4,rightWall:d>.6,backWall:d>.8,pillars:d>1}}),t.push({id:"trash-fence",type:"trashFence",position:T(2e3,1500),size:1400,color:"#2c3e50",description:"Trash fence - the perimeter of the event"}),t.push({id:"playa-camp",type:"camp",position:T(1200,1500),size:100,color:"#27ae60",description:"Your camp on the playa - walk here to return to main camp"}),t.push({id:"hell-station",type:"camp",position:T(1e3,600),size:80,color:"#ff6b35",description:"Hell Station - buy gas for art cars (40 coins, 20 karma)"}),t.push({id:"center-camp",type:"camp",position:T(2e3,1800),size:100,color:"#3498db",description:"Center Camp - buy ice or tea (10 coins each, 5 karma)"}),t.push({id:"art-car-1",type:"artCar",position:T(1600,1200),size:60,color:"#f06",description:"The Disco Bus - needs fuel to keep the party going"}),t.push({id:"art-car-2",type:"artCar",position:T(2400,2e3),size:60,color:"#9b59b6",description:"The Fire Dragon - cruising the playa with flames"}),t.push({id:"center-camp-rest",type:"restArea",position:T(2e3,1800),size:120,color:"#3498db",description:"Center Camp - rest here for 2x energy recovery",restAreaType:"center"}),t.push({id:"deep-playa-teepee",type:"restArea",position:T(2e3,400),size:100,color:"#8b4513",description:"Deep Playa Teepee - rest here for 2x energy recovery",restAreaType:"teepee"}),t.push({id:"east-rest-area",type:"restArea",position:T(3200,1500),size:100,color:"#27ae60",description:"East Rest Area - rest here for 2x energy recovery",restAreaType:"east"}),t.push({id:"west-rest-area",type:"restArea",position:T(800,1500),size:100,color:"#e74c3c",description:"West Rest Area - rest here for 2x energy recovery",restAreaType:"west"}),t}function Be(){return[]}function Pe(){return[{id:"main-stage",type:"artCar",position:T(600,400),size:50,color:"#9b59b6",description:"Main dance stage with pulsing lights"}]}function nt(c,t,e=100){const i=Math.ceil(c/e),s=Math.ceil(t/e),o=[];for(let a=0;a<i;a++){o[a]=[];for(let n=0;n<s;n++)o[a][n]={entities:[]}}return{cellSize:e,worldWidth:c,worldHeight:t,gridWidth:i,gridHeight:s,cells:o}}function Te(c,t){return{x:Math.floor(c.x/t),y:Math.floor(c.y/t)}}function We(c,t,e,i){return c>=0&&c<e&&t>=0&&t<i}function q(c,t){const e=Te(t.position,c.cellSize);We(e.x,e.y,c.gridWidth,c.gridHeight)&&c.cells[e.x][e.y].entities.push(t)}function Ie(c,t){for(let e=0;e<c.gridWidth;e++)for(let i=0;i<c.gridHeight;i++){const s=c.cells[e][i],o=s.entities.findIndex(a=>a.id===t);if(o!==-1){s.entities.splice(o,1);return}}}function $t(c,t,e){const i=[];let s=0;const o=Math.max(0,Math.floor((t.x-e)/c.cellSize)),a=Math.min(c.gridWidth-1,Math.floor((t.x+e)/c.cellSize)),n=Math.max(0,Math.floor((t.y-e)/c.cellSize)),r=Math.min(c.gridHeight-1,Math.floor((t.y+e)/c.cellSize));for(let l=o;l<=a;l++)for(let d=n;d<=r;d++){s++;const h=c.cells[l][d];for(const u of h.entities){const f=u.position.x-t.x,x=u.position.y-t.y;Math.sqrt(f*f+x*x)<=e&&i.push(u)}}return{entities:i,cellsQueried:s}}function Ae(c,t,e,i,s){const o=[];let a=0;const n=Math.max(0,Math.floor(t/c.cellSize)),r=Math.min(c.gridWidth-1,Math.floor(i/c.cellSize)),l=Math.max(0,Math.floor(e/c.cellSize)),d=Math.min(c.gridHeight-1,Math.floor(s/c.cellSize));for(let h=n;h<=r;h++)for(let u=l;u<=d;u++){a++;const f=c.cells[h][u];for(const x of f.entities)x.position.x>=t&&x.position.x<=i&&x.position.y>=e&&x.position.y<=s&&o.push(x)}return{entities:o,cellsQueried:a}}function z(c,t,e){return`${e}_${t}_${c}`}function U(c,t,e){const i=c.x-t.x,s=c.y-t.y;return Math.sqrt(i*i+s*s)<e}function _(c,t,e){return $t(t,c,e).entities.length>0}function tt(c,t=200){const e={x:2e3,y:1500};if(Math.sqrt((c.x-e.x)**2+(c.y-e.y)**2)<t)return!0;const s={x:2e3,y:600};return Math.sqrt((c.x-s.x)**2+(c.y-s.y)**2)<t}function K(c,t,e){if(t>=4e3&&e>=3e3){const i=t/2,s=e/2,o=1350,a=c.random()*Math.PI*2,n=Math.sqrt(c.random())*o;return{x:i+Math.cos(a)*n,y:s+Math.sin(a)*n}}return{x:c.randomRange(50,t-50),y:c.randomRange(50,e-50)}}function vt(c,t){return{coin:{value:1,radius:2.4,color:"#f1c40f",borderColor:"#f39c12"},water:{value:1,radius:3,color:"#3498db",borderColor:"#2980b9"},food:{value:1,radius:4,color:"#e67e22",borderColor:"#d35400",subtypes:["Grilled Cheese","Energy Bar","Fruit Salad","Smoothie","Popsicle","Burrito","Taco","Ice Cream","Corn Dog","Bacon Pancakes","Nachos","Cotton Candy","Dusty Donut","Playa Pizza","Burner Burger","Pickles"]},drug:{value:1,radius:3.5,color:"#9b59b6",borderColor:"#8e44ad",subtypes:["molly","shrooms","acid","dmt","salvia","whipits","energy-drink","mystery-pill","mystery-snowball","cigarette","joint","vodka","mda","2c-i","caffeine","alcohol","mdma","weed","cocaine","ketamine","cannabis"]},bike:{value:1,radius:6,color:"#2c3e50",borderColor:"#34495e"}}[c]}function Re(c,t,e,i,s,o=100,a=50,n=30,r=20,l=10,d=16,h=10){const u=[],f=(o+a+n+r+l+d+h)*10;let x=0;for(let m=0;m<o&&x<f;x++){const g=K(c,t,e);if(!U(g,i,100)&&!_(g,s,40)&&!tt(g,200)){const y={id:z(m,c.getSeed(),"coin"),position:g,type:"coin",value:1,collected:!1};u.push(y),q(s,{id:y.id,position:y.position,radius:2.4}),m++}}for(let m=0;m<a&&x<f;x++){const g=K(c,t,e);if(!U(g,i,100)&&!_(g,s,40)&&!tt(g,200)){const y={id:z(m,c.getSeed(),"water"),position:g,type:"water",value:1,collected:!1,subtype:"water-bottle"};u.push(y),q(s,{id:y.id,position:y.position,radius:3}),m++}}for(let m=0;m<n&&x<f;x++){const g=K(c,t,e);if(!U(g,i,100)&&!_(g,s,40)&&!tt(g,200)){const y=vt("food"),S=y.subtypes[Math.floor(c.random()*y.subtypes.length)],b={id:z(m,c.getSeed(),"food"),position:g,type:"food",value:1,collected:!1,subtype:S};u.push(b),q(s,{id:b.id,position:b.position,radius:4}),m++}}for(let m=0;m<r&&x<f;x++){const g=K(c,t,e);if(!U(g,i,100)&&!_(g,s,40)&&!tt(g,200)){const y=vt("drug"),S=y.subtypes[Math.floor(c.random()*y.subtypes.length)],b={id:z(m,c.getSeed(),"drug"),position:g,type:"drug",value:1,collected:!1,subtype:S};u.push(b),q(s,{id:b.id,position:b.position,radius:3.5}),m++}}for(let m=0;m<l&&x<f;x++){const g=K(c,t,e);if(!U(g,i,100)&&!_(g,s,60)&&!tt(g,200)){const y={id:z(m,c.getSeed(),"bike"),position:g,type:"bike",value:1,collected:!1};u.push(y),q(s,{id:y.id,position:y.position,radius:6}),m++}}const p=[{type:"light-bulb-white",itemType:"Light Bulb White",weight:70},{type:"light-bulb-red",itemType:"Light Bulb Red",weight:20},{type:"light-bulb-green",itemType:"Light Bulb Green",weight:20},{type:"light-bulb-blue",itemType:"Light Bulb Blue",weight:20},{type:"light-bulb-orange",itemType:"Light Bulb Orange",weight:20},{type:"light-bulb-purple",itemType:"Light Bulb Purple",weight:20},{type:"light-bulb-rainbow",itemType:"Light Bulb Rainbow",weight:10}];for(let m=0;m<d&&x<f;x++){const g=K(c,t,e);if(!U(g,i,100)&&!_(g,s,50)){const y=p.reduce((v,k)=>v+k.weight,0);let S=c.randomRange(0,y),b=p[0];for(const v of p)if(S-=v.weight,S<=0){b=v;break}const w={id:z(m,c.getSeed(),b.type),position:g,type:b.type,value:1,collected:!1,data:{itemType:b.itemType}};u.push(w),q(s,{id:w.id,position:w.position,radius:10}),m++}}for(let m=0;m<h&&x<f;x++){const g=K(c,t,e);if(!U(g,i,100)&&!_(g,s,50)){const y={id:z(m,c.getSeed(),"battery"),position:g,type:"battery",value:1,collected:!1};u.push(y),q(s,{id:y.id,position:y.position,radius:10}),m++}}return u}const ct={ziptie:{emoji:"🔗",radius:8,karmaReward:2,spawnWeight:15},"water-bottle":{emoji:"🍼",radius:12,karmaReward:3,spawnWeight:20},cup:{emoji:"🥤",radius:10,karmaReward:2,spawnWeight:18},"flashing-light":{emoji:"💡",radius:14,karmaReward:5,spawnWeight:8},"furry-hat":{emoji:"🎩",radius:16,karmaReward:8,spawnWeight:5},"cigarette-butt":{emoji:"🚬",radius:6,karmaReward:1,spawnWeight:25},"light-bulb":{emoji:"💡",radius:8,karmaReward:-5,spawnWeight:0},ducting:{emoji:"🔧",radius:10,karmaReward:3,spawnWeight:12},bucket:{emoji:"🪣",radius:14,karmaReward:4,spawnWeight:8},glitter:{emoji:"✨",radius:6,karmaReward:2,spawnWeight:15},rope:{emoji:"🪢",radius:8,karmaReward:3,spawnWeight:10},"plastic-bag":{emoji:"🛍️",radius:6,karmaReward:1,spawnWeight:20},boots:{emoji:"👢",radius:12,karmaReward:4,spawnWeight:8},"cat-head":{emoji:"🐱",radius:14,karmaReward:6,spawnWeight:6},clothing:{emoji:"👕",radius:12,karmaReward:5,spawnWeight:8},cape:{emoji:"🦸",radius:16,karmaReward:8,spawnWeight:4}};function De(){return`moop_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function Ee(c){return{ziptie:"Zip Tie","water-bottle":"Water Bottle",cup:"Cup","flashing-light":"Flashing Light","furry-hat":"Furry Hat","cigarette-butt":"Cigarette Butt","light-bulb":"Light Bulb",ducting:"Ducting",bucket:"Bucket",glitter:"Glitter",rope:"Rope","plastic-bag":"Plastic Bag",boots:"Boots","cat-head":"Cat Head",clothing:"Clothing",cape:"Cape"}[c]}function gt(c){const t={Water:"water-bottle","Water Bottle":"water-bottle",Cup:"cup","Light Bulb":"light-bulb","Light Bulb White":"light-bulb","Light Bulb Red":"light-bulb","Light Bulb Green":"light-bulb","Light Bulb Blue":"light-bulb","Light Bulb Orange":"light-bulb","Light Bulb Purple":"light-bulb","Light Bulb Rainbow":"light-bulb","Flashing Light":"flashing-light","Furry Hat":"furry-hat","Cigarette Butt":"cigarette-butt",Ducting:"ducting",Bucket:"bucket",Glitter:"glitter",Rope:"rope","Plastic Bag":"plastic-bag",Boots:"boots","Cat Head":"cat-head",Clothing:"clothing",Cape:"cape","Zip Tie":"ziptie"};if(t[c])return ct[t[c]].emoji;const e=c.toLowerCase();return e.includes("pizza")?"🍕":e.includes("burger")?"🍔":e.includes("cheese")?"🧀":e.includes("salad")||e.includes("fruit")?"🥗":e.includes("smoothie")?"🥤":e.includes("popsicle")?"🍭":e.includes("burrito")?"🌯":e.includes("taco")?"🌮":e.includes("ice cream")?"🍦":e.includes("corn dog")?"🌭":e.includes("funnel cake")?"🧇":e.includes("nachos")?"🧀":e.includes("cotton candy")?"🍬":e.includes("bacon")?"🥓":e.includes("donut")?"🍩":e.includes("pickles")?"🥒":e.includes("water")?"💧":e.includes("beer")?"🍺":e.includes("vodka")?"🍸":e.includes("energy bar")?"🍫":e.includes("energy")?"⚡":e.includes("totem")?"🪩":e.includes("trinket")?"✨":e.includes("battery")?"🔋":e.includes("gas")?"⛽":e.includes("swamp cooler")?"❄️":e.includes("light bulb red")?"🔴":e.includes("light bulb green")?"🟢":e.includes("light bulb blue")?"🔵":e.includes("light bulb orange")?"🟠":e.includes("light bulb purple")?"🟣":e.includes("light bulb rainbow")?"🌈":e.includes("light bulb white")?"⚪":e.includes("light bulb")?"💡":e.includes("joint")||e.includes("weed")?"🍃":e.includes("molly")||e.includes("mdma")?"💊":e.includes("acid")||e.includes("lsd")?"🔄":e.includes("shrooms")||e.includes("mushroom")?"🍄":e.includes("dmt")?"🌌":e.includes("salvia")?"🌿":e.includes("ketamine")?"💉":e.includes("cocaine")?"❄️":e.includes("cannabis")?"🌿":e.includes("cigarette")?"🚬":e.includes("mystery")?"❓":e.includes("whipit")?"🎈":e.includes("energy drink")?"⚡":"📦"}function $e(c,t,e){return ot(c,t)<e}function Le(c,t,e){return t.some(i=>ot(c,i.position)<e)}function Fe(c,t){const e=c.random()*(t.maxX-t.minX)+t.minX,i=c.random()*(t.maxY-t.minY)+t.minY;return T(e,i)}function Ge(c){const t=Object.keys(ct),e=t.map(o=>ct[o].spawnWeight),i=e.reduce((o,a)=>o+a,0);let s=c.random()*i;for(let o=0;o<t.length;o++)if(s-=e[o],s<=0)return t[o];return t[t.length-1]}function He(c,t,e,i){const s=[];for(let o=0;o<c.count;o++){let a=0;const n=50;let r;do r=Fe(i,c.worldBounds),a++;while(a<n&&($e(r,t,c.minDistanceFromPlayer)||Le(r,[...e,...s],c.minDistanceFromOtherMoop)));if(a<n){const l=Ge(i),d=ct[l],h={id:De(),type:l,position:r,radius:d.radius,karmaReward:d.karmaReward,collected:!1};s.push(h)}}return s}function Ne(c,t,e,i){const s=c.x-e.x,o=c.y-e.y;return Math.sqrt(s*s+o*o)<t+i}function Oe(c,t){if(c.collected)return{success:!1,collectedMoop:null,karmaGained:0,newStats:t};const e=c.karmaReward,i=it(t,{karma:e});return{success:!0,collectedMoop:{...c,collected:!0},karmaGained:e,newStats:i}}function qe(c,t,e){return e.filter(i=>!i.collected&&Ne(c,t,i.position,i.radius))}function Ye(c){const e={ziptie:"Zip Tie","water-bottle":"Water Bottle",cup:"Cup","flashing-light":"Flashing Light","furry-hat":"Furry Hat","cigarette-butt":"Cigarette Butt","light-bulb":"Light Bulb",ducting:"Ducting",bucket:"Bucket",glitter:"Glitter",rope:"Rope","plastic-bag":"Plastic Bag",boots:"Boots","cat-head":"Cat Head",clothing:"Clothing",cape:"Cape"}[c]||c;return gt(e)}function Xe(c){return{coins:c,energy:0,mood:0}}function je(c){return{success:!0,statDelta:Xe(c),message:`Picked up ${c} coin${c>1?"s":""}!`}}const ze=4e3,Ue=6,X=300,_e=1,Ke=30,Ve=300;function Je(c,t){const e=t.randomRange(c.x,c.x+c.w),i=t.randomRange(c.y,c.y+c.h);return{x:e,y:i}}function Qe(c,t){return{id:c,pos:t,active:!1}}function Ze(c,t){const{x:e,y:i,w:s,h:o}=t.aabb;return c.filter(a=>!a.active&&a.pos.x>=e&&a.pos.x<=e+s&&a.pos.y>=i&&a.pos.y<=i+o).length}function ti(c,t){return`gascan:${c}:${t}`}function ei(c,t,e,i){const s=e-c.lastSpawnAt;if(Ze(t,c)>=(c.maxCans??Ue))return{cans:t,station:c};const a=c.spawnIntervalMs??ze;if(s<a)return{cans:t,station:c};const n=Math.floor(e/a),r=ti(c.id,n),l=Je(c.aabb,i),d=Qe(r,l),h=[...t,d],u={...c,lastSpawnAt:e};return{cans:h,station:u}}const Bt=[{design:"classic",size:1,speed:1,fuelMax:X},{design:"fire",size:1.2,speed:1.3,fuelMax:X*.8},{design:"speedy",size:.8,speed:1.5,fuelMax:X*.6},{design:"heavy",size:2.2,speed:.7,fuelMax:X*1.5},{design:"compact",size:.6,speed:1.1,fuelMax:X*.7},{design:"alien",size:1.1,speed:1.3,fuelMax:X*.9},{design:"davinci",size:2,speed:.6,fuelMax:X*1.2},{design:"octopus",size:2.5,speed:.9,fuelMax:X*1.1}];function et(c,t){const e=c.randomInt(0,Bt.length),i=Bt[e],o=120*i.speed+c.randomRange(-5,5),a=c.randomRange(0,Math.PI*2),n={x:Math.cos(a)*o,y:Math.sin(a)*o};return{id:`artcar:${Math.floor(c.getSeed())}:${Math.floor(c.random()*1e6)}`,pos:{...t},vel:n,fuel:i.fuelMax,fuelMax:i.fuelMax,fuelLowThreshold:Ke,state:"patrol",platformAabb:{x:t.x-24*i.size,y:t.y-12*i.size,w:48*i.size,h:24*i.size},design:i.design,size:i.size,speed:i.speed}}function ii(c,t,e){let i={x:c.pos.x+c.vel.x*t,y:c.pos.y+c.vel.y*t};const s={x:2e3,y:1500},o=1400,a=60*c.size;if(Math.hypot(i.x-s.x,i.y-s.y)+a>o){const l=Math.atan2(i.y-s.y,i.x-s.x);i.x=s.x+Math.cos(l)*(o-a),i.y=s.y+Math.sin(l)*(o-a);const d=Math.cos(l),h=Math.sin(l),u=c.vel.x*d+c.vel.y*h;c.vel.x-=2*u*d,c.vel.y-=2*u*h}const r={...c.platformAabb,x:i.x-60*c.size,y:i.y-30*c.size};return{...c,pos:i,platformAabb:r}}function si(c,t){const i=Math.hypot(c.vel.x,c.vel.y)>.001?_e*t:0,s=Math.max(0,Math.min(c.fuelMax,c.fuel-i));return{...c,fuel:s}}function oi(c,t){return Math.hypot(c.x-t.x,c.y-t.y)}function ai(c,t){const e=30*c.size;for(const i of t){if(i.active)continue;if(oi(c.pos,i.pos)<=e){const o=Math.min(Ve,c.fuelMax-c.fuel),a={...c,fuel:c.fuel+o};return{collided:!0,canId:i.id,fuelAdded:o,car:a}}}return{collided:!1,fuelAdded:0,car:c}}function Pt(c,t){return Math.hypot(c.x-t.x,c.y-t.y)}function ni(c,t){return c.fuel<=c.fuelLowThreshold?"seekFuel":c.fuel>=c.fuelMax*.8?"patrol":c.state}function ri(c,t){const{cans:e,station:i,player:s}=t;if(s.holding&&s.holding.kind==="GasCan"&&Pt(c.pos,s.pos)<=50)return{targetPos:{x:s.pos.x,y:s.pos.y}};let o=null,a=1/0;for(const l of e){if(l.active)continue;const d=Pt(c.pos,l.pos);d<a&&(o=l,a=d)}if(o)return{targetPos:{x:o.pos.x,y:o.pos.y}};const n=i.aabb.x+i.aabb.w/2,r=i.aabb.y+i.aabb.h/2;return{targetPos:{x:n,y:r}}}function ci(c){const t={position:T(0,0),zoom:c.zoom,viewport:{x:0,y:0,width:c.viewportWidth,height:c.viewportHeight},followSpeed:c.followSpeed,worldBounds:c.worldBounds};return Lt(t),t}function Lt(c){const t=c.viewport.width/2,e=c.viewport.height/2;c.viewport.x=c.position.x-t,c.viewport.y=c.position.y-e}function P(c,t){const e=(c.x-t.viewport.x)*t.zoom,i=(c.y-t.viewport.y)*t.zoom;return T(e,i)}function E(c,t,e=0){const i=t.viewport.x-e,s=t.viewport.x+t.viewport.width+e,o=t.viewport.y-e,a=t.viewport.y+t.viewport.height+e;return c.x>=i&&c.x<=s&&c.y>=o&&c.y<=a}function lt(c,t){let e=t.x,i=t.y;if(c.worldBounds){const s=c.viewport.width/2,o=c.viewport.height/2;e=Math.max(c.worldBounds.minX+s,Math.min(c.worldBounds.maxX-s,e)),i=Math.max(c.worldBounds.minY+o,Math.min(c.worldBounds.maxY-o,i))}c.position=T(e,i),Lt(c)}function li(c,t,e,i){const s=c.position,o=t,a=o.x-s.x,n=o.y-s.y,r=Math.sqrt(a*a+n*n);if(r<1){lt(c,o);return}const l=i*e,d=Math.min(l/r,1),h=s.x+a*d,u=s.y+n*d;lt(c,T(h,u))}class hi{constructor(t,e){M(this,"ctx");M(this,"config");M(this,"canvas");M(this,"muteButtonBounds",null);M(this,"pauseButtonBounds",null);M(this,"lightsButtonBounds",null);M(this,"restButtonBounds",null);M(this,"giftButtonBounds",null);M(this,"mousePosition",{x:0,y:0});M(this,"inventoryItemBounds",[]);M(this,"backgroundImage",null);M(this,"backgroundImageLoaded",!1);M(this,"mathCache",{sinCache:new Map,cosCache:new Map,lastCacheTime:0,cacheSize:1e3});M(this,"objectPool",{vec2Pool:[],maxPoolSize:100});M(this,"rainDrops",[]);M(this,"lightningBolts",[]);M(this,"fireParticles",[]);M(this,"fireParticlePool",[]);M(this,"flameGradients",[]);M(this,"fireGradientsGenerated",!1);M(this,"smokeParticles",[]);M(this,"smokeParticlePool",[]);M(this,"lastLightSystemLogTime",0);M(this,"npcs",[]);M(this,"npcColors",["#ff6b6b","#4ecdc4","#45b7d1","#96ceb4","#feca57","#ff9ff3","#54a0ff","#5f27cd","#00d2d3","#ff9f43","#10ac84","#ee5a24"]);M(this,"camps",[]);M(this,"campTypes",[{type:"tent",colors:["#8b4513","#a0522d","#cd853f","#daa520"],sizes:[20,25,30]},{type:"rv",colors:["#ffffff","#87ceeb","#f0f8ff"],sizes:[35,40]},{type:"makeshift",colors:["#696969","#778899","#a9a9a9","#d3d3d3"],sizes:[25,30,35]},{type:"art",colors:["#ff69b4","#32cd32","#ffd700","#ff4500"],sizes:[30,40,50]}]);const i=t.getContext("2d");if(!i)throw new Error("Failed to get 2D context from canvas");this.ctx=i,this.config=e,this.canvas=t,t.width=e.canvasWidth,t.height=e.canvasHeight,this.loadBackgroundImage(),this.setupMouseEvents()}cachedSin(t){const e=Math.round(t*1e3)/1e3;if(this.mathCache.sinCache.has(e))return this.mathCache.sinCache.get(e);const i=Math.sin(t);return this.mathCache.sinCache.size>=this.mathCache.cacheSize&&this.mathCache.sinCache.clear(),this.mathCache.sinCache.set(e,i),i}cachedCos(t){const e=Math.round(t*1e3)/1e3;if(this.mathCache.cosCache.has(e))return this.mathCache.cosCache.get(e);const i=Math.cos(t);return this.mathCache.cosCache.size>=this.mathCache.cacheSize&&this.mathCache.cosCache.clear(),this.mathCache.cosCache.set(e,i),i}getVec2(t=0,e=0){if(this.objectPool.vec2Pool.length>0){const i=this.objectPool.vec2Pool.pop();return i.x=t,i.y=e,i}return{x:t,y:e}}returnVec2(t){this.objectPool.vec2Pool.length<this.objectPool.maxPoolSize&&this.objectPool.vec2Pool.push(t)}loadBackgroundImage(){this.backgroundImage=new Image,this.backgroundImage.onload=()=>{this.backgroundImageLoaded=!0},this.backgroundImage.onerror=t=>{var e;console.warn("❌ Failed to load background satellite image:",t),console.warn("Attempted path:",(e=this.backgroundImage)==null?void 0:e.src),this.backgroundImageLoaded=!1},this.backgroundImage.src="/wq2/images/playa-sattelite.png"}renderBackgroundImage(t){if(!this.backgroundImage||!this.backgroundImageLoaded)return;this.ctx.save();const e=2e3,i=1500,s=1400,o=P({x:e,y:i},t),a=P({x:e-s,y:i-s},t),r=P({x:e+s,y:i+s},t).x-a.x;this.ctx.beginPath(),this.ctx.arc(o.x,o.y,r/2,0,Math.PI*2),this.ctx.clip(),this.ctx.drawImage(this.backgroundImage,a.x,a.y,r,r),this.ctx.restore()}setupMouseEvents(){this.canvas.addEventListener("click",t=>{const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top;if(this.pauseButtonBounds&&i>=this.pauseButtonBounds.x&&i<=this.pauseButtonBounds.x+this.pauseButtonBounds.width&&s>=this.pauseButtonBounds.y&&s<=this.pauseButtonBounds.y+this.pauseButtonBounds.height){window.dispatchEvent(new CustomEvent("togglePause"));return}if(this.muteButtonBounds&&i>=this.muteButtonBounds.x&&i<=this.muteButtonBounds.x+this.muteButtonBounds.width&&s>=this.muteButtonBounds.y&&s<=this.muteButtonBounds.y+this.muteButtonBounds.height){window.dispatchEvent(new CustomEvent("toggleMute"));return}if(this.lightsButtonBounds&&i>=this.lightsButtonBounds.x&&i<=this.lightsButtonBounds.x+this.lightsButtonBounds.width&&s>=this.lightsButtonBounds.y&&s<=this.lightsButtonBounds.y+this.lightsButtonBounds.height){window.dispatchEvent(new CustomEvent("toggleLights"));return}if(this.giftButtonBounds){const o=this.giftButtonBounds;if(i>=o.x&&i<=o.x+o.width&&s>=o.y&&s<=o.y+o.height){window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"gift"}}));return}}if(this.giftRowButtonBounds){const o=this.giftRowButtonBounds;if(i>=o.x&&i<=o.x+o.width&&s>=o.y&&s<=o.y+o.height){window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"gift"}}));return}}if(this.totemButtonBounds){const o=this.totemButtonBounds;if(i>=o.x&&i<=o.x+o.width&&s>=o.y&&s<=o.y+o.height){window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"toggleTotem"}}));return}}if(this.restButtonBounds&&i>=this.restButtonBounds.x&&i<=this.restButtonBounds.x+this.restButtonBounds.width&&s>=this.restButtonBounds.y&&s<=this.restButtonBounds.y+this.restButtonBounds.height){window.dispatchEvent(new CustomEvent("toggleRest"));return}for(const o of this.inventoryItemBounds)if(i>=o.x&&i<=o.x+o.width&&s>=o.y&&s<=o.y+o.height){window.dispatchEvent(new CustomEvent("useInventoryItem",{detail:{itemType:o.itemType}}));return}})}clear(t="#2c3e50"){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.config.canvasWidth,this.config.canvasHeight)}renderPlayer(t,e,i=!1,s=50,o=!1){const{playerSize:a}=this.config,n=a/2;if(!E(t,e,n))return;const r=P(t,e),l=a*e.zoom;this.ctx.fillStyle="#ff6b35",this.ctx.fillRect(r.x-l/2,r.y-l/2,l,l),this.ctx.strokeStyle=o?"#00ff00":"#e55a2b",this.ctx.lineWidth=o?3*e.zoom:2*e.zoom,this.ctx.strokeRect(r.x-l/2,r.y-l/2,l,l),this.drawWombatFeatures(r,l,e.zoom,i,s)}calculateDrugSpeedMultiplier(t){let e=1;for(const i of t.active)i.effects.speed&&(e+=i.effects.speed*i.intensity/100);return Math.max(.1,e)}drawWombatFeatures(t,e,i,s=!1,o=50){const a=Date.now()*.001,n=this.cachedSin(a*2)*.5+.5,r=!s&&n<.1;let l="normal";o>=80?l="happy":o>=60?l="normal":o>=40?l="worried":o>=20?l="sad":l="very_sad",this.ctx.fillStyle="#ff6b35";const d=e*.25,h=e*.35;if(this.ctx.fillRect(t.x-e*.4,t.y-e*.6,d,h),this.ctx.fillRect(t.x+e*.15,t.y-e*.6,d,h),s){this.ctx.strokeStyle="#2c3e50",this.ctx.lineWidth=2;const f=e*.24;this.ctx.beginPath(),this.ctx.moveTo(t.x-e*.2-f/2,t.y-e*.1-f/2),this.ctx.lineTo(t.x-e*.2+f/2,t.y-e*.1+f/2),this.ctx.moveTo(t.x-e*.2+f/2,t.y-e*.1-f/2),this.ctx.lineTo(t.x-e*.2-f/2,t.y-e*.1+f/2),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t.x+e*.2-f/2,t.y-e*.1-f/2),this.ctx.lineTo(t.x+e*.2+f/2,t.y-e*.1+f/2),this.ctx.moveTo(t.x+e*.2+f/2,t.y-e*.1-f/2),this.ctx.lineTo(t.x+e*.2-f/2,t.y-e*.1+f/2),this.ctx.stroke()}else{const f=e*.3;let x=r?e*.05:e*.2,p=r?0:e*.08;l==="happy"&&!r?(x=e*.12,p=e*.05):l==="worried"&&!r?(x=e*.2,p=e*.08):l==="sad"&&!r?(x=e*.12,p=e*.06):l==="very_sad"&&!r&&(x=e*.08,p=e*.04),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(t.x-e*.2-f/2,t.y-e*.1-x/2,f,x),r||(this.ctx.fillStyle="#2c3e50",this.ctx.beginPath(),this.ctx.arc(t.x-e*.2,t.y-e*.1,p,0,Math.PI*2),this.ctx.fill()),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(t.x+e*.2-f/2,t.y-e*.1-x/2,f,x),r||(this.ctx.fillStyle="#2c3e50",this.ctx.beginPath(),this.ctx.arc(t.x+e*.2,t.y-e*.1,p,0,Math.PI*2),this.ctx.fill())}this.ctx.fillStyle="#2c3e50";const u=e*.15;this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y+e*.05),this.ctx.lineTo(t.x-u/2,t.y+e*.2),this.ctx.lineTo(t.x+u/2,t.y+e*.2),this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="#2c3e50",this.ctx.lineWidth=3,this.ctx.beginPath(),o>=80?this.ctx.arc(t.x,t.y+e*.35,e*.15,0,Math.PI):o>=60?(this.ctx.moveTo(t.x-e*.1,t.y+e*.35),this.ctx.lineTo(t.x+e*.1,t.y+e*.35)):o>=40?this.ctx.arc(t.x,t.y+e*.4,e*.1,Math.PI,0):o>=20?this.ctx.arc(t.x,t.y+e*.45,e*.12,Math.PI,0):this.ctx.arc(t.x,t.y+e*.5,e*.15,Math.PI,0),this.ctx.stroke()}renderCoin(t,e,i){if(!E(t,i,2.4))return;const o=P(t,i),a=2.4*i.zoom;this.ctx.fillStyle="#f1c40f",this.ctx.beginPath(),this.ctx.arc(o.x,o.y,a,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#f39c12",this.ctx.lineWidth=1*i.zoom,this.ctx.stroke()}renderCampMate(t,e){const{playerSize:i}=this.config,s=i/2;if(!E(t.position,e,s))return;const o=P(t.position,e),a=i*e.zoom;this.ctx.fillStyle=t.color,this.ctx.fillRect(o.x-a/2,o.y-a/2,a,a);const n=this.darkenColor(t.color,.2);this.ctx.strokeStyle=n,this.ctx.lineWidth=2*e.zoom,this.ctx.strokeRect(o.x-a/2,o.y-a/2,a,a),this.drawStaticWombatFeatures(o,a,e.zoom,t.color)}darkenColor(t,e){const i=t.replace("#",""),s=parseInt(i.substr(0,2),16),o=parseInt(i.substr(2,2),16),a=parseInt(i.substr(4,2),16),n=Math.floor(s*(1-e)),r=Math.floor(o*(1-e)),l=Math.floor(a*(1-e));return`#${n.toString(16).padStart(2,"0")}${r.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`}drawStaticWombatFeatures(t,e,i,s){this.ctx.fillStyle=s;const o=e*.25,a=e*.35;this.ctx.fillRect(t.x-e*.4,t.y-e*.6,o,a),this.ctx.fillRect(t.x+e*.15,t.y-e*.6,o,a),this.ctx.fillStyle="#000000";const n=e*.08,r=t.y-e*.15;this.ctx.fillRect(t.x-e*.2,r,n,n),this.ctx.fillRect(t.x+e*.12,r,n,n),this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(t.x-e*.04,t.y+e*.1,e*.15,0,Math.PI),this.ctx.stroke()}drawWombatFeaturesForCampMate(t,e,i,s=!1,o=50,a){const n=Date.now()*.001,r=Math.sin(n*2)*.5+.5,l=!s&&r<.1;let d="normal";o>=80?d="happy":o>=60?d="normal":o>=40?d="worried":o>=20?d="sad":d="very_sad",this.ctx.fillStyle=a;const h=e*.25,u=e*.35;if(this.ctx.fillRect(t.x-e*.4,t.y-e*.6,h,u),this.ctx.fillRect(t.x+e*.15,t.y-e*.6,h,u),s){this.ctx.strokeStyle="#2c3e50",this.ctx.lineWidth=2;const x=e*.24;this.ctx.beginPath(),this.ctx.moveTo(t.x-e*.2-x/2,t.y-e*.1-x/2),this.ctx.lineTo(t.x-e*.2+x/2,t.y-e*.1+x/2),this.ctx.moveTo(t.x-e*.2+x/2,t.y-e*.1-x/2),this.ctx.lineTo(t.x-e*.2-x/2,t.y-e*.1+x/2),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t.x+e*.2-x/2,t.y-e*.1-x/2),this.ctx.lineTo(t.x+e*.2+x/2,t.y-e*.1+x/2),this.ctx.moveTo(t.x+e*.2+x/2,t.y-e*.1-x/2),this.ctx.lineTo(t.x+e*.2-x/2,t.y-e*.1+x/2),this.ctx.stroke()}else{const x=e*.3;let p=l?e*.05:e*.2,m=l?0:e*.08;d==="happy"&&!l?(p=e*.12,m=e*.05):d==="worried"&&!l?(p=e*.2,m=e*.08):d==="sad"&&!l?(p=e*.12,m=e*.06):d==="very_sad"&&!l&&(p=e*.08,m=e*.04),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(t.x-e*.2-x/2,t.y-e*.1-p/2,x,p),l||(this.ctx.fillStyle="#2c3e50",this.ctx.beginPath(),this.ctx.arc(t.x-e*.2,t.y-e*.1,m,0,Math.PI*2),this.ctx.fill()),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(t.x+e*.2-x/2,t.y-e*.1-p/2,x,p),l||(this.ctx.fillStyle="#2c3e50",this.ctx.beginPath(),this.ctx.arc(t.x+e*.2,t.y-e*.1,m,0,Math.PI*2),this.ctx.fill())}this.ctx.fillStyle="#2c3e50";const f=e*.15;this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y+e*.05),this.ctx.lineTo(t.x-f/2,t.y+e*.2),this.ctx.lineTo(t.x+f/2,t.y+e*.2),this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="#2c3e50",this.ctx.lineWidth=3,this.ctx.beginPath(),o>=80?this.ctx.arc(t.x,t.y+e*.35,e*.15,0,Math.PI):o>=60?(this.ctx.moveTo(t.x-e*.1,t.y+e*.35),this.ctx.lineTo(t.x+e*.1,t.y+e*.35)):o>=40?this.ctx.arc(t.x,t.y+e*.4,e*.1,Math.PI,0):o>=20?this.ctx.arc(t.x,t.y+e*.45,e*.12,Math.PI,0):this.ctx.arc(t.x,t.y+e*.5,e*.15,Math.PI,0),this.ctx.stroke()}renderMoop(t,e){if(!E(t.position,e,t.radius))return;const i=P(t.position,e),s=16*e.zoom,o=Ye(t.type);this.ctx.font=`${s}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(o,i.x,i.y)}renderCollectible(t,e,i,s,o,a){if(!E(t,s,20))return;const n=P(t,s),r=(e==="bike"?50:20)*s.zoom;let l;switch(e){case"coin":return;case"water":l="💧";break;case"food":l=this.getFoodEmoji(i);break;case"drug":l=this.getDrugEmoji(i);break;case"bike":l="🚲";break;case"light-bulb":a?l=this.getLightBulbEmoji(a):l="💡";break;case"light-bulb-white":l="💡";break;case"light-bulb-red":l="🔴";break;case"light-bulb-green":l="🟢";break;case"light-bulb-blue":l="🔵";break;case"light-bulb-orange":l="🟠";break;case"light-bulb-purple":l="🟣";break;case"light-bulb-rainbow":l="🌈";break;case"battery":l="🔋";break;default:l="📦"}if(e.startsWith("light-bulb")){this.renderColoredLightBulb(n,r,e);return}if(e==="drug"){const d=i==="energy-drink",h=d?"rgba(255, 215, 0, 0.7)":"#9b59b6",u=d?"rgba(255, 165, 0, 0.8)":"#e74c3c";this.ctx.shadowColor=h,this.ctx.shadowBlur=30*s.zoom,this.ctx.font=`${r}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(l,n.x,n.y),this.ctx.shadowColor=u,this.ctx.shadowBlur=15*s.zoom,this.ctx.fillText(l,n.x,n.y),this.ctx.shadowBlur=0,this.ctx.fillText(l,n.x,n.y)}else if(e==="bike"){const d=["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#34495e"],h=parseInt((o||"0").split("_").pop()||"0")%d.length,u=d[h];this.ctx.save(),this.ctx.filter=`hue-rotate(${this.getHueRotation(u)}deg) saturate(1.5) brightness(1.2)`,this.ctx.font=`${r}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(l,n.x,n.y),this.ctx.restore()}else this.ctx.font=`${r}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(l,n.x,n.y)}getFoodEmoji(t){return{"Grilled Cheese":"🧀","Energy Bar":"⚡","Veggie Burger":"🍔","Fruit Salad":"🥗","Pizza Slice":"🍕",Smoothie:"🥤",Popsicle:"🍭",Burrito:"🌯",Taco:"🌮","Ice Cream":"🍦","Corn Dog":"🌭","Bacon Pancakes":"🥓",Nachos:"🧀","Cotton Candy":"🍬","Dusty Donut":"🍩","Playa Pizza":"🍕","Burner Burger":"🍔",Pickles:"🥒"}[t||""]||"🍎"}getDrugEmoji(t){return{molly:"💎",shrooms:"🍄",acid:"🌈",dmt:"💫",salvia:"🌿",whipits:"🎈","energy-drink":"🍼",bike:"🚲","mystery-pill":"💊","mystery-snowball":"❄️",cigarette:"🚬",joint:"🚬",vodka:"🥃",mda:"💎","2c-i":"🧪",caffeine:"☕",alcohol:"🍺",mdma:"💎",mushrooms:"🍄",weed:"🌿",cocaine:"⚪",ketamine:"⚪",cannabis:"🌿"}[t||""]||"❓"}getHueRotation(t){return{"#e74c3c":0,"#3498db":200,"#2ecc71":120,"#f39c12":30,"#9b59b6":270,"#1abc9c":180,"#e67e22":20,"#34495e":210}[t]||0}renderLightBatteryMeter(t,e,i,s){this.ctx.fillStyle="#ffd23f",this.ctx.font="bold 14px Arial",this.ctx.textAlign="left",this.ctx.fillText("🔋 Battery:",t,e+12);const o=e+35,a=t,n=o,r=25,l=18;let d="#666666";(s.player.lightsOn||i>0)&&(i>60?d="#27ae60":i>30?d="#f39c12":i>0&&(d="#e74c3c")),this.ctx.strokeStyle=d,this.ctx.lineWidth=2,this.ctx.strokeRect(a,n,r,l),this.ctx.fillStyle=d,this.ctx.fillRect(a+r,n+4,3,10);const h=i/100*(r-4);i>0&&(i>60?this.ctx.fillStyle="#27ae60":i>30?this.ctx.fillStyle="#f39c12":this.ctx.fillStyle="#e74c3c",this.ctx.fillRect(a+2,n+2,h,l-4));const u=8,f=18,x=3,p=u*10+x*9,m=t+170-p,g=o;for(let y=0;y<10;y++){const S=m+y*(u+x),b=(y+1)*10;if(this.ctx.fillStyle="#2c3e50",this.ctx.fillRect(S,g,u,f),i>=b)i>70?this.ctx.fillStyle="#27ae60":i>30?this.ctx.fillStyle="#f39c12":this.ctx.fillStyle="#e74c3c",this.ctx.fillRect(S+1,g+1,u-2,f-2);else if(i>y*10){const w=(i-y*10)/10;let v;i>70?v={r:39,g:174,b:96}:i>30?v={r:243,g:156,b:18}:v={r:231,g:76,b:60};const k=Math.floor(v.r*w),C=Math.floor(v.g*w),B=Math.floor(v.b*w);this.ctx.fillStyle=`rgb(${k}, ${C}, ${B})`,this.ctx.fillRect(S+1,g+1,u-2,f-2)}else this.ctx.fillStyle="#34495e",this.ctx.fillRect(S+1,g+1,u-2,f-2);this.ctx.fillStyle="rgba(255, 255, 255, 0.2)",this.ctx.fillRect(S,g,u,1)}}renderStatBar(t,e,i,s,o,a,n,r){this.ctx.fillStyle="#ffd23f",this.ctx.font="bold 14px Arial",this.ctx.textAlign="left",this.ctx.fillText(r,t,e+12);const l=t,d=i,h=8,u=e+24;this.ctx.fillStyle="#34495e",this.ctx.fillRect(l,u,d,h);const f=Math.max(0,Math.min(1,o/a)),x=d*f;this.ctx.fillStyle=n,this.ctx.fillRect(l,u,x,h),this.ctx.strokeStyle="#2c3e50",this.ctx.lineWidth=1,this.ctx.strokeRect(l,u,d,h)}renderWorldBounds(t){if(!t.worldBounds)return;const e=P({x:t.worldBounds.minX,y:t.worldBounds.minY},t),i=P({x:t.worldBounds.maxX,y:t.worldBounds.maxY},t);this.ctx.strokeStyle="#e74c3c",this.ctx.lineWidth=3*t.zoom,this.ctx.strokeRect(e.x,e.y,i.x-e.x,i.y-e.y)}drawRoundedRect(t,e,i,s,o){this.ctx.beginPath(),this.ctx.moveTo(t+o,e),this.ctx.lineTo(t+i-o,e),this.ctx.quadraticCurveTo(t+i,e,t+i,e+o),this.ctx.lineTo(t+i,e+s-o),this.ctx.quadraticCurveTo(t+i,e+s,t+i-o,e+s),this.ctx.lineTo(t+o,e+s),this.ctx.quadraticCurveTo(t,e+s,t,e+s-o),this.ctx.lineTo(t,e+o),this.ctx.quadraticCurveTo(t,e,t+o,e),this.ctx.closePath()}renderHUD(t,e,i,s,o,a,n,r,l,d){const h=this.config.canvasWidth;this.config.canvasHeight,this.renderInventoryPanel(15,60,t.player.inventory),this.renderTopInfoBar(h,t,i||!1,!1),this.renderActionPanel(t.player.isResting,i||!1,!1,t.player.lightsOn,t.player.inventory,t.player.equippedItem==="Totem",r||!1,l||!1,d||!1);const u=h-240,f=15,x=220,p=480;this.ctx.fillStyle="rgba(0, 0, 0, 0.85)",this.drawRoundedRect(u,f,x,p,12),this.ctx.fill(),this.ctx.strokeStyle="#ffd23f",this.ctx.lineWidth=3,this.drawRoundedRect(u,f,x,p,12),this.ctx.stroke(),this.ctx.strokeStyle="rgba(255, 210, 63, 0.3)",this.ctx.lineWidth=1,this.drawRoundedRect(u+2,f+2,x-4,p-4,10),this.ctx.stroke();let m=f+20;const g=42;this.renderStatBar(u+20,m,180,30,t.player.stats.mood,100,"#9b59b6","😊 Mood"),m+=g,this.renderStatBar(u+20,m,180,30,t.player.stats.energy,100,"#f1c40f","⚡ Energy"),m+=g,this.renderStatBar(u+20,m,180,30,t.player.stats.thirst,100,"#3498db","💧 Thirst"),m+=g,this.renderStatBar(u+20,m,180,30,t.player.stats.hunger,100,"#e67e22","🍔 Hunger"),m+=g,this.renderStatBar(u+20,m,180,30,t.player.stats.bathroom,100,"#8b4513","🚽 Bathroom"),m+=45,this.renderLightBatteryMeter(u+20,m,t.player.stats.lightBattery,t),m+=70,this.ctx.fillStyle="#ffd23f",this.ctx.font="bold 15px Arial";const y=`💰 Coins: ${t.player.stats.coins}`;if(this.ctx.fillText(y,u+20,m),a!==void 0&&a!==0){const C=this.ctx.font,B="bold 15px Arial";this.ctx.font=B;const I=this.ctx.measureText(y).width;this.ctx.fillStyle="#27ae60",this.ctx.font="bold 12px Arial";const A=a>0?`(+${a})`:`(${a})`;this.ctx.fillText(A,u+20+I+6,m),this.ctx.font=C}m+=32,this.ctx.fillStyle="#ffd23f",this.ctx.font="bold 15px Arial";const S=`✨ Karma: ${Math.round(t.player.stats.karma)}`;if(this.ctx.fillText(S,u+20,m),n!==void 0&&n!==0){const C=this.ctx.font,B="bold 15px Arial";this.ctx.font=B;const I=this.ctx.measureText(S).width;this.ctx.fillStyle="#27ae60",this.ctx.font="bold 12px Arial";const A=n>0?`(+${Math.round(n)})`:`(${Math.round(n)})`;this.ctx.fillText(A,u+20+I+6,m),this.ctx.font=C}m+=32;const b=this.calculateDrugSpeedMultiplier(t.player.drugs),w=t.player.isOnBike||t.player.mountedOn?1.5:1,k=At(t.player.stats.speed,t.player.stats)*b*w;if(this.ctx.fillText(`🏃 Speed: ${(k/100).toFixed(1)}x`,u+20,m),m+=32,s!==void 0&&this.ctx.fillText(`⏰ Time: ${s.toFixed(1)}x`,u+20,m),o&&o.length>0){m+=25;const C=m,B=o.length*25+15;this.ctx.fillStyle="rgba(0, 0, 0, 0.9)",this.ctx.fillRect(u,C,x,B),this.ctx.strokeStyle="#e74c3c",this.ctx.lineWidth=2,this.ctx.strokeRect(u,C,x,B),this.ctx.fillStyle="#e74c3c",this.ctx.font="bold 12px Arial",this.ctx.textAlign="left",this.ctx.fillText("Active Effects:",u+10,C+15),[...o].sort((A,D)=>D.duration-A.duration).forEach((A,D)=>{const F=C+25+D*25,$=`${Math.ceil(A.duration)}s`,N=this.getDrugEmoji(A.type);let Y=A.type.charAt(0).toUpperCase()+A.type.slice(1).replace("-"," ");A.type==="dmt"&&(Y="DMT"),this.ctx.fillStyle="#f1c40f",this.ctx.font="11px Arial",this.ctx.fillText(`${N} ${Y}: ${$}`,u+10,F)})}}renderInventoryPanel(t,e,i){const s=Mt(i),o=["Totem","Lights","Food","Moop"],a=g=>/Light Bulb|Battery|Bulb|Flashlight/i.test(g),n=g=>/Pizza|Nachos|Pickles|Bacon|Corn Dog|Energy Bar|Grilled Cheese|Water|Burner Burger|Cotton Candy|Dusty Donut|Smoothie|Popsicle|Fruit Salad|Burrito|Taco|Ice Cream/i.test(g),r=g=>g==="Totem"?"Totem":a(g)?"Lights":n(g)?"Food":"Moop",l={};for(const g of s){const y=r(g.type);l[y]||(l[y]=[]),l[y].push(g)}const d=[];for(const g of o)if(l[g]&&l[g].length){d.push({type:`__HEADER__:${g}`,quantity:0});const y=l[g].slice().sort((S,b)=>(b.quantity??0)-(S.quantity??0)||S.type.localeCompare(b.type));for(const S of y)d.push(S)}const h=15,u=Math.ceil(d.length/h),f=260,x=30,p=40,m=u*f+(u-1)*10;this.inventoryItemBounds=[],this.ctx.fillStyle="#8b5cf6",this.ctx.font="bold 16px Arial",this.ctx.textAlign="center",this.ctx.fillText("🎒 INVENTORY",t+m/2,e+22),d.forEach((g,y)=>{const S=Math.floor(y/h),b=y%h,w=t+S*(f+10),v=e+p+15+b*x;if(typeof g.type=="string"&&g.type.startsWith("__HEADER__:")){const B=g.type.split(":")[1],I=B==="Totem"||B==="Food"||B==="Moop"||B==="Lights";this.ctx.fillStyle=I?"#ffffff":"#bbb",this.ctx.font="bold 13px Arial",this.ctx.textAlign="left",this.ctx.fillText(B.toUpperCase(),w+8,v-2);return}this.inventoryItemBounds.push({x:w+8,y:v-18,width:f-16,height:24,itemType:g.type}),this.ctx.fillStyle="rgba(139, 92, 246, 0.7)",this.drawRoundedRect(w+8,v-18,f-16,24,6),this.ctx.fill(),this.ctx.strokeStyle="rgba(168, 85, 247, 0.9)",this.ctx.lineWidth=1,this.drawRoundedRect(w+8,v-18,f-16,24,6),this.ctx.stroke();const k=gt(g.type);this.ctx.fillStyle="#f8f9fa",this.ctx.font="bold 13px Arial",this.ctx.textAlign="left";const C=g.hotkey?`${k} [${g.hotkey}] ${g.type}`:`${k} ${g.type}`;this.ctx.fillText(C,w+15,v-3),this.ctx.fillStyle="rgba(0, 0, 0, 0.6)",this.ctx.fillRect(w+f-40,v-12,30,14),this.ctx.strokeStyle="#8b5cf6",this.ctx.lineWidth=1,this.ctx.strokeRect(w+f-40,v-12,30,14),this.ctx.fillStyle="#ecf0f1",this.ctx.font="12px Arial",this.ctx.textAlign="center",this.ctx.fillText(g.quantity.toString(),w+f-25,v-2)})}renderEquippedItemEffects(t,e){if(t.equippedItem)switch(t.equippedItem){case"Totem":this.renderTotemSpiralLasers(t.position,e);break;case"Cape":this.renderCapeTrail(t.position,e);break;case"POI":this.renderPOILight(t.position,e);break;case"Fire Spinning":this.renderFireSpinningEffect(t.position,e);break;case"Costume":this.renderCostumeEffect(t.position,e);break}}renderTotemSpiralLasers(t,e){const i=P(t,e),s=Date.now()*.002,o=100,a=12;this.ctx.save();for(let n=0;n<a;n++){const r=n/a*Math.PI*2+s,l=n/a*360+s*40,d=i.x+Math.cos(r)*o,h=i.y+Math.sin(r)*o;this.ctx.strokeStyle=`hsl(${l%360}, 100%, 60%)`,this.ctx.lineWidth=4,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y),this.ctx.lineTo(d,h),this.ctx.stroke(),this.ctx.strokeStyle=`hsla(${l%360}, 100%, 70%, 0.4)`,this.ctx.lineWidth=10,this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y),this.ctx.lineTo(d,h),this.ctx.stroke(),this.ctx.fillStyle=`hsl(${l%360}, 100%, 80%)`,this.ctx.beginPath(),this.ctx.arc(d,h,3,0,Math.PI*2),this.ctx.fill()}this.ctx.restore()}renderCapeTrail(t,e){const i=P(t,e),s=Date.now()*.003;this.ctx.save();const o=8,a=40,n=8;for(let r=0;r<o;r++){const l=r/o,d=a*(1-l*.3),h=Math.sin(s+l*Math.PI*2)*n*(1-l),u=.4-l*.2,f=270+l*20;this.ctx.fillStyle=`hsla(${f}, 70%, 60%, ${u})`;const x=i.x-10+h,p=i.y+5+l*15,m=20+h*.3,g=d;this.ctx.fillRect(x,p,m,g),this.ctx.shadowColor=`hsl(${f}, 70%, 60%)`,this.ctx.shadowBlur=3,this.ctx.fillRect(x,p,m,g),this.ctx.shadowBlur=0}this.ctx.fillStyle="rgba(255, 255, 255, 0.8)";for(let r=0;r<3;r++){const l=s+r*2,d=i.x+Math.sin(l)*25,h=i.y+Math.cos(l*1.3)*20,u=2+Math.sin(l*2)*1;this.ctx.fillRect(d-u/2,h-u/2,u,u)}this.ctx.restore()}renderPOILight(t,e){const i=P(t,e);this.ctx.save(),this.ctx.shadowColor="#4a90e2",this.ctx.shadowBlur=20,this.ctx.fillStyle="#4a90e2",this.ctx.fillRect(i.x-10,i.y-10,20,20),this.ctx.restore()}renderFireSpinningEffect(t,e){const i=P(t,e),s=Date.now()*.005;this.ctx.save();for(let o=0;o<3;o++){const a=s+o/3*Math.PI*2,n=25+o*10,r=i.x+Math.cos(a)*n,l=i.y+Math.sin(a)*n;this.ctx.fillStyle=`rgba(255, ${100-o*30}, 0, 0.7)`,this.ctx.beginPath(),this.ctx.arc(r,l,8-o*2,0,Math.PI*2),this.ctx.fill()}this.ctx.restore()}renderCostumeEffect(t,e){const i=P(t,e),s=Date.now()*.005;this.ctx.save();for(let o=0;o<8;o++){const a=s+o/8*Math.PI*2,n=35+Math.sin(s*2+o)*10,r=i.x+Math.cos(a)*n,l=i.y+Math.sin(a)*n,d=["#FFD700","#C0C0C0","#FF69B4","#00CED1","#FFA500"],h=d[o%d.length];this.ctx.fillStyle=h,this.ctx.beginPath(),this.ctx.arc(r,l,3+Math.sin(s*3+o)*2,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowColor=h,this.ctx.shadowBlur=8,this.ctx.fill()}this.ctx.strokeStyle="rgba(255, 215, 0, 0.4)",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,40+Math.sin(s*2)*5,0,Math.PI*2),this.ctx.stroke(),this.ctx.restore()}renderNotifications(t){[...W().notifications].sort((o,a)=>a.timestamp-o.timestamp).forEach((o,a)=>{if(!E(o.worldPosition,t))return;const n=P(o.worldPosition,t),r=a*30,l=n.y-r,d=this.getNotificationColor(o.type,o.value);this.ctx.strokeStyle=`rgba(0, 0, 0, ${o.alpha*.8})`,this.ctx.lineWidth=2,this.ctx.font="bold 20px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.strokeText(o.message,n.x,l),this.ctx.fillStyle=`${d}${Math.floor(255*o.alpha).toString(16).padStart(2,"0")}`,this.ctx.fillText(o.message,n.x,l)})}renderCampEffects(t){this.ctx.strokeStyle="#808080",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]);const e={x:50,y:50,width:1500,height:1100},i=P({x:e.x,y:e.y},t),s=P({x:e.x+e.width,y:e.y+e.height},t);this.ctx.strokeRect(i.x,i.y,s.x-i.x,s.y-i.y),this.ctx.setLineDash([]),this.renderCampTents(t);const o=Date.now()*.001,a={x:1200,y:1500},n=P(a,t);if(E(a,t,50)){const l=60*(1+this.cachedSin(o*3)*.3)*t.zoom;this.ctx.font=`${l}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("🪩",n.x,n.y)}}renderCampTents(t){[{x:200,y:200},{x:400,y:300},{x:600,y:150},{x:800,y:250},{x:1e3,y:180},{x:1200,y:320},{x:1400,y:200},{x:300,y:500},{x:500,y:600},{x:700,y:550},{x:900,y:650},{x:1100,y:580},{x:1300,y:620}].forEach(i=>{if(E(i,t,30)){const s=P(i,t),o=80*t.zoom;this.ctx.font=`${o}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("⛺",s.x,s.y)}})}renderPlayaEffects(t){this.renderTents(t),this.renderPlayaCamps(t)}renderTents(t){[{x:400,y:300},{x:1800,y:400},{x:600,y:1400},{x:2e3,y:1500},{x:300,y:800},{x:2100,y:1e3}].forEach(i=>{if(E(i,t,30)){const s=P(i,t),o=20*t.zoom;this.ctx.font=`${o}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("⛺",s.x,s.y)}})}renderPlayaCamps(t){[{x:300,y:400},{x:1900,y:500},{x:500,y:1500},{x:2100,y:1600},{x:400,y:900},{x:2e3,y:1100},{x:1500,y:300},{x:800,y:1600}].forEach(i=>{if(E(i,t,30)){const s=P(i,t),o=25*t.zoom;this.ctx.font=`${o}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("🏕️",s.x,s.y)}})}renderActionButtons(t,e,i,s,o){const l=t;this.renderActionButton(l,e,30,s?"▶":"⏸",s?"Resume":"Pause","P",s?"#e74c3c":"#27ae60"),this.pauseButtonBounds={x:l,y:e,width:30,height:55};const d=t+70+10;this.renderActionButton(d,e,30,i?"🔇":"🔊",i?"Unmute":"Mute","M",i?"#e74c3c":"#27ae60"),this.muteButtonBounds={x:d,y:e,width:30,height:55};const h=t+80*2;this.renderActionButton(h,e,30,o?"💡":"🔦",o?"Lights On":"Lights Off","L",o?"#ffffff":"#95a5a6"),this.lightsButtonBounds={x:h,y:e,width:30,height:55}}renderActionPanel(t,e,i,s,o,a,n,r,l){const h=this.config.canvasHeight-180,u=200,f=160;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.drawRoundedRect(10,h,u,f,10),this.ctx.fill(),this.ctx.strokeStyle="#ffd23f",this.ctx.lineWidth=2,this.drawRoundedRect(10,h,u,f,10),this.ctx.stroke(),this.ctx.fillStyle="#ffd23f",this.ctx.font="bold 14px Arial",this.ctx.textAlign="left",this.ctx.fillText("Actions",20,h+20);const x=(()=>{try{if(o){const R=Mt(o);if(Array.isArray(R))return R.some($=>(($==null?void 0:$.quantity)??0)>0)}if(o&&o.items&&typeof o.items.values=="function"){for(const R of o.items.values())if(R>0)return!0}}catch{}return!1})(),p=h+40,m=30,g=(u-30)/2;if(x&&(this.ctx.fillStyle=t?"rgba(46, 204, 113, 0.3)":"rgba(52, 73, 94, 0.3)",this.ctx.fillRect(20,p,g,m),this.ctx.strokeStyle=t?"#2ecc71":"#34495e",this.ctx.lineWidth=1,this.ctx.strokeRect(20,p,g,m),this.ctx.fillStyle=t?"#2ecc71":"#ecf0f1",this.ctx.font="12px Arial",this.ctx.textAlign="left",this.ctx.fillText("😴 Rest [R]",25,p+20)),x){const R=20+g+10;this.ctx.fillStyle="rgba(39, 174, 96, 0.3)",this.ctx.fillRect(R,p,g,m),this.ctx.strokeStyle="#27ae60",this.ctx.lineWidth=1,this.ctx.strokeRect(R,p,g,m),this.ctx.fillStyle="#27ae60",this.ctx.font="12px Arial",this.ctx.textAlign="left",this.ctx.fillText("🎁 Gift [G]",R+5,p+20),this.giftRowButtonBounds={x:R,y:p,width:g,height:m}}else this.ctx.fillStyle=t?"rgba(46, 204, 113, 0.3)":"rgba(52, 73, 94, 0.3)",this.ctx.fillRect(20,p,u-20,m),this.ctx.strokeStyle=t?"#2ecc71":"#34495e",this.ctx.lineWidth=1,this.ctx.strokeRect(20,p,u-20,m),this.ctx.fillStyle=t?"#2ecc71":"#ecf0f1",this.ctx.font="12px Arial",this.ctx.textAlign="center",this.ctx.fillText("😴 Rest [R]",20+(u-20)/2,p+20),this.giftRowButtonBounds=null;t&&(this.ctx.fillStyle="#2ecc71",this.ctx.font="10px Arial",this.ctx.textAlign="right",this.ctx.fillText("ACTIVE",10+g-5,p+20)),this.restButtonBounds=x?{x:20,y:p,width:g,height:m}:{x:20,y:p,width:u-20,height:m};const y=p+40,S=25;(()=>{try{if(o&&o.items&&typeof o.items.entries=="function"){for(const[R,$]of o.items.entries())if($>0&&(R.includes("Light Bulb")||R==="Battery"))return!0}}catch{}return!1})()?(this.ctx.fillStyle=s?"rgba(241, 196, 15, 0.3)":"rgba(149, 165, 166, 0.3)",this.ctx.fillRect(20,y,u-20,S),this.ctx.strokeStyle=s?"#f1c40f":"#95a5a6",this.ctx.lineWidth=1,this.ctx.strokeRect(20,y,u-20,S),this.ctx.fillStyle=s?"#ffffff":"#95a5a6",this.ctx.font="11px Arial",this.ctx.textAlign="center",this.ctx.fillText(`${s?"💡":"🔦"} ${s?"Lights On":"Lights Off"} [L]`,20+(u-20)/2,y+16),this.lightsButtonBounds={x:20,y,width:u-20,height:S}):this.lightsButtonBounds=null;const w=(()=>{try{return a?!0:!!(o&&o.items&&o.items.get&&o.items.get("Totem")>0)}catch{return!!a}})();if(w){const R=y+35,$=20,N=u-20,Y=25,j=!!a;this.ctx.fillStyle=j?"rgba(255, 215, 0, 0.25)":"rgba(52, 73, 94, 0.3)",this.ctx.fillRect($,R,N,Y),this.ctx.strokeStyle=j?"#ffd23f":"#34495e",this.ctx.lineWidth=1,this.ctx.strokeRect($,R,N,Y),this.ctx.fillStyle=j?"#ffd23f":"#ecf0f1",this.ctx.font="12px Arial",this.ctx.textAlign="center",this.ctx.fillText(`${j?"🪩 Totem On":"🪩 Totem Off"} [T]`,$+N/2,R+16),this.totemButtonBounds={x:$,y:R,width:N,height:Y}}else this.totemButtonBounds=null;const v=25,k=20,C=u-20;let B=y+35;w&&(B=y+70),n?(this.ctx.fillStyle="rgba(39, 174, 96, 0.3)",this.ctx.fillRect(k,B,C,v),this.ctx.strokeStyle="#27ae60",this.ctx.lineWidth=1,this.ctx.strokeRect(k,B,C,v),this.ctx.fillStyle="#27ae60",this.ctx.font="11px Arial",this.ctx.textAlign="center",this.ctx.fillText("🚲 Mount Bike [Space]",k+C/2,B+16),this.bikeButtonBounds={x:k,y:B,width:C,height:v}):this.bikeButtonBounds=null;const I=25,A=20,D=u-20;let F=y+70;if(w&&(F=y+105),n&&(F+=30),r||l){this.ctx.fillStyle="rgba(155, 89, 182, 0.3)",this.ctx.fillRect(A,F,D,I),this.ctx.strokeStyle="#9b59b6",this.ctx.lineWidth=1,this.ctx.strokeRect(A,F,D,I),this.ctx.fillStyle="#9b59b6",this.ctx.font="11px Arial",this.ctx.textAlign="center";const R=l?"🚗 Dismount Art Car [Space]":"🚗 Mount Art Car [Space]";this.ctx.fillText(R,A+D/2,F+16),this.artCarButtonBounds={x:A,y:F,width:D,height:I}}else this.artCarButtonBounds=null}handleCanvasClick(t,e){if(this.bikeButtonBounds){const i=this.bikeButtonBounds;if(t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height){window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"mountBike"}}));return}}if(this.artCarButtonBounds){const i=this.artCarButtonBounds;if(t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height){window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"mountArtCar"}}));return}}if(this.totemButtonBounds){const i=this.totemButtonBounds;if(t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height){window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"toggleTotem"}}));return}}if(this.lightsButtonBounds){const i=this.lightsButtonBounds;if(t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height){console.log("🖱️ Lights button clicked - dispatching toggleLights action"),window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"toggleLights"}}));return}}if(this.restButtonBounds){const i=this.restButtonBounds;if(t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height){window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"toggleRest"}}));return}}if(this.giftButtonBounds){const i=this.giftButtonBounds;if(t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height){window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"gift"}}));return}}}getNotificationColor(t,e){const i=e>0;switch(t){case"coin":return i?"#f1c40f":"#e74c3c";case"thirst":return i?"#3498db":"#e74c3c";case"hunger":return i?"#e67e22":"#e74c3c";case"energy":return i?"#f1c40f":"#e74c3c";case"mood":return i?"#9b59b6":"#e74c3c";case"karma":return i?"#27ae60":"#e74c3c";case"speed":return i?"#1abc9c":"#e74c3c";case"item":return"#8b5cf6";default:return i?"#27ae60":"#e74c3c"}}renderTopInfoBar(t,e,i,s){try{const x=t-270-220;this.ctx.fillStyle="rgba(139, 69, 19, 0.9)",this.drawRoundedRect(270,10,x,50,8),this.ctx.fill(),this.ctx.strokeStyle="#ff8c00",this.ctx.lineWidth=2,this.drawRoundedRect(270,10,x,50,8),this.ctx.stroke();const p=["Saturday","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday","Monday"],m=Math.max(0,8-e.time.day),g=`${e.time.hour.toString().padStart(2,"0")}:${e.time.minute.toString().padStart(2,"0")}`,y=`Day ${e.time.day} (${p[e.time.day-1]})`;let S;e.time.day<8?S=`${m} days to Man Burn`:e.time.day===8?S="Man Burn Tonight!":e.time.day===9?S="Temple Burn Tonight!":e.time.day>=10?S="Exodus":S="Man Burn Tonight!";const b=this.getWeatherEmoji(e.weather.type),w=this.getTimeEmoji(e.time.hour);this.ctx.fillStyle="#ffd23f",this.ctx.font="bold 16px Arial",this.ctx.textAlign="center",this.ctx.fillText(`${y} • ${g} ${b} ${w} • ${S}`,270+x/2,30);const v=this.getStatusMessage(e);this.ctx.fillStyle="#ffd23f",this.ctx.font="14px Arial",this.ctx.fillText(v,270+x/2,48);const k=Math.floor(90/3),C=30,B=8,I=20,A=280,D=(N,Y,j)=>{const ht=this.ctx.createLinearGradient(0,I,0,I+C);ht.addColorStop(0,"rgba(255,255,255,0.15)"),ht.addColorStop(1,"rgba(255,255,255,0.05)"),this.ctx.fillStyle=ht,this.drawRoundedRect(N,I,k,C,6),this.ctx.fill(),this.ctx.strokeStyle=j,this.ctx.lineWidth=1.5,this.ctx.stroke(),this.ctx.fillStyle=j,this.ctx.font="16px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(Y,N+k/2,I+C/2)};D(A,s?"▶":"⏸",s?"#e74c3c":"#27ae60"),this.pauseButtonBounds={x:A,y:I,width:k,height:C};const R=A+k+B;D(R,i?"🔇":"🔊",i?"#e74c3c":"#27ae60"),this.muteButtonBounds={x:R,y:I,width:k,height:C}}catch(o){console.error("Error rendering top info bar:",o)}}getWeatherEmoji(t){switch(t){case"clear":return"☀️";case"nice":return"🌤️";case"overcast":return"☁️";case"thunderstorm":return"⛈️";case"duststorm":return"🌪️";default:return"☀️"}}getTimeEmoji(t){return t>=6&&t<12?"🌅":t>=12&&t<18?"☀️":t>=18&&t<22?"🌆":"🌙"}getLightBulbEmoji(t){switch(t){case"Light Bulb Red":return"🔴";case"Light Bulb Green":return"🟢";case"Light Bulb Blue":return"🔵";case"Light Bulb Orange":return"🟠";case"Light Bulb Purple":return"🟣";case"Light Bulb Rainbow":return"🌈";case"Light Bulb":case"Light Bulb White":default:return"💡"}}getStatusMessage(t){const e=t.time.day;return t.time.hour,e===1?"Welcome to the playa! The adventure begins...":e===2?"More people are arriving! The energy is building...":e===3?"The playa is getting busier! Art cars and bikes everywhere...":e===4?"Midweek energy! The Man is taking shape...":e===5?"The excitement is building! Temple construction continues...":e===6?"Almost time! The Man and Temple are nearly complete...":e===7?"The big night approaches! Everything is ready...":e===8?"Tonight's the night! The Man will burn!":e===9?"The Temple burns tonight. A time for reflection...":e>=10?"The burn is over. Time to pack up and leave no trace...":"The playa awaits your exploration..."}renderTopActionBar(t,e,i){const h=(t-170)/2;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.drawRoundedRect(h,10,170,40,8),this.ctx.fill(),this.ctx.strokeStyle="#ffd23f",this.ctx.lineWidth=2,this.drawRoundedRect(h,10,170,40,8),this.ctx.stroke();const u=h+5,f=15;this.renderActionButton(u,f,30,i?"▶":"⏸",i?"Resume":"Pause","P",i?"#e74c3c":"#27ae60"),this.pauseButtonBounds={x:u,y:f,width:30,height:55};const x=h+80+10,p=15;this.renderActionButton(x,p,30,e?"🔇":"🔊",e?"Unmute":"Mute","M",e?"#e74c3c":"#27ae60"),this.muteButtonBounds={x,y:p,width:30,height:55}}renderActionButton(t,e,i,s,o,a,n){this.ctx.fillStyle=n,this.drawRoundedRect(t,e,i,i,5),this.ctx.fill(),this.ctx.strokeStyle="#ecf0f1",this.ctx.lineWidth=2,this.drawRoundedRect(t,e,i,i,5),this.ctx.stroke(),this.ctx.fillStyle="#ecf0f1",this.ctx.font="16px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(s,t+i/2,e+i/2),this.ctx.fillStyle="#ffd23f",this.ctx.font="bold 10px Arial",this.ctx.textAlign="center",this.ctx.fillText(o,t+i/2,e+i+12),this.ctx.fillStyle="#ecf0f1",this.ctx.font="9px Arial",this.ctx.textAlign="center",this.ctx.fillText(`[${a}]`,t+i/2,e+i+22)}renderPauseButton(t,e,i){this.pauseButtonBounds={x:t,y:e,width:30,height:50},this.ctx.fillStyle=i?"#e74c3c":"#27ae60",this.drawRoundedRect(t,e,30,30,5),this.ctx.fill(),this.ctx.strokeStyle="#ecf0f1",this.ctx.lineWidth=2,this.drawRoundedRect(t,e,30,30,5),this.ctx.stroke(),this.ctx.fillStyle="#ecf0f1",this.ctx.font="16px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(i?"▶":"⏸",t+30/2,e+30/2),this.ctx.fillStyle="#ecf0f1",this.ctx.font="10px Arial",this.ctx.textAlign="center",this.ctx.fillText(i?"Resume":"Pause",t+30/2,e+30+15)}renderMuteButton(t,e,i){this.muteButtonBounds={x:t,y:e,width:30,height:50},this.ctx.fillStyle=i?"#e74c3c":"#27ae60",this.drawRoundedRect(t,e,30,30,5),this.ctx.fill(),this.ctx.strokeStyle="#ecf0f1",this.ctx.lineWidth=2,this.drawRoundedRect(t,e,30,30,5),this.ctx.stroke(),this.ctx.fillStyle="#ecf0f1",this.ctx.font="16px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(i?"🔇":"🔊",t+30/2,e+30/2),this.ctx.font="12px Arial",this.ctx.fillText("M",t+30/2,e+30+15)}renderFireEffects(t,e){this.generateFlameGradients();const i=Date.now()*.001,s=16;Math.random()<.15&&this.createFireParticle(t.x+(Math.random()-.5)*e*.6,t.y+e*.4,e*.15),Math.random()<.1&&this.createSmokeParticle(t.x+(Math.random()-.5)*e*.4,t.y+e*.2,e*.2),this.updateFireParticles(s),this.updateSmokeParticles(s),this.ctx.save();for(const a of this.smokeParticles)this.ctx.globalAlpha=a.opacity,this.ctx.fillStyle=`rgba(50, 50, 50, ${a.opacity})`,this.ctx.beginPath(),this.ctx.arc(a.x,a.y,a.size,0,Math.PI*2),this.ctx.fill();this.ctx.restore(),this.ctx.save();for(const a of this.fireParticles){const n=this.flameGradients[a.frame];n&&(this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(a.x,a.y,a.size,0,Math.PI*2),this.ctx.fill())}if(this.ctx.restore(),Math.sin(i*4)>.8)for(let a=0;a<8;a++){const n=a/8*Math.PI*2+Math.random()*.5,r=e*2+Math.random()*e,l=t.x+Math.cos(n)*r,d=t.y+Math.sin(n)*r;this.ctx.fillStyle=`hsl(${Math.random()*60+20}, 100%, 80%)`,this.ctx.beginPath(),this.ctx.arc(l,d,2+Math.random()*3,0,Math.PI*2),this.ctx.fill()}this.ctx.save(),this.ctx.globalCompositeOperation="screen";for(let a=0;a<3;a++){const n=a*.3,r=e*(.8+a*.2);this.ctx.fillStyle=`rgba(255, 0, 0, ${.7-a*.2})`,this.ctx.beginPath(),this.ctx.ellipse(t.x+Math.sin(i*2+n)*5,t.y+e*.3+n*10,r*.4,r*.8,Math.sin(i*1.5+n)*.2,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=`rgba(255, 100, 0, ${.6-a*.15})`,this.ctx.beginPath(),this.ctx.ellipse(t.x+Math.sin(i*2.5+n)*8,t.y+e*.2+n*8,r*.35,r*.7,Math.sin(i*1.8+n)*.3,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=`rgba(255, 200, 0, ${.5-a*.1})`,this.ctx.beginPath(),this.ctx.ellipse(t.x+Math.sin(i*3+n)*6,t.y+e*.1+n*6,r*.3,r*.6,Math.sin(i*2.2+n)*.4,0,Math.PI*2),this.ctx.fill()}this.ctx.restore(),this.ctx.save();const o=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,e*2);o.addColorStop(0,"rgba(255, 100, 0, 0.3)"),o.addColorStop(.5,"rgba(255, 50, 0, 0.1)"),o.addColorStop(1,"rgba(255, 0, 0, 0)"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e*2,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}generateFlameGradients(){if(this.fireGradientsGenerated)return;const t=[{t:0,color:"rgba(255, 0, 0, 0.8)"},{t:.2,color:"rgba(255, 100, 0, 0.9)"},{t:.4,color:"rgba(255, 200, 0, 0.8)"},{t:.6,color:"rgba(255, 255, 100, 0.6)"},{t:.8,color:"rgba(255, 255, 200, 0.4)"},{t:1,color:"rgba(255, 255, 255, 0.1)"}];for(let e=0;e<20;e++){const i=this.ctx.createRadialGradient(0,0,0,0,0,20);t.forEach(s=>{const o=s.t,a=s.color;i.addColorStop(o,a)}),this.flameGradients[e]=i}this.fireGradientsGenerated=!0}createFireParticle(t,e,i){let s;this.fireParticlePool.length>0?s=this.fireParticlePool.pop():s={x:0,y:0,vx:0,vy:0,size:0,life:0,maxLife:0,frame:0},s.x=t,s.y=e,s.vx=(Math.random()-.5)*.8,s.vy=-Math.random()*1.5-.5,s.size=i+Math.random()*i*.5,s.life=0,s.maxLife=60+Math.random()*40,s.frame=0,this.fireParticles.push(s)}updateFireParticles(t){for(let e=this.fireParticles.length-1;e>=0;e--){const i=this.fireParticles[e];i.x+=i.vx,i.y+=i.vy,i.vy+=.1,i.vx*=.98,i.vy*=.98,i.life+=1,i.frame=Math.floor(i.life/i.maxLife*19),i.life>=i.maxLife&&(this.fireParticles.splice(e,1),this.fireParticlePool.push(i))}}createSmokeParticle(t,e,i){let s;this.smokeParticlePool.length>0?s=this.smokeParticlePool.pop():s={x:0,y:0,vx:0,vy:0,size:0,life:0,maxLife:0,opacity:0},s.x=t,s.y=e,s.vx=(Math.random()-.5)*1,s.vy=-Math.random()*2-.5,s.size=i+Math.random()*i*.5,s.life=0,s.maxLife=120+Math.random()*80,s.opacity=.8,this.smokeParticles.push(s)}updateSmokeParticles(t){for(let e=this.smokeParticles.length-1;e>=0;e--){const i=this.smokeParticles[e];i.x+=i.vx,i.y+=i.vy,i.vx+=(Math.random()-.5)*.1,i.vx*=.99,i.vy*=.99,i.life+=1,i.opacity=Math.max(0,.8-i.life/i.maxLife*.8),(i.life>=i.maxLife||i.opacity<=0)&&(this.smokeParticles.splice(e,1),this.smokeParticlePool.push(i))}}generateNPCs(){if(this.npcs.length>0)return;const t=250;for(let e=0;e<t;e++){const i={x:Math.random()*4e3,y:Math.random()*4e3,vx:0,vy:0,color:this.npcColors[Math.floor(Math.random()*this.npcColors.length)],size:8+Math.random()*4,walkCycle:Math.random()*Math.PI*2,targetX:0,targetY:0,wanderTimer:0};this.setNPCTarget(i),this.npcs.push(i)}}setNPCTarget(t){const e=200+Math.random()*300,i=Math.random()*Math.PI*2;t.targetX=t.x+Math.cos(i)*e,t.targetY=t.y+Math.sin(i)*e,t.targetX=Math.max(100,Math.min(3900,t.targetX)),t.targetY=Math.max(100,Math.min(3900,t.targetY)),t.wanderTimer=60+Math.random()*120}updateNPCs(t){for(const e of this.npcs){e.wanderTimer-=1,e.wanderTimer<=0&&this.setNPCTarget(e);const i=e.targetX-e.x,s=e.targetY-e.y,o=Math.sqrt(i*i+s*s);if(o>10){const a=.5+Math.random()*.5;e.vx=i/o*a,e.vy=s/o*a}else e.vx*=.9,e.vy*=.9;e.x+=e.vx,e.y+=e.vy,e.walkCycle+=.2}}renderNPCs(t){this.ctx.save();for(const e of this.npcs){if(!E({x:e.x,y:e.y},t,20))continue;const i=P({x:e.x,y:e.y},t),s=e.size*t.zoom;this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.ctx.beginPath(),this.ctx.ellipse(i.x+2,i.y+2,s*.6,s*.3,0,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s*.4,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#fdbcb4",this.ctx.beginPath(),this.ctx.arc(i.x,i.y-s*.3,s*.25,0,Math.PI*2),this.ctx.fill();const o=Math.sin(e.walkCycle)*s*.1;this.ctx.strokeStyle=e.color,this.ctx.lineWidth=s*.1,this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y+s*.4),this.ctx.lineTo(i.x-s*.2,i.y+s*.7+o),this.ctx.moveTo(i.x,i.y+s*.4),this.ctx.lineTo(i.x+s*.2,i.y+s*.7-o),this.ctx.stroke()}this.ctx.restore()}generateCamps(){if(this.camps.length>0)return;const t=175;for(let e=0;e<t;e++){const i=this.campTypes[Math.floor(Math.random()*this.campTypes.length)],s={x:Math.random()*4e3,y:Math.random()*4e3,type:i.type,color:i.colors[Math.floor(Math.random()*i.colors.length)],size:i.sizes[Math.floor(Math.random()*i.sizes.length)],rotation:Math.random()*Math.PI*2};this.camps.push(s)}}renderCamps(t){this.ctx.save();for(const e of this.camps){if(!E({x:e.x,y:e.y},t,30))continue;const i=P({x:e.x,y:e.y},t),s=e.size*t.zoom;switch(this.ctx.fillStyle="rgba(0, 0, 0, 0.3)",this.ctx.beginPath(),this.ctx.ellipse(i.x+3,i.y+3,s*.8,s*.4,0,0,Math.PI*2),this.ctx.fill(),e.type){case"tent":this.renderTent(i,s,e.color,e.rotation);break;case"rv":this.renderRV(i,s,e.color,e.rotation);break;case"makeshift":this.renderMakeshiftBuilding(i,s,e.color,e.rotation);break;case"art":this.renderArtStructure(i,s,e.color,e.rotation);break}}this.ctx.restore()}renderTent(t,e,i,s){this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(s),this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.moveTo(-e*.5,e*.3),this.ctx.lineTo(0,-e*.3),this.ctx.lineTo(e*.5,e*.3),this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="#8b4513",this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(0,-e*.3),this.ctx.lineTo(0,e*.3),this.ctx.stroke(),this.ctx.restore()}renderRV(t,e,i,s){this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(s),this.ctx.fillStyle=i,this.ctx.fillRect(-e*.5,-e*.2,e,e*.4),this.ctx.fillStyle="#696969",this.ctx.fillRect(-e*.4,-e*.3,e*.8,e*.1),this.ctx.fillStyle="#87ceeb",this.ctx.fillRect(-e*.3,-e*.15,e*.15,e*.1),this.ctx.fillRect(e*.15,-e*.15,e*.15,e*.1),this.ctx.fillStyle="#2f2f2f",this.ctx.beginPath(),this.ctx.arc(-e*.3,e*.2,e*.08,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(e*.3,e*.2,e*.08,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}renderMakeshiftBuilding(t,e,i,s){this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(s),this.ctx.fillStyle=i,this.ctx.fillRect(-e*.4,-e*.2,e*.8,e*.4),this.ctx.fillStyle="#8b4513",this.ctx.beginPath(),this.ctx.moveTo(-e*.4,-e*.2),this.ctx.lineTo(0,-e*.4),this.ctx.lineTo(e*.4,-e*.2),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle="#654321",this.ctx.fillRect(-e*.1,-e*.1,e*.2,e*.2),this.ctx.restore()}renderArtStructure(t,e,i,s){this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(s),this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.arc(0,0,e*.4,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#ffffff",this.ctx.beginPath(),this.ctx.arc(-e*.2,-e*.2,e*.1,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(e*.2,e*.2,e*.1,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#ffd700",this.ctx.lineWidth=3,this.ctx.beginPath();for(let o=0;o<20;o++){const a=o/20*Math.PI*4,n=o/20*e*.3,r=Math.cos(a)*n,l=Math.sin(a)*n;o===0?this.ctx.moveTo(r,l):this.ctx.lineTo(r,l)}this.ctx.stroke(),this.ctx.restore()}renderFireworks(t,e){const i=t.x,s=t.y,o=Date.now()*.001;if(this.ctx.save(),Math.floor(o*10)%3!==0){this.ctx.restore();return}const a=o%3,n=Math.min(1,a/1.5);if(n>0){const r=i+Math.sin(o*.3)*e*.2,l=s-e*.6+Math.cos(o*.2)*e*.1,d=e*.6*n,h=8;for(let u=0;u<h;u++){const f=u/h*Math.PI*2,x=d*(.4+Math.random()*.6),p=r+Math.cos(f)*x,m=l+Math.sin(f)*x,y=Math.max(0,1-(a-1.5)/1.5)*.7,S=[`rgba(255, 0, 0, ${y})`,`rgba(0, 255, 0, ${y})`,`rgba(0, 0, 255, ${y})`,`rgba(255, 255, 255, ${y})`];this.ctx.fillStyle=S[u%S.length],this.ctx.beginPath(),this.ctx.arc(p,m,2,0,Math.PI*2),this.ctx.fill()}}if(Math.random()<.02){const r=i+(Math.random()-.5)*e*1.5,l=s-e*1.2+Math.random()*e*.3;this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath(),this.ctx.arc(r,l,1,0,Math.PI*2),this.ctx.fill()}this.ctx.restore()}renderAshes(t,e,i){const s=t.x,o=t.y;this.ctx.save();const a=e*.3*(1-i*.7),n=a*.3,r=this.ctx.createRadialGradient(s,o-n*.5,0,s,o-n*.5,a);if(r.addColorStop(0,`rgba(60, 60, 60, ${.8-i*.3})`),r.addColorStop(.5,`rgba(80, 80, 80, ${.6-i*.2})`),r.addColorStop(1,`rgba(100, 100, 100, ${.4-i*.2})`),this.ctx.fillStyle=r,this.ctx.beginPath(),this.ctx.ellipse(s,o,a,n,0,0,Math.PI*2),this.ctx.fill(),Math.random()<.3){const l=s+(Math.random()-.5)*a*2,d=o-n-Math.random()*20,h=1+Math.random()*2;this.ctx.fillStyle=`rgba(120, 120, 120, ${.6-i*.3})`,this.ctx.beginPath(),this.ctx.arc(l,d,h,0,Math.PI*2),this.ctx.fill()}this.ctx.restore()}renderBonfire(t,e){const i=t.x,s=t.y,o=e;this.ctx.save();const a=Date.now()*.001;this.ctx.fillStyle="#8B0000",this.ctx.beginPath(),this.ctx.ellipse(i,s+o*.1,o*.3,o*.1,0,0,Math.PI*2),this.ctx.fill();for(let r=0;r<5;r++){const l=r*.2,d=o*(.4+r*.1),h=Math.sin(a*3+l)*.1;this.ctx.fillStyle=`rgba(255, 0, 0, ${.8-r*.15})`,this.ctx.beginPath(),this.ctx.ellipse(i+h*10,s-o*.2+l*20,d*.3,d*.6,Math.sin(a*2+l)*.3,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=`rgba(255, 100, 0, ${.7-r*.12})`,this.ctx.beginPath(),this.ctx.ellipse(i+h*8,s-o*.15+l*15,d*.25,d*.5,Math.sin(a*2.5+l)*.4,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=`rgba(255, 200, 0, ${.6-r*.1})`,this.ctx.beginPath(),this.ctx.ellipse(i+h*6,s-o*.1+l*10,d*.2,d*.4,Math.sin(a*3+l)*.5,0,Math.PI*2),this.ctx.fill()}const n=this.ctx.createRadialGradient(i,s,0,i,s,o*1.5);n.addColorStop(0,"rgba(255, 100, 0, 0.4)"),n.addColorStop(.5,"rgba(255, 50, 0, 0.2)"),n.addColorStop(1,"rgba(255, 0, 0, 0)"),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(i,s,o*1.5,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}renderPixelFlames(t,e,i){const s=t.x,o=t.y,a=Date.now()*.001;this.ctx.save();const n=Math.floor(i*30),r=e*.3+i*e*1.5;for(let l=0;l<n;l++){const d=l/n*Math.PI*2+a*.3,h=Math.random()*r,u=s+Math.cos(d)*h,f=o+Math.sin(d)*h,x=Math.floor((a*2+l*.1)%4),p=2+Math.random()*2;this.renderPixelFlame(u,f,p,x)}this.ctx.restore()}renderPixelFlame(t,e,i,s){this.ctx.save(),this.ctx.translate(t,e),this.ctx.scale(i,i);const o=[[{x:0,y:0,color:"#ff1c1c"},{x:1,y:0,color:"#ff1c1c"},{x:2,y:0,color:"#ff1c1c"},{x:0,y:1,color:"#ff1c1c"},{x:1,y:1,color:"#ff6c31"},{x:2,y:1,color:"#ff1c1c"},{x:0,y:2,color:"#ff1c1c"},{x:1,y:2,color:"#ffc231"},{x:2,y:2,color:"#ff1c1c"},{x:1,y:3,color:"#ff1c1c"}],[{x:1,y:0,color:"#ff1c1c"},{x:0,y:1,color:"#ff1c1c"},{x:1,y:1,color:"#ff6c31"},{x:2,y:1,color:"#ff1c1c"},{x:0,y:2,color:"#ff1c1c"},{x:1,y:2,color:"#ffc231"},{x:2,y:2,color:"#ff1c1c"},{x:0,y:3,color:"#ff1c1c"},{x:1,y:3,color:"white"},{x:2,y:3,color:"#ff1c1c"},{x:1,y:4,color:"#ff1c1c"}],[{x:0,y:0,color:"#ff1c1c"},{x:1,y:0,color:"#ff1c1c"},{x:2,y:0,color:"#ff1c1c"},{x:0,y:1,color:"#ff1c1c"},{x:1,y:1,color:"#ff6c31"},{x:2,y:1,color:"#ff1c1c"},{x:0,y:2,color:"#ff1c1c"},{x:1,y:2,color:"#ffc231"},{x:2,y:2,color:"#ff1c1c"},{x:0,y:3,color:"#ff1c1c"},{x:1,y:3,color:"white"},{x:2,y:3,color:"#ff1c1c"}],[{x:1,y:0,color:"#ff1c1c"},{x:0,y:1,color:"#ff1c1c"},{x:1,y:1,color:"#ff6c31"},{x:2,y:1,color:"#ff1c1c"},{x:0,y:2,color:"#ff1c1c"},{x:1,y:2,color:"#ffc231"},{x:2,y:2,color:"#ff1c1c"},{x:1,y:3,color:"#ff1c1c"}]];o[s%o.length].forEach(n=>{this.ctx.fillStyle=n.color,this.ctx.fillRect(n.x,n.y,1,1)}),this.ctx.restore()}renderDestructionParticles(t,e,i){const s=t.x,o=t.y,a=Date.now()*.001;this.ctx.save();const n=Math.floor(i*50),r=e*.5+i*e*2;for(let l=0;l<n;l++){const d=l/n*Math.PI*2+a*.5,h=Math.random()*r,u=s+Math.cos(d)*h,f=o+Math.sin(d)*h,x=Math.max(1,4-h/r*3),p=Math.max(.1,.8-h/r*.7),m=[`rgba(255, 100, 100, ${p})`,`rgba(255, 150, 50, ${p})`,`rgba(255, 200, 100, ${p})`,`rgba(150, 150, 150, ${p})`,`rgba(200, 100, 100, ${p})`];if(this.ctx.fillStyle=m[Math.floor(Math.random()*m.length)],this.ctx.beginPath(),this.ctx.arc(u,f,x,0,Math.PI*2),this.ctx.fill(),Math.random()<.3){const g=u-Math.cos(d)*10,y=f-Math.sin(d)*10;this.ctx.fillStyle=`rgba(255, 200, 100, ${p*.5})`,this.ctx.beginPath(),this.ctx.arc(g,y,x*.5,0,Math.PI*2),this.ctx.fill()}}if(i>.3){const l=Math.floor(i*8);for(let d=0;d<l;d++){const h=Math.random()*Math.PI*2,u=Math.random()*r*.8,f=s+Math.cos(h)*u,x=o+Math.sin(h)*u,p=2+Math.random()*4;this.ctx.fillStyle=`rgba(100, 100, 100, ${.6-u/r*.4})`,this.ctx.beginPath(),this.ctx.arc(f,x,p,0,Math.PI*2),this.ctx.fill()}}this.ctx.restore()}renderTheMan(t,e,i,s,o,a){const n=t.x,r=t.y,l=e;if(this.ctx.save(),i>.05){this.ctx.fillStyle="#8B4513",this.ctx.fillRect(n-l*.3,r+l*.15,l*.6,l*.1),this.ctx.strokeRect(n-l*.3,r+l*.15,l*.6,l*.1),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=2;for(let h=0;h<5;h++){const u=n-l*.25+h*l*.125;this.ctx.beginPath(),this.ctx.moveTo(u,r+l*.15),this.ctx.lineTo(u,r+l*.25),this.ctx.stroke()}}if(i>.15){const h=l*.8*Math.min((i-.15)*1.5,1);this.ctx.fillStyle="#654321",this.ctx.fillRect(n-l*.05,r+l*.5-h,l*.1,h),this.ctx.strokeRect(n-l*.05,r+l*.5-h,l*.1,h),this.ctx.strokeStyle="#4A2C17",this.ctx.lineWidth=1;for(let u=0;u<Math.floor(h/20);u++){const f=r+l*.5-h+u*20;this.ctx.beginPath(),this.ctx.moveTo(n-l*.05,f),this.ctx.lineTo(n+l*.05,f),this.ctx.stroke()}}if(i>.45){const h=Math.min((i-.45)*2,1);this.ctx.fillStyle="#FF6B35",this.ctx.fillRect(n-l*.08*h,r-l*.3*h,l*.16*h,l*.4*h),this.ctx.strokeRect(n-l*.08*h,r-l*.3*h,l*.16*h,l*.4*h),this.ctx.strokeStyle="#E55A2B",this.ctx.lineWidth=2;for(let u=0;u<4;u++){const f=r-l*.3*h+u*l*.1*h;this.ctx.beginPath(),this.ctx.moveTo(n-l*.08*h,f),this.ctx.lineTo(n+l*.08*h,f),this.ctx.stroke()}a!=null&&a.head||(this.ctx.beginPath(),this.ctx.arc(n,r-l*.4*h,l*.08*h,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#000000",this.ctx.beginPath(),this.ctx.arc(n-l*.03*h,r-l*.42*h,2,0,Math.PI*2),this.ctx.arc(n+l*.03*h,r-l*.42*h,2,0,Math.PI*2),this.ctx.fill()),this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=4,this.ctx.beginPath(),o?(a!=null&&a.leftArm||(this.ctx.moveTo(n-l*.08*h,r-l*.1*h),this.ctx.lineTo(n-l*.15*h,r-l*.25*h)),a!=null&&a.rightArm||(this.ctx.moveTo(n+l*.08*h,r-l*.1*h),this.ctx.lineTo(n+l*.15*h,r-l*.25*h))):(a!=null&&a.leftArm||(this.ctx.moveTo(n-l*.08*h,r-l*.1*h),this.ctx.lineTo(n-l*.25*h,r-l*.05*h)),a!=null&&a.rightArm||(this.ctx.moveTo(n+l*.08*h,r-l*.1*h),this.ctx.lineTo(n+l*.25*h,r-l*.05*h))),this.ctx.stroke(),this.ctx.lineWidth=4,this.ctx.beginPath(),a!=null&&a.leftLeg||(this.ctx.moveTo(n-l*.05*h,r+l*.1*h),this.ctx.lineTo(n-l*.1*h,r+l*.3*h)),a!=null&&a.rightLeg||(this.ctx.moveTo(n+l*.05*h,r+l*.1*h),this.ctx.lineTo(n+l*.1*h,r+l*.3*h)),this.ctx.stroke()}if(i>.65){const h=Math.min((i-.65)*3,1);this.ctx.fillStyle="#FFD700",this.ctx.beginPath(),this.ctx.arc(n,r-l*.5*h,l*.02*h,0,Math.PI*2),this.ctx.fill()}if(i>.85){const h=Math.min((i-.85)*6,1);this.ctx.fillStyle="#FFD700";for(let u=0;u<8;u++){const f=u/8*Math.PI*2,x=n+Math.cos(f)*l*.7*h,p=r+l*.3+Math.sin(f)*l*.1*h;this.ctx.beginPath(),this.ctx.arc(x,p,l*.01*h,0,Math.PI*2),this.ctx.fill()}}this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=3,this.ctx.font="bold 16px Arial",this.ctx.textAlign="center";const d=`${Math.round(i*100)}%`;this.ctx.strokeText(d,n,r-l*.7),this.ctx.fillText(d,n,r-l*.7),o&&(this.ctx.fillStyle="#FF0000",this.ctx.font="bold 14px Arial",this.ctx.fillText("HANDS UP!",n,r-l*.8)),this.ctx.restore()}renderTheTemple(t,e,i,s,o){const a=t.x,n=t.y,r=e;if(this.ctx.save(),i>.1){this.ctx.fillStyle="#8B4513",this.ctx.fillRect(a-r*.8,n+r*.4,r*1.6,r*.15),this.ctx.strokeRect(a-r*.8,n+r*.4,r*1.6,r*.15),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=1;for(let d=0;d<8;d++)for(let h=0;h<3;h++){const u=a-r*.7+d*r*.2,f=n+r*.4+h*r*.05;this.ctx.strokeRect(u,f,r*.18,r*.04)}}if(i>.2){const d=r*.3*Math.min((i-.2)*2,1);this.ctx.fillStyle="#D2B48C",this.ctx.fillRect(a-r*.6,n+r*.25-d,r*1.2,d),this.ctx.strokeRect(a-r*.6,n+r*.25-d,r*1.2,d),this.ctx.strokeStyle="#B8860B",this.ctx.lineWidth=2;for(let h=0;h<6;h++){const u=n+r*.25-d+h*r*.05;this.ctx.beginPath(),this.ctx.moveTo(a-r*.6,u),this.ctx.lineTo(a+r*.6,u),this.ctx.stroke()}for(let h=0;h<5;h++){const u=a-r*.5+h*r*.25;this.ctx.beginPath(),this.ctx.moveTo(u,n+r*.25-d),this.ctx.lineTo(u,n+r*.25),this.ctx.stroke()}}if(i>.4){const d=Math.min((i-.4)*3,1);this.ctx.fillStyle="#000000",this.ctx.fillRect(a-r*.15*d,n+r*.25-r*.3*d,r*.3*d,r*.2*d),this.ctx.strokeStyle="#8B4513",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(a,n+r*.15-r*.3*d,r*.15*d,0,Math.PI),this.ctx.stroke()}if(i>.6&&!(o!=null&&o.leftWall)&&!(o!=null&&o.rightWall)){const d=r*.4*Math.min((i-.6)*2.5,1);this.ctx.fillStyle="#F5DEB3",this.ctx.fillRect(a-r*.5,n+r*.25-r*.3-d,r*1,d),this.ctx.strokeRect(a-r*.5,n+r*.25-r*.3-d,r*1,d),this.ctx.strokeStyle="#D2B48C",this.ctx.lineWidth=1;for(let h=0;h<5;h++){const u=n+r*.25-r*.3-d+h*r*.08;this.ctx.beginPath(),this.ctx.moveTo(a-r*.5,u),this.ctx.lineTo(a+r*.5,u),this.ctx.stroke()}for(let h=0;h<3;h++){const u=a-r*.3+h*r*.3,f=n+r*.25-r*.3-d*.5;this.ctx.fillStyle="#87CEEB",this.ctx.fillRect(u-r*.05,f-r*.08,r*.1,r*.16),this.ctx.strokeRect(u-r*.05,f-r*.08,r*.1,r*.16),this.ctx.strokeStyle="#8B4513",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(u,f-r*.08),this.ctx.lineTo(u,f+r*.08),this.ctx.moveTo(u-r*.05,f),this.ctx.lineTo(u+r*.05,f),this.ctx.stroke()}}if(i>.8&&!(o!=null&&o.roof)){const d=Math.min((i-.8)*5,1);this.ctx.fillStyle="#8B4513",this.ctx.beginPath(),this.ctx.moveTo(a,n-r*.4*d),this.ctx.lineTo(a-r*.5,n+r*.25-r*.3-r*.4*d),this.ctx.lineTo(a+r*.5,n+r*.25-r*.3-r*.4*d),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=1;for(let h=0;h<8;h++){const u=n-r*.4*d+h*r*.05*d,f=r*.5*(1-h/8)*d;this.ctx.beginPath(),this.ctx.moveTo(a-f,u),this.ctx.lineTo(a+f,u),this.ctx.stroke()}}if(i>.9){const d=Math.min((i-.9)*10,1);this.ctx.fillStyle="#FFD700",this.ctx.beginPath(),this.ctx.moveTo(a,n-r*.4),this.ctx.lineTo(a-r*.08*d,n-r*.7*d),this.ctx.lineTo(a+r*.08*d,n-r*.7*d),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#FFA500",this.ctx.beginPath(),this.ctx.arc(a,n-r*.7*d,r*.02*d,0,Math.PI*2),this.ctx.fill();for(let h=0;h<4;h++){const u=h/4*Math.PI*2,f=a+Math.cos(u)*r*.5,x=n+r*.25-r*.3-r*.4+Math.sin(u)*r*.1;this.ctx.fillStyle="#FFD700",this.ctx.beginPath(),this.ctx.moveTo(f,x),this.ctx.lineTo(f-r*.03*d,x-r*.15*d),this.ctx.lineTo(f+r*.03*d,x-r*.15*d),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}}if(i>=1){this.ctx.fillStyle="#FFD700";for(let d=0;d<12;d++){const h=d/12*Math.PI*2,u=a+Math.cos(h)*r*.8,f=n+r*.4+Math.sin(h)*r*.1;this.ctx.beginPath(),this.ctx.arc(u,f,r*.015,0,Math.PI*2),this.ctx.fill()}this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=2;for(let d=0;d<4;d++){const h=d/4*Math.PI*2,u=a+Math.cos(h)*r*.6,f=n+r*.25-r*.3-r*.4;this.ctx.beginPath(),this.ctx.moveTo(u,f),this.ctx.lineTo(u+Math.cos(h)*r*.2,f-r*.1),this.ctx.stroke()}}this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=3,this.ctx.font="bold 16px Arial",this.ctx.textAlign="center";const l=`${Math.round(i*100)}%`;this.ctx.strokeText(l,a,n-r*.9),this.ctx.fillText(l,a,n-r*.9),this.ctx.restore()}renderLandmarks(t,e){t.forEach(i=>{if(i.type==="trashFence"){if(!E(i.position,e,i.size))return}else if(!E(i.position,e))return;const s=P(i.position,e);switch(this.ctx.fillStyle=i.color,this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,i.type){case"man":const o=i.buildingProgress??0,a=i.size*Math.max(.1,o);i.ashesProgress&&i.ashesProgress>0?this.renderAshes(s,i.size,i.ashesProgress):i.isBonfire?this.renderBonfire(s,i.size):(i.isBurning&&this.renderFireEffects(s,i.size),i.fireworksActive&&this.renderFireworks(s,i.size),i.destructionProgress&&i.destructionProgress>0&&this.renderPixelFlames(s,i.size,i.destructionProgress),(o>0||i.isBurned)&&this.renderTheMan(s,a,o,i.isBurning||!1,i.handsUp||!1,i.pieces));break;case"temple":const n=i.buildingProgress??0,r=i.size*Math.max(.1,n);i.isBonfire?this.renderBonfire(s,i.size):(i.isBurning&&this.renderFireEffects(s,i.size),i.destructionProgress&&i.destructionProgress>0&&this.renderPixelFlames(s,i.size,i.destructionProgress),(n>0||i.isBurned)&&this.renderTheTemple(s,r,n,i.isBurning||!1,i.pieces));break;case"trashFence":const l=48,d=i.size;this.ctx.save(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255, 140, 0, 0.5)",this.ctx.lineWidth=6,this.ctx.setLineDash([8,6]),this.ctx.arc(s.x,s.y,d,0,Math.PI*2),this.ctx.stroke(),this.ctx.setLineDash([]);for(let h=0;h<l;h++){const u=h/l*Math.PI*2,f=s.x+Math.cos(u)*d,x=s.y+Math.sin(u)*d;this.ctx.fillStyle="#ff8c00",this.ctx.strokeStyle="#cc6f00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.rect(f-2,x-10,4,20),this.ctx.fill(),this.ctx.stroke()}this.ctx.restore();break;case"camp":if(i.id==="playa-camp"){const f=s.x-50,x=s.y-75/2;this.ctx.fillStyle="#f5deb3",this.ctx.fillRect(f,x,100,75),this.ctx.strokeStyle="#808080",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(f,x,100,75),this.ctx.setLineDash([]),this.ctx.fillStyle="#8b4513",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("BOOM BOOM WOMB",s.x,s.y-10),this.ctx.font="20px Arial",this.ctx.fillText("🏕️",s.x,s.y+10)}else if(i.id==="hell-station"){const f=s.x-40,x=s.y-60/2;this.ctx.fillStyle="#ff6b35",this.ctx.fillRect(f,x,80,60),this.ctx.strokeStyle="#e55a2b",this.ctx.lineWidth=3,this.ctx.strokeRect(f,x,80,60),this.ctx.font="24px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("⛽",s.x,s.y)}else if(i.id==="center-camp"){const f=s.x-50,x=s.y-80/2;this.ctx.fillStyle="#3498db",this.ctx.fillRect(f,x,100,80),this.ctx.strokeStyle="#2980b9",this.ctx.lineWidth=3,this.ctx.strokeRect(f,x,100,80),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("CENTER CAMP",s.x,s.y-10),this.ctx.font="16px Arial",this.ctx.fillText("🧊🍵",s.x,s.y+10)}else this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y-i.size/2),this.ctx.lineTo(s.x-i.size/2,s.y+i.size/2),this.ctx.lineTo(s.x+i.size/2,s.y+i.size/2),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke();break;case"artCar":this.renderArtCarSpawnPoint(s,i.size,this.mousePosition);break;case"restArea":this.renderRestArea(s,i.size,i.restAreaType||"center",i.color);break}})}renderRestArea(t,e,i,s){this.ctx.save();const o=Date.now()*.003,a=.3+Math.sin(o)*.2;switch(this.ctx.shadowColor=s,this.ctx.shadowBlur=20*a,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.fillStyle=s,this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=3,i){case"center":const n=e*1.5,r=e;this.drawRoundedRect(t.x-n/2,t.y-r/2,n,r,10),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("CENTER CAMP",t.x,t.y-5),this.ctx.font="10px Arial",this.ctx.fillText("2x Energy Recovery",t.x,t.y+8);break;case"teepee":this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y-e/2),this.ctx.lineTo(t.x-e/2,t.y+e/2),this.ctx.lineTo(t.x+e/2,t.y+e/2),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 10px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("DEEP PLAYA",t.x,t.y-15),this.ctx.font="8px Arial",this.ctx.fillText("TEEPEE",t.x,t.y-5),this.ctx.fillText("2x Energy",t.x,t.y+15);break;case"east":this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e/2,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#34495e",this.ctx.beginPath(),this.ctx.arc(t.x-15,t.y-10,3,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t.x+10,t.y+8,2,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 10px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("EAST REST",t.x,t.y-15),this.ctx.font="8px Arial",this.ctx.fillText("2x Energy",t.x,t.y+15);break;case"west":this.ctx.beginPath();for(let l=0;l<6;l++){const d=l/6*Math.PI*2,h=t.x+Math.cos(d)*e/2,u=t.y+Math.sin(d)*e/2;l===0?this.ctx.moveTo(h,u):this.ctx.lineTo(h,u)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#ffffff",this.ctx.font="16px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("🧘",t.x,t.y-5),this.ctx.font="bold 8px Arial",this.ctx.fillText("WEST REST",t.x,t.y+15);break}this.ctx.fillStyle="#FFD700",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillText("⚡",t.x,t.y+e/2+5),this.ctx.restore()}renderArtCarSpawnPoint(t,e,i){this.ctx.save(),this.ctx.translate(t.x,t.y);const s=i&&Math.abs(i.x-t.x)<e*1.5&&Math.abs(i.y-t.y)<e*1.5,o=Math.sin(Date.now()*.003)*.15+.85,a=s?Math.sin(Date.now()*.01)*.3+1:1,n=o*a,r=e*1.8*n,l=e*1.2*n;this.ctx.shadowBlur=s?40:25,this.ctx.shadowColor=s?"rgba(0, 255, 255, 1.0)":"rgba(0, 150, 255, 0.9)",this.ctx.fillStyle=s?"rgba(0, 200, 255, 0.7)":"rgba(0, 150, 255, 0.4)",this.ctx.beginPath(),this.ctx.save(),this.ctx.scale(1,l/r),this.ctx.arc(0,0,r/2,0,Math.PI*2),this.ctx.restore(),this.ctx.fill(),this.ctx.shadowBlur=0,this.ctx.strokeStyle="rgba(100, 200, 255, 0.8)",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.save(),this.ctx.scale(1,l/r),this.ctx.arc(0,0,r/2-5,0,Math.PI*2),this.ctx.restore(),this.ctx.stroke(),this.ctx.fillStyle=`rgba(50, 150, 255, ${.6*n})`,this.ctx.beginPath(),this.ctx.save(),this.ctx.scale(1,l/r),this.ctx.arc(0,0,r/3,0,Math.PI*2),this.ctx.restore(),this.ctx.fill();const d=Date.now()*.001,h=s?15:8;for(let f=0;f<h;f++){const x=f*.618,p=d+x,g=(p*(s?2:.5)+x*Math.PI*2)%(Math.PI*2),y=(Math.sin(p*.8+x)*.5+.5)*(r/4),S=Math.cos(g)*y,b=Math.sin(g)*y*.7,w=s?3+Math.sin(p*1.2+x)*2.5:2+Math.sin(p*1.2+x)*1.5,v=s?.6+Math.sin(p*.9+x)*.4:.3+Math.sin(p*.9+x)*.4,k=200+Math.sin(p*.3+x)*30;this.ctx.fillStyle=`hsla(${k}, 80%, 70%, ${v})`,this.ctx.beginPath(),this.ctx.arc(S,b,w,0,Math.PI*2),this.ctx.fill()}const u=Math.sin(d*2)*.2+.8;this.ctx.fillStyle=`rgba(150, 220, 255, ${.9*n*u})`,this.ctx.beginPath(),this.ctx.save(),this.ctx.scale(1,l/r),this.ctx.arc(0,0,r/8,0,Math.PI*2),this.ctx.restore(),this.ctx.fill(),this.ctx.restore()}renderHellStationAndArtCars(t,e,i,s,o,a,n,r){this.ctx.save(),t&&this.renderHellStation(t,s),this.ctx.font="16px system-ui, Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji",this.ctx.textAlign="center",this.ctx.textBaseline="middle";for(const d of e)if(!d.active&&this.isWithinVisibility(d.pos,o,a)){const h=P(d.pos,s);this.ctx.fillText("⛽",h.x,h.y)}const l=i.filter(d=>this.isWithinVisibility(d.pos,o,a)||d.id===r);this.renderArtCarsWithDesigns(l,s),this.renderArtCarGlow(l,s),this.renderPortopotties(n,o,a,s),this.ctx.restore()}renderPortopotties(t,e,i,s){this.ctx.save();for(const o of t)if(this.isWithinVisibility(o.position,e,i)){const a=P(o.position,s);this.ctx.shadowColor="#4a90e2",this.ctx.shadowBlur=20,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.font="40px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle="#ffffff",this.ctx.fillText("🚽",a.x,a.y),this.renderPortopottyLight(a),this.ctx.shadowColor="transparent",this.ctx.shadowBlur=0}this.ctx.restore()}renderPortopottyLight(t){this.ctx.save();const e=Date.now()*.002,i=(Math.sin(e)+1)/2;if(i>.3){const s=t.x,o=t.y-25;this.ctx.fillStyle=`rgba(74, 144, 226, ${i})`,this.ctx.fillRect(s-1.5,o-1.5,3,3),this.ctx.shadowColor="#4a90e2",this.ctx.shadowBlur=8*i,this.ctx.fillRect(s-1.5,o-1.5,3,3)}this.ctx.restore()}renderArtCarsWithDesigns(t,e){this.ctx.save();for(const i of t){const s=P(i.pos,e),o=i.size,a=60*o*e.zoom,n=30*o*e.zoom;i.design==="fire"?this.renderDragonBreathFire(s,o*e.zoom):i.design==="octopus"&&this.renderOctopusFireArms(s,o*e.zoom),this.renderCarBody(i,s,a,n),this.renderDesignDetails(i,s,a,n),this.renderWheels(s,a,n),this.renderHeadlights(s,a,n),this.renderNeonEffects(i,s,a,n),this.renderCarLabel(i,s,a,n),this.renderEnhancedFuelBar(i,s,a,n)}this.ctx.restore()}renderDragonBreathFire(t,e){const i=Date.now()*.01,s=t.x+25*e,o=t.y;for(let a=0;a<3;a++){const n=(a-1)*8,r=o+n;for(let l=0;l<5;l++){const d=s+l*8+Math.sin(i*3+l)*3,h=r+Math.sin(i*2+l)*2,u=(5-l)*e*.8,f=this.ctx.createRadialGradient(d,h,0,d,h,u);f.addColorStop(0,"#ffff00"),f.addColorStop(.3,"#ff6600"),f.addColorStop(.6,"#ff3300"),f.addColorStop(.8,"#cc0000"),f.addColorStop(1,"#660000"),this.ctx.fillStyle=f,this.ctx.globalAlpha=.9-l*.15,this.ctx.beginPath(),this.ctx.arc(d,h,u,0,Math.PI*2),this.ctx.fill()}}this.ctx.globalAlpha=1}renderOctopusFireArms(t,e){const i=Date.now()*.01;for(let s=0;s<8;s++){const o=s/8*Math.PI*2,a=t.x+Math.cos(o)*20*e,n=t.y+Math.sin(o)*20*e;for(let r=0;r<3;r++){const l=a+Math.cos(o)*r*8+Math.sin(i*2+s)*3,d=n+Math.sin(o)*r*8+Math.cos(i*2+s)*3,h=(3-r)*e*.6,u=this.ctx.createRadialGradient(l,d,0,l,d,h);u.addColorStop(0,"#ffff00"),u.addColorStop(.3,"#ff6600"),u.addColorStop(.6,"#ff3300"),u.addColorStop(.8,"#cc0000"),u.addColorStop(1,"#660000"),this.ctx.fillStyle=u,this.ctx.globalAlpha=.8-r*.2,this.ctx.beginPath(),this.ctx.arc(l,d,h,0,Math.PI*2),this.ctx.fill()}}this.ctx.globalAlpha=1}renderCarBody(t,e,i,s){switch(t.design){case"classic":this.renderClassicCar(e,i,s);break;case"fire":this.renderDragonCar(e,i,s);break;case"speedy":this.renderSpeedyCar(e,i,s);break;case"heavy":this.renderHeavyCar(e,i,s);break;case"compact":this.renderCompactCar(e,i,s);break;case"alien":this.renderAlienCar(e,i,s);break;case"davinci":this.renderDaVinciCar(e,i,s);break;case"octopus":this.renderOctopusCar(e,i,s);break}}renderClassicCar(t,e,i){const s=this.ctx.createLinearGradient(t.x-e/2,t.y-i/2,t.x+e/2,t.y+i/2);s.addColorStop(0,"#ffcc99"),s.addColorStop(.3,"#cc6600"),s.addColorStop(.7,"#996600"),s.addColorStop(1,"#663300"),this.ctx.fillStyle=s,this.ctx.fillRect(t.x-e/2,t.y-i/2,e,i),this.ctx.fillStyle="#8b4513",this.ctx.fillRect(t.x-e/2+5,t.y-i/2,e-10,i*.4),this.ctx.strokeStyle="#cccccc",this.ctx.lineWidth=2,this.ctx.strokeRect(t.x-e/2,t.y-i/2,e,i),this.ctx.fillStyle="#333333",this.ctx.fillRect(t.x-e/4,t.y+i/2-8,e/2,6);for(let o=0;o<5;o++)this.ctx.fillRect(t.x-e/4+o*e/10,t.y+i/2-6,2,2)}renderDragonCar(t,e,i){const s=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,e/2);s.addColorStop(0,"#ff6600"),s.addColorStop(.5,"#cc3300"),s.addColorStop(1,"#990000"),this.ctx.fillStyle=s,this.ctx.fillRect(t.x-e/2,t.y-i/2,e,i),this.ctx.fillStyle="#ff3300";for(let o=0;o<3;o++)for(let a=0;a<4;a++){const n=t.x-e/2+10+a*e/4,r=t.y-i/2+5+o*i/3;this.ctx.beginPath(),this.ctx.arc(n,r,4,0,Math.PI*2),this.ctx.fill()}this.ctx.fillStyle="#ff4500",this.ctx.beginPath(),this.ctx.ellipse(t.x+e/2-5,t.y,8,i/2,0,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#ffff00",this.ctx.beginPath(),this.ctx.arc(t.x+e/2-2,t.y-i/4,2,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t.x+e/2-2,t.y+i/4,2,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#cc0000";for(let o=0;o<3;o++){const a=t.x-e/2+5+o*e/3;this.ctx.beginPath(),this.ctx.moveTo(a,t.y-i/2),this.ctx.lineTo(a-3,t.y-i/2-8),this.ctx.lineTo(a+3,t.y-i/2-8),this.ctx.closePath(),this.ctx.fill()}}renderSpeedyCar(t,e,i){const s=this.ctx.createLinearGradient(t.x-e/2,t.y-i/2,t.x+e/2,t.y+i/2);s.addColorStop(0,"#66ff66"),s.addColorStop(.5,"#00cc00"),s.addColorStop(1,"#006600"),this.ctx.fillStyle=s,this.ctx.fillRect(t.x-e/2,t.y-i/2,e,i),this.ctx.fillStyle="#004400",this.ctx.fillRect(t.x-e/2+5,t.y-i/2-5,e-10,5),this.ctx.fillStyle="#333333",this.ctx.fillRect(t.x-e/2+3,t.y-i/4,8,4),this.ctx.fillRect(t.x+e/2-11,t.y-i/4,8,4),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.fillText("88",t.x,t.y+2)}renderHeavyCar(t,e,i){const s=this.ctx.createLinearGradient(t.x-e/2,t.y-i/2,t.x+e/2,t.y+i/2);s.addColorStop(0,"#a0522d"),s.addColorStop(.5,"#8b4513"),s.addColorStop(1,"#654321"),this.ctx.fillStyle=s,this.ctx.fillRect(t.x-e/2,t.y-i/2,e,i),this.ctx.fillStyle="#555555",this.ctx.fillRect(t.x-e/2,t.y-i/2-4,e,8),this.ctx.fillRect(t.x-e/2,t.y+i/2-4,e,8),this.ctx.fillRect(t.x-e/2-4,t.y-i/2,8,i),this.ctx.fillRect(t.x+e/2-4,t.y-i/2,8,i),this.ctx.fillStyle="#888888";for(let o=0;o<6;o++)for(let a=0;a<4;a++){const n=t.x-e/2+5+o*e/6,r=t.y-i/2+5+a*i/4;this.ctx.beginPath(),this.ctx.arc(n,r,1.5,0,Math.PI*2),this.ctx.fill()}this.ctx.fillStyle="#333333",this.ctx.fillRect(t.x+e/2-2,t.y-2,15,4)}renderCompactCar(t,e,i){const s=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,e/2);s.addColorStop(0,"#ffb3e6"),s.addColorStop(.7,"#ff69b4"),s.addColorStop(1,"#ff1493"),this.ctx.fillStyle=s,this.ctx.fillRect(t.x-e/2,t.y-i/2,e,i),this.ctx.fillStyle="#ff1493",this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y-i/4,e/2,i/3,0,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#ffff88",this.ctx.beginPath(),this.ctx.arc(t.x-e/3,t.y-i/4,4,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t.x+e/3,t.y-i/4,4,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#ff1493",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(t.x,t.y+i/4,6,0,Math.PI),this.ctx.stroke()}renderAlienCar(t,e,i){const s=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,e/2);s.addColorStop(0,"#00ff88"),s.addColorStop(.5,"#00cc66"),s.addColorStop(1,"#006644"),this.ctx.fillStyle=s,this.ctx.fillRect(t.x-e/2,t.y-i/2,e,i),this.ctx.fillStyle="#88ff88",this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y-i/4,e/3,i/4,0,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#ffffff";for(let o=0;o<3;o++)this.ctx.beginPath(),this.ctx.arc(t.x-e/3+o*e/3,t.y+i/3,3,0,Math.PI*2),this.ctx.fill();this.ctx.strokeStyle="#00ff88",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y-i/2),this.ctx.lineTo(t.x,t.y-i/2-10),this.ctx.stroke(),this.ctx.fillStyle="#ff0088",this.ctx.beginPath(),this.ctx.arc(t.x,t.y-i/2-10,3,0,Math.PI*2),this.ctx.fill()}renderDaVinciCar(t,e,i){const s=this.ctx.createLinearGradient(t.x-e/2,t.y-i/2,t.x+e/2,t.y+i/2);s.addColorStop(0,"#deb887"),s.addColorStop(.5,"#8b7355"),s.addColorStop(1,"#654321"),this.ctx.fillStyle=s,this.ctx.fillRect(t.x-e/2,t.y-i/2,e,i),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=2;for(let o=0;o<4;o++){const a=t.y-i/2+o*i/4;this.ctx.beginPath(),this.ctx.moveTo(t.x-e/2,a),this.ctx.lineTo(t.x+e/2,a),this.ctx.stroke()}this.ctx.fillStyle="#333333",this.ctx.fillRect(t.x-2,t.y-i/2-8,4,16),this.ctx.fillStyle="#666666";for(let o=0;o<8;o++){const a=o/8*Math.PI*2,n=t.x+Math.cos(a)*(e/2+5),r=t.y+Math.sin(a)*(i/2+5);this.ctx.beginPath(),this.ctx.arc(n,r,3,0,Math.PI*2),this.ctx.fill()}this.ctx.strokeStyle="#8b4513",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e/3,0,Math.PI*2),this.ctx.stroke()}renderOctopusCar(t,e,i){const s=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,e/2);s.addColorStop(0,"#ff6600"),s.addColorStop(.7,"#cc3300"),s.addColorStop(1,"#990000"),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y,e/2,i/2,0,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#ffffff",this.ctx.beginPath(),this.ctx.arc(t.x-e/6,t.y-i/6,4,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t.x+e/6,t.y-i/6,4,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#000000",this.ctx.beginPath(),this.ctx.arc(t.x-e/6,t.y-i/6,2,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t.x+e/6,t.y-i/6,2,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#cc3300";for(let o=0;o<8;o++){const a=o/8*Math.PI*2,n=t.x+Math.cos(a)*e/2,r=t.y+Math.sin(a)*i/2;this.ctx.beginPath(),this.ctx.arc(n,r,6,0,Math.PI*2),this.ctx.fill()}}renderWheels(t,e,i){const s=Math.min(e,i)*.15,o=t.y+i/2-s/2;this.renderWheel(t.x-e/3,o,s),this.renderWheel(t.x+e/3,o,s)}renderWheel(t,e,i){this.ctx.fillStyle="rgba(0, 0, 0, 0.3)",this.ctx.beginPath(),this.ctx.arc(t+1,e+1,i,0,Math.PI*2),this.ctx.fill();const s=this.ctx.createRadialGradient(t,e,0,t,e,i);s.addColorStop(0,"#666666"),s.addColorStop(.7,"#333333"),s.addColorStop(1,"#111111"),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(t,e,i,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#cccccc",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(t,e,i*.7,0,Math.PI*2),this.ctx.stroke()}renderHeadlights(t,e,i){const s=Math.min(e,i)*.1;this.renderGlowingLight(t.x-e/2+s,t.y-i/4,s,"#ffff88"),this.renderGlowingLight(t.x+e/2-s,t.y-i/4,s,"#ffff88")}renderGlowingLight(t,e,i,s){const o=this.ctx.createRadialGradient(t,e,0,t,e,i*3);o.addColorStop(0,s),o.addColorStop(.3,s+"80"),o.addColorStop(1,s+"00"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(t,e,i*3,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(t,e,i,0,Math.PI*2),this.ctx.fill()}renderNeonEffects(t,e,i,s){const o=Date.now()*.005,a=["#ff00ff","#00ffff","#ffff00","#ff6600"],n=a[Math.floor(o)%a.length];this.renderGlowingLine(e.x-i/2,e.y-s/2-2,e.x+i/2,e.y-s/2-2,n,3),this.renderGlowingLine(e.x-i/2,e.y+s/2+2,e.x+i/2,e.y+s/2+2,n,3)}renderGlowingLine(t,e,i,s,o,a){this.ctx.strokeStyle=o+"40",this.ctx.lineWidth=a*3,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke(),this.ctx.strokeStyle=o,this.ctx.lineWidth=a,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke()}renderCarLabel(t,e,i,s){const a={classic:"CLASSIC",fire:"FIRE DRAGON",speedy:"SPEED DEMON",heavy:"TANK",compact:"MINI",alien:"UFO",davinci:"DA VINCI",octopus:"FIRE OCTOPUS"}[t.design]||"ART CAR";this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(e.x-i/2,e.y+s/2+5,i,16),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 10px Arial",this.ctx.textAlign="center",this.ctx.fillText(a,e.x,e.y+s/2+15)}renderEnhancedFuelBar(t,e,i,s){const o=i*.8,a=6,n=t.fuelMax>0?t.fuel/t.fuelMax:0;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(e.x-o/2,e.y-s/2-15,o,a);const r=this.ctx.createLinearGradient(e.x-o/2,0,e.x+o/2,0);n<.25?(r.addColorStop(0,"#ff0000"),r.addColorStop(1,"#ff6600")):n<.5?(r.addColorStop(0,"#ffaa00"),r.addColorStop(1,"#ffff00")):(r.addColorStop(0,"#00ff00"),r.addColorStop(1,"#66ff66")),this.ctx.fillStyle=r,this.ctx.fillRect(e.x-o/2,e.y-s/2-15,o*n,a),this.ctx.shadowColor="#00ff00",this.ctx.shadowBlur=4,this.ctx.fillRect(e.x-o/2,e.y-s/2-15,o*n,a),this.ctx.shadowBlur=0}lightenColor(t,e){const i=parseInt(t.replace("#",""),16),s=Math.round(2.55*e),o=(i>>16)+s,a=(i>>8&255)+s,n=(i&255)+s;return"#"+(16777216+(o<255?o<1?0:o:255)*65536+(a<255?a<1?0:a:255)*256+(n<255?n<1?0:n:255)).toString(16).slice(1)}renderDesignDetails(t,e,i,s){switch(t.design){case"speedy":this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=3,this.ctx.shadowColor="#ffffff",this.ctx.shadowBlur=2,this.ctx.beginPath(),this.ctx.moveTo(e.x-i/2+5,e.y-s/4),this.ctx.lineTo(e.x+i/2-5,e.y-s/4),this.ctx.moveTo(e.x-i/2+5,e.y+s/4),this.ctx.lineTo(e.x+i/2-5,e.y+s/4),this.ctx.stroke(),this.ctx.shadowBlur=0;break;case"heavy":this.ctx.fillStyle="#333333",this.ctx.fillRect(e.x-i/2-2,e.y-s/2+2,4,s-4),this.ctx.fillRect(e.x+i/2-2,e.y-s/2+2,4,s-4);break;case"compact":this.ctx.fillStyle="#ffffff",this.ctx.shadowColor="#ffffff",this.ctx.shadowBlur=3,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y-s/2),this.ctx.lineTo(e.x,e.y-s/2-8),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y-s/2-8,2,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowBlur=0;break;case"fire":this.ctx.fillStyle="#cc0000",this.ctx.beginPath(),this.ctx.moveTo(e.x-i/4,e.y-s/2),this.ctx.lineTo(e.x-i/2-5,e.y-s/2-5),this.ctx.lineTo(e.x-i/4,e.y-s/2+5),this.ctx.closePath(),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(e.x+i/4,e.y-s/2),this.ctx.lineTo(e.x+i/2+5,e.y-s/2-5),this.ctx.lineTo(e.x+i/4,e.y-s/2+5),this.ctx.closePath(),this.ctx.fill();break;case"alien":this.ctx.strokeStyle="#00ff88",this.ctx.lineWidth=1,this.ctx.shadowColor="#00ff88",this.ctx.shadowBlur=2,this.ctx.beginPath(),this.ctx.moveTo(e.x-i/3,e.y+s/3),this.ctx.lineTo(e.x+i/3,e.y+s/3),this.ctx.moveTo(e.x-i/3,e.y-s/3),this.ctx.lineTo(e.x+i/3,e.y-s/3),this.ctx.stroke(),this.ctx.shadowBlur=0;break;case"davinci":this.ctx.strokeStyle="#8b4513",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(e.x-i/4,e.y+s/4,4,0,Math.PI*2),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(e.x+i/4,e.y+s/4,4,0,Math.PI*2),this.ctx.stroke();break;case"octopus":this.ctx.fillStyle="#ff3300";for(let o=0;o<8;o++){const a=o/8*Math.PI*2,n=e.x+Math.cos(a)*i/2,r=e.y+Math.sin(a)*s/2;this.ctx.beginPath(),this.ctx.arc(n,r,2,0,Math.PI*2),this.ctx.fill()}break}}isWithinVisibility(t,e,i){const s=t.x-e.x,o=t.y-e.y;return Math.sqrt(s*s+o*o)<=i}getVisibilityRadius(t){const e=at(t.time),i=t.dustStorm&&t.dustStorm.active,s=t.player.mountedOn!==null,o=t.weather;let a;i?a=240-t.dustStorm.intensity*120:e?a=1200:a=1500,o.type==="thunderstorm"?a*=.4+(1-o.intensity)*.2:o.type==="nice"?a*=1.2+o.intensity*.3:o.type==="overcast"&&(a*=.8+(1-o.intensity)*.2);const n=t.player.stats.lightBattery;if(n>0&&t.player.lightsOn){const r=t.player.isResting,l=n/100,d=r?.5*l:1*l;a*=1+d}return s?a*3:a}updateMousePosition(t){this.mousePosition=t}render(t,e,i,s,o,a,n,r,l,d,h,u,f,x,p,m,g){this.clear(s),l==="playa"&&this.renderBackgroundImage(e),l==="playa"?this.renderPlayaEffects(e):l==="camp"&&this.renderCampEffects(e),o&&this.renderLandmarks(o,e),l==="playa"&&(this.generateNPCs(),this.generateCamps(),this.updateNPCs(16),this.renderCamps(e),this.renderNPCs(e));const y=this.getVisibilityRadius(t);if(this.renderLightingEffects(t,e),l==="playa"&&t.hellStation&&t.gasCans&&t.artCars&&this.renderHellStationAndArtCars(t.hellStation,t.gasCans,t.artCars,e,t.player.position,y,t.portopotties,t.player.mountedOn),this.renderWeatherEffects(t,e),i){const b={minX:e.viewport.x,minY:e.viewport.y,maxX:e.viewport.x+e.viewport.width,maxY:e.viewport.y+e.viewport.height};Ae(i,b.minX,b.minY,b.maxX,b.maxY).entities.forEach(v=>{const k=t.coins.find(C=>C.id===v.id);k&&!k.collected&&this.isWithinVisibility(k.position,t.player.position,y)&&this.renderCoin(k.position,k.value,e)})}else t.coins.forEach(b=>{!b.collected&&this.isWithinVisibility(b.position,t.player.position,y)&&this.renderCoin(b.position,b.value,e)});if(d&&d.forEach(b=>{var w;!b.collected&&this.isWithinVisibility(b.position,t.player.position,y)&&this.renderCollectible(b.position,b.type,(w=b.data)==null?void 0:w.subtype,e,b.id,b==null?void 0:b.lightBulbType)}),h&&h.forEach(b=>{!b.collected&&this.isWithinVisibility(b.position,t.player.position,y)&&this.renderMoop(b,e)}),t.player.lightsOn){const b=["Light Bulb Red","Light Bulb Green","Light Bulb Blue","Light Bulb Orange","Light Bulb Purple","Light Bulb Rainbow","Light Bulb red","Light Bulb green","Light Bulb blue","Light Bulb orange","Light Bulb purple","Light Bulb rainbow"];for(const w of b)t.player.inventory.items.get(w)}if(u&&(l==="camp"||l==="playa")&&u.forEach(b=>{this.isWithinVisibility(b.position,t.player.position,y)&&this.renderCampMate(b,e)}),this.renderPlayer(t.player.position,e,t.player.isResting,t.player.stats.mood,!!t.player.mountedOn),this.renderEquippedItemEffects(t.player,e),t.player.mountedOn&&t.artCars){const b=t.artCars.find(w=>w.id===t.player.mountedOn);b&&this.renderMountedArtCarOnTop(b,e)}this.renderDrugEffects(t.player.position,e,t.player.drugs,t.time),this.renderFogOfWar(t,e),Array.from(t.player.inventory.items.entries()).some(([b,w])=>w>0&&(b.includes("Light Bulb")||b==="Battery"))&&t.player.lightsOn&&this.renderPlayerColoredLightEffects(t.player.position,e,t.player.inventory,t.player.isResting,t.time),this.renderHUD(t,e,a,n,r,f,x,p,m,g),this.renderNotifications(e)}renderDrugEffects(t,e,i,s){if(i&&i.active&&i.active.length>0,G(i,"molly")&&this.renderMollyHearts(t,e),G(i,"mda")&&this.renderMDAHearts(t,e),G(i,"mdma")&&this.renderMDMAHearts(t,e),G(i,"shrooms")&&this.renderShroomsColorShift(),G(i,"acid")&&this.renderAcidEffects(t,e),at(s)){const a=["acid","shrooms","salvia","dmt"].filter(n=>G(i,n));a.length>0&&(this.renderPsychedelicStars(t,e),a.length>=2&&this.renderAuroraBorealis(t,e))}G(i,"ketamine")&&this.renderKetamineTunnelVision(t,e),G(i,"whipits")&&this.renderWhipitsVignetting(e),G(i,"dmt")&&this.renderDMTEffects(t,e),(G(i,"cannabis")||G(i,"weed")||G(i,"joint"))&&this.renderCannabisEffects(t,e)}renderPsychedelicStars(t,e){const i=Date.now()*.001;this.ctx.save();const s=40,o=this.canvas.width/e.zoom,a=this.canvas.height/e.zoom,n=t.x-o/2,r=t.y-a/2,l=t.x+o/2,d=t.y+a/2;for(let h=Math.floor(n/s)*s;h<l;h+=s)for(let u=Math.floor(r/s)*s;u<d;u+=s){const f=P({x:h,y:u},e);if(f.x>=-10&&f.x<=this.canvas.width+10&&f.y>=-10&&f.y<=this.canvas.height+10){const x=Math.sin(h*.01)+Math.cos(u*.01),p=i+x*2,m=(p*30+x*100)%360,g=70+Math.sin(p*2+x)*30,y=50+Math.sin(p*1.5+x)*30,S=.4+Math.sin(p*3+x)*.3;this.ctx.fillStyle=`hsla(${m}, ${g}%, ${y}%, ${S})`;const b=Math.max(.5,1+Math.sin(p*2+x)*1.5);this.ctx.beginPath(),this.ctx.arc(f.x,f.y,b,0,Math.PI*2),this.ctx.fill(),Math.sin(p*1.5+x)>.7&&(this.ctx.shadowColor=`hsl(${m}, ${g}%, ${y}%)`,this.ctx.shadowBlur=3,this.ctx.beginPath(),this.ctx.arc(f.x,f.y,b*.5,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowBlur=0)}}this.ctx.restore()}renderAuroraBorealis(t,e){const i=Date.now()*.001;this.ctx.save();const s=4,o=this.canvas.width/e.zoom,a=this.canvas.height/e.zoom,n=t.x-o/2,r=t.y-a/2,l=t.x+o/2,d=t.y+a/2;for(let h=0;h<s;h++){const u=i+h*.5,f=80+h*40,x=.3-h*.05,p=3+h;for(let m=0;m<p;m++){const g=u+m*.3,y=r+m/p*(d-r)+Math.sin(g*.5)*50,S=this.ctx.createLinearGradient(0,0,0,f),b=[`hsla(${(120+m*30)%360}, 80%, 60%, ${x})`,`hsla(${(180+m*40)%360}, 70%, 50%, ${x*.8})`,`hsla(${(240+m*20)%360}, 90%, 70%, ${x*.6})`,`hsla(${(300+m*35)%360}, 85%, 65%, ${x*.4})`];S.addColorStop(0,b[0]),S.addColorStop(.3,b[1]),S.addColorStop(.6,b[2]),S.addColorStop(1,b[3]),this.ctx.fillStyle=S;const w=[],v=Math.floor((l-n)/20);for(let k=0;k<=v;k++){const C=n+k/v*(l-n),B=Math.sin(C*.01+g*.8)*30+Math.sin(C*.02+g*1.2)*15+Math.sin(C*.005+g*.3)*60,I=y+B;w.push({x:C,y:I})}this.ctx.beginPath(),this.ctx.moveTo(w[0].x,w[0].y);for(let k=1;k<w.length;k++){const C=(w[k-1].x+w[k].x)/2,B=w[k-1].y,I=(w[k-1].x+w[k].x)/2,A=w[k].y;this.ctx.bezierCurveTo(C,B,I,A,w[k].x,w[k].y)}for(let k=w.length-1;k>=0;k--){const C=w[k].x,B=w[k].y+f+Math.sin(C*.01+g*.8)*20;this.ctx.lineTo(C,B)}this.ctx.closePath(),this.ctx.fill();for(let k=0;k<w.length;k+=3)if(Math.sin(w[k].x*.01+g*2)>.8){const C=P({x:w[k].x,y:w[k].y},e);this.ctx.fillStyle=`hsla(${(120+m*30)%360}, 100%, 90%, 0.8)`,this.ctx.beginPath(),this.ctx.arc(C.x,C.y,1,0,Math.PI*2),this.ctx.fill()}}}this.ctx.restore()}renderMollyHearts(t,e){const i=P(t,e),s=Date.now()*.001;for(let o=0;o<8;o++){const a=o/8*Math.PI*2+s*.5,n=30+Math.sin(s*2+o)*10,r=i.x+Math.cos(a)*n,l=i.y+Math.sin(a)*n,d=(o*45+s*50)%360;this.ctx.fillStyle=`hsl(${d}, 100%, 70%)`,this.ctx.font="20px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("💖",r,l)}}renderMDAHearts(t,e){const i=P(t,e),s=Date.now()*.001;for(let o=0;o<4;o++){const a=o/4*Math.PI*2+s*.5,n=35+Math.sin(s*1.5+o)*8,r=i.x+Math.cos(a)*n,l=i.y+Math.sin(a)*n,d=.7+Math.sin(s*2+o)*.3;this.ctx.fillStyle=`rgba(255, ${Math.floor(192*d)}, ${Math.floor(203*d)}, 0.8)`,this.ctx.font="18px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("💕",r,l)}}renderMDMAHearts(t,e){const i=P(t,e),s=Date.now()*.001;for(let o=0;o<5;o++){const a=o/5*Math.PI*2+s*.4,n=40+Math.sin(s*1.8+o)*12,r=i.x+Math.cos(a)*n,l=i.y+Math.sin(a)*n,d=.6+Math.sin(s*1.5+o)*.4;this.ctx.fillStyle=`rgba(${Math.floor(128*d)}, 0, ${Math.floor(255*d)}, 0.9)`,this.ctx.font="22px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("💜",r,l)}}renderShroomsColorShift(){const t=Date.now()*.001,e=this.ctx.createRadialGradient(this.canvas.width/2,this.canvas.height/2,0,this.canvas.width/2,this.canvas.height/2,Math.max(this.canvas.width,this.canvas.height)/2),i=t*30%360,s=(t*30+120)%360,o=(t*30+240)%360;e.addColorStop(0,`hsla(${i}, 70%, 50%, 0.3)`),e.addColorStop(.5,`hsla(${s}, 70%, 50%, 0.2)`),e.addColorStop(1,`hsla(${o}, 70%, 50%, 0.3)`),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}renderAcidEffects(t,e){const i=Date.now()*.001,s=P(t,e);this.ctx.save();for(let a=0;a<3;a++){const n=i+a*.5;this.ctx.translate(s.x,s.y),this.ctx.rotate(n*.3+a*Math.PI/3);for(let r=0;r<8;r++){this.ctx.save(),this.ctx.rotate(r/8*Math.PI*2);const l=(n*100+r*45)%360;this.ctx.fillStyle=`hsla(${l}, 100%, 60%, 0.1)`,this.ctx.strokeStyle=`hsla(${l+60}, 100%, 70%, 0.2)`,this.ctx.lineWidth=2;const d=Math.floor(n+r)%3,h=50+Math.sin(n*2+r)*30;this.ctx.beginPath(),d===0?(this.ctx.moveTo(0,-h),this.ctx.lineTo(-h*.866,h*.5),this.ctx.lineTo(h*.866,h*.5),this.ctx.closePath()):d===1?this.ctx.rect(-h/2,-h/2,h,h):this.ctx.arc(0,0,h/2,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore()}this.ctx.setTransform(1,0,0,1,0,0)}const o=.1+Math.sin(i*3)*.05;this.ctx.fillStyle=`hsla(${i*50%360}, 100%, 50%, ${o})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}renderWhipitsBalloons(t,e){const i=P(t,e),s=Date.now()*.001;for(let o=0;o<6;o++){const a=o/6*Math.PI*2+s*.3,n=40+Math.sin(s*2+o)*15,r=i.x+Math.cos(a)*n,l=i.y+Math.sin(a)*n-Math.sin(s*3+o)*10,d="🎈";this.ctx.font="24px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(d,r,l),this.ctx.strokeStyle="#8b4513",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(r,l+12),this.ctx.lineTo(i.x,i.y+20),this.ctx.stroke()}}renderWhipitsVignetting(t){const e=this.canvas.width,i=this.canvas.height,s=e/2,o=i/2,a=Math.max(e,i)*.8,n=this.ctx.createRadialGradient(s,o,0,s,o,a);n.addColorStop(0,"rgba(0, 0, 0, 0)"),n.addColorStop(.6,"rgba(0, 0, 0, 0.3)"),n.addColorStop(.8,"rgba(20, 0, 0, 0.6)"),n.addColorStop(1,"rgba(40, 0, 0, 0.8)"),this.ctx.fillStyle=n,this.ctx.fillRect(0,0,e,i)}renderDMTEffects(t,e){const i=Date.now()*.001,s=P(t,e),o=this.canvas.width,a=this.canvas.height;this.ctx.save();for(let h=0;h<3;h++){const u=1+h*.5,f=2+h*1.5;for(let x=0;x<12;x++){const p=x/12*Math.PI*2+i*f,m=80+h*40+Math.sin(i*4+x+h)*30,g=s.x+Math.cos(p)*m,y=s.y+Math.sin(p)*m;this.ctx.save(),this.ctx.translate(g,y),this.ctx.rotate(i*f+x),this.ctx.scale(u,u);const S=(i*100+x*30+h*60)%360;this.ctx.fillStyle=`hsla(${S}, 100%, 60%, 0.4)`,this.ctx.strokeStyle=`hsla(${S+60}, 100%, 80%, 0.6)`,this.ctx.lineWidth=2,this.ctx.beginPath();for(let b=0;b<6;b++){const w=b/6*Math.PI*2,v=15+Math.sin(i*3+b)*8,k=Math.cos(w)*v,C=Math.sin(w)*v;b===0?this.ctx.moveTo(k,C):this.ctx.lineTo(k,C)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore()}}for(let h=0;h<8;h++){const u=h/8*Math.PI*2+i*1.5,f=60+Math.sin(i*2+h)*40,x=s.x+Math.cos(u)*f,p=s.y+Math.sin(u)*f,m=20+Math.sin(i*5+h)*15,g=.3+Math.sin(i*6+h)*.2,y=this.ctx.createRadialGradient(x,p,0,x,p,m);y.addColorStop(0,`rgba(255, 255, 255, ${g})`),y.addColorStop(.5,`rgba(255, 0, 255, ${g*.7})`),y.addColorStop(1,"rgba(0, 255, 255, 0)"),this.ctx.fillStyle=y,this.ctx.beginPath(),this.ctx.arc(x,p,m,0,Math.PI*2),this.ctx.fill()}const n=.4+Math.sin(i*3)*.3,r=this.ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,Math.max(o,a)*.8);r.addColorStop(0,`rgba(255, 0, 255, ${n*.4})`),r.addColorStop(.2,`rgba(0, 255, 255, ${n*.3})`),r.addColorStop(.4,`rgba(255, 255, 0, ${n*.3})`),r.addColorStop(.6,`rgba(255, 0, 128, ${n*.2})`),r.addColorStop(.8,`rgba(128, 0, 255, ${n*.2})`),r.addColorStop(1,`rgba(0, 128, 255, ${n*.1})`),this.ctx.fillStyle=r,this.ctx.fillRect(0,0,o,a);const l=i*200%360,d=.1+Math.sin(i*8)*.05;this.ctx.fillStyle=`hsla(${l}, 100%, 50%, ${d})`,this.ctx.fillRect(0,0,o,a);for(let h=0;h<16;h++){const u=h/16*Math.PI*2+i*2,f=200+Math.sin(i*3+h)*100,x=s.x+Math.cos(u)*f,p=s.y+Math.sin(u)*f,m=this.ctx.createLinearGradient(s.x,s.y,x,p);m.addColorStop(0,"rgba(255, 255, 255, 0.8)"),m.addColorStop(.5,"rgba(255, 0, 255, 0.4)"),m.addColorStop(1,"rgba(0, 255, 255, 0)"),this.ctx.strokeStyle=m,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y),this.ctx.lineTo(x,p),this.ctx.stroke()}this.ctx.restore()}renderCannabisEffects(t,e){const i=Date.now()*.001,s=P(t,e);this.ctx.save();for(let o=0;o<12;o++){const a=o/12*Math.PI*2+i*.3,n=40+Math.sin(i*1.5+o*.5)*20,r=s.x+Math.cos(a)*n,l=s.y+Math.sin(a)*n,d=3+Math.sin(i*2+o)*2,h=.6+Math.sin(i*1.5+o*.3)*.3,u=120+Math.sin(i+o)*20;this.ctx.fillStyle=`hsla(${u}, 70%, 60%, ${h})`,this.ctx.beginPath(),this.ctx.arc(r,l,d,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowColor=`hsl(${u}, 70%, 60%)`,this.ctx.shadowBlur=8,this.ctx.beginPath(),this.ctx.arc(r,l,d*.5,0,Math.PI*2),this.ctx.fill()}for(let o=0;o<6;o++){const a=o/6*Math.PI*2+i*.2,n=60+Math.sin(i*.8+o)*30,r=s.x+Math.cos(a)*n,l=s.y+Math.sin(a)*n,d=4+Math.sin(i*1.2+o)*2,h=.4+Math.sin(i*.9+o*.4)*.2;this.ctx.fillStyle=`hsla(120, 60%, 50%, ${h})`,this.ctx.shadowColor="transparent",this.ctx.save(),this.ctx.translate(r,l),this.ctx.rotate(a+i*.1),this.ctx.scale(1,.6),this.ctx.beginPath(),this.ctx.arc(0,0,d,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}this.ctx.restore()}renderKetamineTunnelVision(t,e){this.ctx.save();const i=this.ctx.canvas.width,s=this.ctx.canvas.height,o=t.x-e.position.x+i/2,a=t.y-e.position.y+s/2;if(!isFinite(o)||!isFinite(a)){this.ctx.restore();return}const n=this.ctx.createRadialGradient(o,a,0,o,a,200);n.addColorStop(0,"rgba(0, 0, 0, 0)"),n.addColorStop(.6,"rgba(0, 0, 0, 0.4)"),n.addColorStop(1,"rgba(0, 0, 0, 0.85)"),this.ctx.fillStyle=n,this.ctx.fillRect(0,0,i,s);const r=Date.now()*.001,l=.1+Math.sin(r*2)*.05,d=this.ctx.createRadialGradient(o,a,0,o,a,120);d.addColorStop(0,`rgba(0, 0, 0, ${l})`),d.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=d,this.ctx.fillRect(0,0,i,s),this.ctx.strokeStyle=`rgba(100, 100, 100, ${.1+Math.sin(r*3)*.05})`,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(o,a,140,0,Math.PI*2),this.ctx.stroke(),this.renderKetamineSpiralLasers(o,a,r*.5),this.ctx.restore()}renderKetamineSpiralLasers(t,e,i){for(let n=0;n<6;n++){const r=n/6*Math.PI*2+i,l=n/6*360+i*30;this.ctx.strokeStyle=`hsl(${l%360}, 100%, 60%)`,this.ctx.lineWidth=2,this.ctx.lineCap="round";const d=[],h=40;for(let u=0;u<h;u++){const f=u/h,x=r+f*2*Math.PI*2,p=f*60,m=t+Math.cos(x)*p,g=e+Math.sin(x)*p;d.push({x:m,y:g})}this.ctx.beginPath(),this.ctx.moveTo(d[0].x,d[0].y);for(let u=1;u<d.length;u++)this.ctx.lineTo(d[u].x,d[u].y);this.ctx.stroke(),this.ctx.strokeStyle=`hsla(${l%360}, 100%, 70%, 0.2)`,this.ctx.lineWidth=6,this.ctx.stroke()}}renderArtCarGlow(t,e){if(t){this.ctx.save();for(const i of t){const s=P(i.pos,e),o=40*i.size,a=this.ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,o);a.addColorStop(0,"rgba(255, 255, 255, 0.1)"),a.addColorStop(.5,"rgba(255, 255, 255, 0.05)"),a.addColorStop(1,"rgba(255, 255, 255, 0)"),this.ctx.fillStyle=a,this.ctx.fillRect(s.x-o,s.y-o,o*2,o*2)}this.ctx.restore()}}renderHellStation(t,e){const i=P({x:t.aabb.x,y:t.aabb.y},e),s={w:t.aabb.w*e.zoom,h:t.aabb.h*e.zoom},o=i.x+s.w/2,a=i.y+s.h/2,n=Date.now()*.001,r=this.ctx.createLinearGradient(i.x,i.y,i.x+s.w,i.y+s.h);r.addColorStop(0,"#2c2c2c"),r.addColorStop(.3,"#1a1a1a"),r.addColorStop(.7,"#333333"),r.addColorStop(1,"#2c2c2c"),this.ctx.fillStyle=r,this.ctx.fillRect(i.x,i.y,s.w,s.h),this.ctx.strokeStyle="#444444",this.ctx.lineWidth=3,this.ctx.strokeRect(i.x,i.y,s.w,s.h),this.ctx.fillStyle="#666666";const l=30;for(let C=i.x+15;C<i.x+s.w;C+=l)for(let B=i.y+15;B<i.y+s.h;B+=l)this.ctx.beginPath(),this.ctx.arc(C,B,2,0,Math.PI*2),this.ctx.fill();const d=s.w*.3,h=s.h*.8,u=o-d/2,f=a-h/2,x=this.ctx.createLinearGradient(u,f,u+d,f+h);x.addColorStop(0,"#8B4513"),x.addColorStop(.5,"#A0522D"),x.addColorStop(1,"#654321"),this.ctx.fillStyle=x,this.ctx.fillRect(u,f,d,h),this.ctx.strokeStyle="#444444",this.ctx.lineWidth=2;for(let C=0;C<4;C++){const B=f+h/4*C;this.ctx.beginPath(),this.ctx.moveTo(u,B),this.ctx.lineTo(u+d,B),this.ctx.stroke()}const p=s.w*.15,m=i.x+p+20,g=i.x+s.w-p-20,y=a,S=this.ctx.createRadialGradient(m,y,0,m,y,p);S.addColorStop(0,"#C0C0C0"),S.addColorStop(.7,"#808080"),S.addColorStop(1,"#404040"),this.ctx.fillStyle=S,this.ctx.beginPath(),this.ctx.arc(m,y,p,0,Math.PI*2),this.ctx.fill();const b=this.ctx.createRadialGradient(g,y,0,g,y,p);b.addColorStop(0,"#C0C0C0"),b.addColorStop(.7,"#808080"),b.addColorStop(1,"#404040"),this.ctx.fillStyle=b,this.ctx.beginPath(),this.ctx.arc(g,y,p,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#E0E0E0",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(m,y,p,0,Math.PI*2),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(g,y,p,0,Math.PI*2),this.ctx.stroke(),this.ctx.strokeStyle="#666666",this.ctx.lineWidth=8,this.ctx.beginPath(),this.ctx.moveTo(m+p,y),this.ctx.lineTo(u,a),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(g-p,y),this.ctx.lineTo(u+d,a),this.ctx.stroke();const w=6;for(let C=0;C<w;C++){const B=C/w*Math.PI*2,I=Math.min(s.w,s.h)*.4,A=o+Math.cos(B)*I,D=a+Math.sin(B)*I;this.ctx.fillStyle="#8B4513",this.ctx.fillRect(A-3,D-20,6,20);const F=.7+Math.sin(n*3+C)*.3,R=this.ctx.createRadialGradient(A,D-25,0,A,D-25,15);R.addColorStop(0,`rgba(255, 100, 0, ${F})`),R.addColorStop(.5,`rgba(255, 150, 0, ${F*.7})`),R.addColorStop(1,"rgba(255, 200, 0, 0)"),this.ctx.fillStyle=R,this.ctx.beginPath(),this.ctx.arc(A,D-25,15,0,Math.PI*2),this.ctx.fill()}const v=Math.sin(n*4)>0?1:.3;this.ctx.fillStyle=`rgba(255, 0, 0, ${v})`,this.ctx.beginPath(),this.ctx.arc(o,i.y+20,8,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="#FF6B35",this.ctx.font="bold 20px system-ui",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("HELL STATION",o,i.y-30),this.ctx.fillStyle="#FFB366",this.ctx.font="14px system-ui",this.ctx.fillText("Fuel & Fire",o,i.y-10);for(let C=0;C<3;C++){const B=o+Math.sin(n*.5+C)*20,I=i.y+10+Math.sin(n*2+C)*5,A=8+Math.sin(n*3+C)*4;this.ctx.fillStyle=`rgba(200, 200, 200, ${.3+Math.sin(n*2+C)*.2})`,this.ctx.beginPath(),this.ctx.arc(B,I,A,0,Math.PI*2),this.ctx.fill()}const k=this.ctx.createRadialGradient(o,a,0,o,a,Math.max(s.w,s.h)*.6);k.addColorStop(0,"rgba(255, 100, 50, 0.1)"),k.addColorStop(1,"rgba(255, 100, 50, 0)"),this.ctx.fillStyle=k,this.ctx.fillRect(i.x-50,i.y-50,s.w+100,s.h+100)}renderLightingEffects(t,e){this.ctx.canvas.width,this.ctx.canvas.height,P(t.player.position,e);const i=at(t.time);if(t.dustStorm&&t.dustStorm.active&&this.renderDustStorm(t.dustStorm,e),i&&t.artCars){const s=this.getVisibilityRadius(t),o=t.artCars.filter(a=>this.isWithinVisibility(a.pos,t.player.position,s)||a.id===t.player.mountedOn);this.renderArtCarAuras(o,e)}}renderDustStorm(t,e){const i=this.ctx.canvas.width,s=this.ctx.canvas.height,o=Date.now()*.001,a=t.intensity,n=a*.8;for(let l=0;l<200;l++){const d=Math.sin(o*.5+l*.1)*i*.5+i*.5,h=Math.cos(o*.3+l*.15)*s*.5+s*.5,u=2+Math.sin(o*2+l)*1,f=n*(.3+Math.sin(o*3+l)*.2);this.ctx.fillStyle=`rgba(255, 255, 255, ${f})`,this.ctx.beginPath(),this.ctx.arc(d,h,u,0,Math.PI*2),this.ctx.fill()}const r=a*.6;this.ctx.fillStyle=`rgba(255, 255, 255, ${r})`,this.ctx.fillRect(0,0,i,s);for(let l=0;l<50;l++){const d=(o*100+l*20)%(i+100)-50,h=s*.2+Math.sin(o*2+l)*s*.1,u=50+Math.sin(o*3+l)*20,f=n*.3;this.ctx.strokeStyle=`rgba(255, 255, 255, ${f})`,this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(d,h),this.ctx.lineTo(d+u,h),this.ctx.stroke()}}renderFogOfWar(t,e){const i=P(t.player.position,e),s=this.ctx.canvas.width,o=this.ctx.canvas.height,a=at(t.time),n=t.weather,r=["Light Bulb","Light Bulb White","Light Bulb white"];let l=0;if(t.player.lightsOn)for(const g of r){const y=t.player.inventory.items.get(g)||0;l+=y}let d=this.getVisibilityRadius(t);if(l>0){const g=l*50;d+=g}const h=this.ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,d),u=l>0;let f=1,x="rgba(0, 0, 0,";n.type==="thunderstorm"?(f=1.5+n.intensity*.8,x="rgba(15, 15, 30,"):n.type==="nice"?(f=.5+(1-n.intensity)*.3,x="rgba(0, 0, 0,"):n.type==="overcast"&&(f=.8+(1-n.intensity)*.4,x="rgba(30, 30, 30,"),a?u?(h.addColorStop(0,"rgba(0, 0, 0, 0)"),h.addColorStop(.5,`${x}${.05*f})`),h.addColorStop(.8,`${x}${.15*f})`),h.addColorStop(1,`${x}${.3*f})`)):(h.addColorStop(0,"rgba(0, 0, 0, 0)"),h.addColorStop(.3,`${x}${.1*f})`),h.addColorStop(.6,`${x}${.4*f})`),h.addColorStop(1,`${x}${.7*f})`)):u?(h.addColorStop(0,"rgba(0, 0, 0, 0)"),h.addColorStop(.6,`${x}${.02*f})`),h.addColorStop(.9,`${x}${.1*f})`),h.addColorStop(1,`${x}${.2*f})`)):(h.addColorStop(0,"rgba(0, 0, 0, 0)"),h.addColorStop(.5,"rgba(0, 0, 0, 0)"),h.addColorStop(.7,`${x}${.3*f})`),h.addColorStop(.85,`${x}${.6*f})`),h.addColorStop(1,`${x}${.8*f})`));let p,m;a?u?p=.4:p=.7:u?p=.05:p=.1,n.type==="thunderstorm"?m="rgba(20, 20, 40, 0.15)":n.type==="nice"?m=`rgba(0, 0, 0, ${p*f})`:n.type==="overcast"?m=`rgba(30, 30, 30, ${p*f})`:m=`rgba(0, 0, 0, ${p})`,this.ctx.fillStyle=m,this.ctx.fillRect(0,0,s,o),this.ctx.fillStyle=h,this.ctx.fillRect(0,0,s,o)}renderColoredLightBulb(t,e,i){this.ctx.save();const s=Date.now()*8e-4;let o,a,n;switch(i){case"light-bulb-white":o="rgba(255, 255, 255, 0.8)",a="rgba(255, 255, 255, 0.6)",n="rgba(255, 255, 255, 0.4)";break;case"light-bulb-red":o="rgba(255, 100, 100, 0.8)",a="rgba(255, 50, 50, 0.6)",n="rgba(255, 0, 0, 0.4)";break;case"light-bulb-green":o="rgba(100, 255, 100, 0.8)",a="rgba(50, 255, 50, 0.6)",n="rgba(0, 255, 0, 0.4)";break;case"light-bulb-blue":o="rgba(100, 100, 255, 0.8)",a="rgba(50, 50, 255, 0.6)",n="rgba(0, 0, 255, 0.4)";break;case"light-bulb-orange":o="rgba(255, 165, 100, 0.8)",a="rgba(255, 140, 50, 0.6)",n="rgba(255, 165, 0, 0.4)";break;case"light-bulb-purple":o="rgba(200, 100, 255, 0.8)",a="rgba(150, 50, 255, 0.6)",n="rgba(128, 0, 255, 0.4)";break;case"light-bulb-rainbow":const d=s*60%360,h=(d+60)%360,u=(h+60)%360;o=`hsla(${d}, 100%, 70%, 0.8)`,a=`hsla(${h}, 100%, 60%, 0.6)`,n=`hsla(${u}, 100%, 50%, 0.4)`;break;default:o="rgba(255, 255, 255, 0.8)",a="rgba(255, 255, 255, 0.6)",n="rgba(255, 255, 255, 0.4)"}const r=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,e*2);r.addColorStop(0,o),r.addColorStop(.5,a),r.addColorStop(1,n),this.ctx.fillStyle=r,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e*2,0,Math.PI*2),this.ctx.fill();const l=.8+Math.sin(s*4)*.2;this.ctx.fillStyle=`rgba(255, 255, 255, ${l})`,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e*.3,0,Math.PI*2),this.ctx.fill(),this.ctx.font=`${e}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("💡",t.x,t.y),this.ctx.restore()}renderRainbowLightBulb(t,e){this.ctx.save();const i=Date.now()*8e-4,s=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,e*2),o=i*60%360,a=(o+60)%360,n=(a+60)%360;s.addColorStop(0,`hsl(${o}, 100%, 70%)`),s.addColorStop(.5,`hsl(${a}, 100%, 60%)`),s.addColorStop(1,`hsl(${n}, 100%, 50%)`),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e*2,0,Math.PI*2),this.ctx.fill();const r=.8+Math.sin(i*4)*.2;this.ctx.fillStyle=`rgba(255, 255, 255, ${r})`,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e*.3,0,Math.PI*2),this.ctx.fill(),this.ctx.font=`${e}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("💡",t.x,t.y),this.ctx.restore()}renderPlayerLightEffect(t,e,i,s){this.ctx.save();const o=Date.now()*5e-4,a=P(t,e),r=(s?40:80)+i*(s?10:20),l=this.ctx.createRadialGradient(a.x,a.y,0,a.x,a.y,r),d=o*40%360,h=(d+120)%360;l.addColorStop(0,"rgba(255, 255, 255, 0)"),l.addColorStop(.3,`hsla(${d}, 80%, 60%, 0.3)`),l.addColorStop(.7,`hsla(${h}, 80%, 50%, 0.3)`),l.addColorStop(1,"rgba(255, 255, 255, 0)"),this.ctx.fillStyle=l,this.ctx.beginPath(),this.ctx.arc(a.x,a.y,80+i*20,0,Math.PI*2),this.ctx.fill();for(let u=0;u<i*3;u++){const f=(o*2+u*(360/(i*3)))%360,x=60+Math.sin(o*3+u)*10,p=a.x+Math.cos(f*Math.PI/180)*x,m=a.y+Math.sin(f*Math.PI/180)*x,g=(d+u*30)%360;this.ctx.fillStyle=`hsla(${g}, 100%, 70%, 0.3)`,this.ctx.beginPath(),this.ctx.arc(p,m,2,0,Math.PI*2),this.ctx.fill()}this.ctx.restore()}renderPlayerColoredLightEffects(t,e,i,s,o){this.ctx.save();const a=this.ctx.globalCompositeOperation;this.ctx.globalCompositeOperation="screen";const n=P(t,e),r=Date.now()*5e-4,l=["Light Bulb","Light Bulb White","Light Bulb Red","Light Bulb Green","Light Bulb Blue","Light Bulb Orange","Light Bulb Purple","Light Bulb Rainbow","Light Bulb red","Light Bulb green","Light Bulb blue","Light Bulb orange","Light Bulb purple","Light Bulb rainbow"];let d=0;const h={};for(const f of l){const x=i.items.get(f)||0;x>0&&(h[f]=x,d+=x)}if(d===0){this.ctx.globalCompositeOperation=a,this.ctx.restore();return}o&&o.hour;let u=0;for(const[f,x]of Object.entries(h)){if(x===0)continue;const m=(s?40:80)+u*(s?20:30),g=this.ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,m);let y,S,b;switch(f){case"Light Bulb":case"Light Bulb White":y="rgba(255, 255, 255, 0)",S=`rgba(240, 240, 240, ${Math.min(.15,.05+u*.02)})`,b=`rgba(220, 220, 220, ${Math.min(.1,.03+u*.01)})`;break;case"Light Bulb Red":y="rgba(255, 100, 100, 0)",S=`rgba(255, 50, 50, ${Math.min(.12,.04+u*.02)})`,b=`rgba(255, 0, 0, ${Math.min(.08,.02+u*.01)})`;break;case"Light Bulb Green":y="rgba(100, 255, 100, 0)",S=`rgba(50, 255, 50, ${Math.min(.12,.04+u*.02)})`,b=`rgba(0, 255, 0, ${Math.min(.08,.02+u*.01)})`;break;case"Light Bulb Blue":y="rgba(100, 100, 255, 0)",S=`rgba(50, 50, 255, ${Math.min(.12,.04+u*.02)})`,b=`rgba(0, 0, 255, ${Math.min(.08,.02+u*.01)})`;break;case"Light Bulb Orange":y="rgba(255, 165, 0, 0)",S=`rgba(255, 140, 0, ${Math.min(.12,.04+u*.02)})`,b=`rgba(255, 100, 0, ${Math.min(.08,.02+u*.01)})`;break;case"Light Bulb Purple":y="rgba(200, 100, 255, 0)",S=`rgba(150, 50, 200, ${Math.min(.12,.04+u*.02)})`,b=`rgba(100, 0, 150, ${Math.min(.08,.02+u*.01)})`;break;case"Light Bulb Rainbow":case"Light Bulb rainbow":const w=r*40%360,v=(w+60)%360,k=(v+60)%360;y=`hsla(${w}, 100%, 70%, 0)`,S=`hsla(${v}, 100%, 60%, ${Math.min(.12,.04+u*.02)})`,b=`hsla(${k}, 100%, 50%, ${Math.min(.08,.02+u*.01)})`;break;case"Light Bulb red":y="rgba(255, 100, 100, 0.3)",S="rgba(255, 50, 50, 0.2)",b="rgba(255, 0, 0, 0.1)";break;case"Light Bulb green":y="rgba(100, 255, 100, 0.3)",S="rgba(50, 255, 50, 0.2)",b="rgba(0, 255, 0, 0.1)";break;case"Light Bulb blue":y="rgba(100, 100, 255, 0.3)",S="rgba(50, 50, 255, 0.2)",b="rgba(0, 0, 255, 0.1)";break;case"Light Bulb orange":y="rgba(255, 165, 0, 0.3)",S="rgba(255, 140, 0, 0.2)",b="rgba(255, 100, 0, 0.1)";break;case"Light Bulb purple":y="rgba(200, 100, 255, 0.3)",S="rgba(150, 50, 200, 0.2)",b="rgba(100, 0, 150, 0.1)";break;default:y="rgba(255, 255, 255, 0.4)",S="rgba(255, 255, 255, 0.3)",b="rgba(255, 255, 255, 0.2)"}g.addColorStop(0,y),g.addColorStop(.65,S),g.addColorStop(1,b),this.ctx.fillStyle=g,this.ctx.beginPath(),this.ctx.arc(n.x,n.y,m,0,Math.PI*2),this.ctx.fill();for(let w=0;w<x;w++){const v=(r*2+w*(360/x))%360,k=80+Math.sin(r*3+w)*20,C=n.x+Math.cos(v*Math.PI/180)*k,B=n.y+Math.sin(v*Math.PI/180)*k;if(f==="Light Bulb Rainbow"||f==="Light Bulb rainbow"){const A=(r*40+w*30)%360;this.ctx.fillStyle=`hsla(${A}, 100%, 80%, 0.3)`}else this.ctx.fillStyle=y.replace(/[\d.]+\)/,"0.3)");const I=4+Math.sin(r*4+w)*2;this.ctx.beginPath(),this.ctx.arc(C,B,I,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowColor=this.ctx.fillStyle,this.ctx.shadowBlur=4,this.ctx.beginPath(),this.ctx.arc(C,B,I*.5,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowBlur=0}u++}this.ctx.globalCompositeOperation=a,this.ctx.restore()}renderMountedArtCarOnTop(t,e){this.ctx.save(),this.renderArtCarsWithDesigns([t],e),this.renderArtCarGlow([t],e),this.ctx.restore()}renderArtCarAuras(t,e){if(!t)return;const i=Date.now()*.001;for(const s of t){const o=P(s.pos,e),a=80*s.size,n=.6+Math.sin(i*2+s.id.charCodeAt(0))*.3,r=this.ctx.createRadialGradient(o.x,o.y,0,o.x,o.y,a);let l="#FFD700";switch(s.design){case"fire":l="#FF4500";break;case"alien":l="#00FF00";break;case"davinci":l="#8B4513";break;case"octopus":l="#FF69B4";break;case"heavy":l="#C0C0C0";break;case"speedy":l="#00BFFF";break;case"compact":l="#FFA500";break;case"classic":l="#FFD700";break}const d=parseInt(l.slice(1,3),16),h=parseInt(l.slice(3,5),16),u=parseInt(l.slice(5,7),16);r.addColorStop(0,`rgba(${d}, ${h}, ${u}, ${n*.6})`),r.addColorStop(.5,`rgba(${d}, ${h}, ${u}, ${n*.3})`),r.addColorStop(1,`rgba(${d}, ${h}, ${u}, 0)`),this.ctx.fillStyle=r,this.ctx.fillRect(o.x-a,o.y-a,a*2,a*2);for(let f=0;f<5;f++){const x=(i*2+f*Math.PI*2/5)%(Math.PI*2),p=a*.8,m=o.x+Math.cos(x)*p,g=o.y+Math.sin(x)*p,y=2+Math.sin(i*4+f)*1,S=n*1;this.ctx.fillStyle=`rgba(${d}, ${h}, ${u}, ${S})`,this.ctx.beginPath(),this.ctx.arc(m,g,y,0,Math.PI*2),this.ctx.fill()}}}renderWeatherEffects(t,e){const i=t.weather;!i||i.duration<=0||(this.ctx.save(),i.type==="thunderstorm"&&this.renderThunderstormEffects(i,e),this.ctx.restore())}renderThunderstormEffects(t,e){const i=Date.now()*.001,s=this.canvas.width,o=this.canvas.height,a=t.intensity;this.updateAndRenderRain(a,i,s,o),this.updateAndRenderLightning(a,i,s,o)}clearThunderstormEffects(){this.rainDrops=[],this.lightningBolts=[]}updateAndRenderRain(t,e,i,s){const o=Math.floor(5+t*10);for(let a=0;a<o;a++){const n=Math.random()*10,r=`rgb(${Math.floor(150-n*8)}, ${Math.floor(150-n*8)}, ${Math.floor(150-n*8)})`;this.rainDrops.push({x:Math.random()*i,y:-50,speed:n,color:r,size:Math.floor(Math.random()*20+3)})}this.ctx.lineWidth=1;for(let a=this.rainDrops.length-1;a>=0;a--){const n=this.rainDrops[a];if(n.y+=15+n.speed,n.y>s+10){this.rainDrops.splice(a,1);continue}this.ctx.strokeStyle=n.color,this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(n.x,n.y+n.size),this.ctx.stroke()}}updateAndRenderLightning(t,e,i,s){const o=t*.15;Math.random()<o&&this.lightningBolts.push({branches:[this.createLightningBranch(i,s,t,0)],opacity:1,opacityDecay:.05-Math.random()/30});for(let a=this.lightningBolts.length-1;a>=0;a--){const n=this.lightningBolts[a];this.ctx.strokeStyle=`rgba(255, 255, 255, ${n.opacity})`,this.ctx.fillStyle=this.ctx.strokeStyle;let r=!0;for(const l of n.branches)this.renderLightningBranch(l)||(r=!1);r&&(n.opacity-=n.opacityDecay),n.opacity<=0&&this.lightningBolts.splice(a,1)}}createLightningBranch(t,e,i,s=0){const o=Math.random()*t,a=-50,n=Math.max(1,5-s);return{path:[{x:o,y:a,endX:(.5-Math.random())*(e/10)+o,endY:(.7-Math.random())*(t/20)+a}],size:parseInt(n.toString())+parseInt((Math.random()*10).toString()),subBranches:[],chance:n,canvasWidth:t,canvasHeight:e,depth:s}}renderLightningBranch(t){let e=!0;if(t.path.length<t.size){for(let i=0;i<3;i++){const s=t.path[t.path.length-1];t.path.push({x:s.endX,y:s.endY,endX:(.5-Math.random())*(t.canvasHeight/10)+s.endX,endY:Math.random()*(t.canvasWidth/30)+s.endY}),Math.random()<t.chance/10&&t.depth<3&&t.subBranches.push(this.createLightningBranch(t.canvasWidth,t.canvasHeight,t.chance/2,t.depth+1))}e=!1}for(let i=0;i<t.path.length;i++){const s=t.path[i];this.ctx.lineWidth=t.chance*.2,this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y),this.ctx.lineTo(s.endX,s.endY),this.ctx.stroke()}for(let i=0;i<t.subBranches.length;i++)this.renderLightningBranch(t.subBranches[i]);return e}renderAdvancedLightningBolt(t,e,i){const s=Math.random()*t,o=-50;new mt(this.ctx,i,s,o,t,e).process()}}class mt{constructor(t,e,i,s,o,a){M(this,"ctx");M(this,"intensity");M(this,"startX");M(this,"startY");M(this,"canvasWidth");M(this,"canvasHeight");M(this,"path");M(this,"size");M(this,"subBranches");this.ctx=t,this.intensity=e,this.startX=i,this.startY=s,this.canvasWidth=o,this.canvasHeight=a,this.path=[{x:i,y:s,endX:(.5-Math.random())*(a/10)+i,endY:(.7-Math.random())*(o/20)+s}],this.size=Math.floor(e*10)+Math.floor(Math.random()*10),this.subBranches=[]}process(){let t=!0;if(this.path.length<this.size){for(let e=0;e<3;e++){const i=this.path[this.path.length-1];if(this.path.push({x:i.endX,y:i.endY,endX:(.5-Math.random())*(this.canvasHeight/10)+i.endX,endY:Math.random()*(this.canvasWidth/30)+i.endY}),Math.random()<this.intensity/10){const s=this.path[this.path.length-1];this.subBranches.push(new mt(this.ctx,this.intensity/2,s.x,s.y,this.canvasWidth,this.canvasHeight))}}t=!1}this.ctx.strokeStyle=`rgba(255, 255, 255, ${.8+this.intensity*.2})`,this.ctx.lineWidth=this.intensity*.2+1,this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let e=0;e<this.path.length;e++)this.ctx.beginPath(),this.ctx.moveTo(this.path[e].x,this.path[e].y),this.ctx.lineTo(this.path[e].endX,this.path[e].endY),this.ctx.stroke();for(let e=0;e<this.subBranches.length;e++)this.subBranches[e].process();return t}}class di{constructor(){M(this,"inputState");this.inputState={keys:new Set,keyPressed:new Set,mouseX:0,mouseY:0,mouseClicked:!1},this.setupEventListeners()}setupEventListeners(){document.addEventListener("keydown",t=>{const e=t.key.toLowerCase();this.inputState.keys.has(e)||this.inputState.keyPressed.add(e),this.inputState.keys.add(e)}),document.addEventListener("keyup",t=>{const e=t.key.toLowerCase();this.inputState.keys.delete(e),this.inputState.keyPressed.delete(e)}),document.addEventListener("mousemove",t=>{this.inputState.mouseX=t.clientX,this.inputState.mouseY=t.clientY}),document.addEventListener("mousedown",t=>{this.inputState.mouseClicked=!0})}getMovementDirection(){const{keys:t}=this.inputState;return t.has("w")&&t.has("a")||t.has("w")&&t.has("d")?"up":t.has("s")&&t.has("a")||t.has("s")&&t.has("d")?"down":t.has("w")||t.has("arrowup")?"up":t.has("s")||t.has("arrowdown")?"down":t.has("a")||t.has("arrowleft")?"left":t.has("d")||t.has("arrowright")?"right":null}isKeyPressed(t){return this.inputState.keys.has(t.toLowerCase())}getPressedKeys(){return Array.from(this.inputState.keys)}isRestKeyPressed(){return this.inputState.keyPressed.has("r")}isGiftKeyPressed(){return this.inputState.keyPressed.has("g")}isTotemTogglePressed(){return this.inputState.keyPressed.has("t")}isLightsKeyPressed(){return this.inputState.keyPressed.has("l")}isMuteKeyPressed(){return this.inputState.keyPressed.has("m")}isEscapeKeyPressed(){return this.inputState.keyPressed.has("escape")}isSpaceKeyPressed(){return this.inputState.keyPressed.has(" ")}isKeyJustPressed(t){return this.inputState.keyPressed.has(t.toLowerCase())}isAnyKeyPressed(){return this.inputState.keyPressed.size>0}clearKeyPressed(){this.inputState.keyPressed.clear()}getMousePosition(){return{x:this.inputState.mouseX,y:this.inputState.mouseY}}isMouseClicked(){return this.inputState.mouseClicked}clearMouseClicked(){this.inputState.mouseClicked=!1}}class ui{constructor(t,e,i,s,o,a){M(this,"gameState");M(this,"spatialIndex");M(this,"camera");M(this,"renderer");M(this,"inputHandler");M(this,"clock");M(this,"rng");M(this,"audio");M(this,"worldManager");M(this,"config");M(this,"canvas");M(this,"lastTime",0);M(this,"animationId",null);M(this,"lastPlayerPosition",null);M(this,"actionSystem");M(this,"isPaused",!1);M(this,"lastLightDropTime",0);M(this,"lastMoopDropTime",0);M(this,"achievements",new Set);M(this,"totalMoopCollected",0);M(this,"totalDrugsTaken",0);M(this,"awards",[...pe]);M(this,"coinChangeHistory",[]);M(this,"karmaChangeHistory",[]);M(this,"lastCoinAmount",0);M(this,"lastKarmaAmount",0);M(this,"debugMenuOverlay",null);M(this,"lastStatWarningTime",0);M(this,"statWarningCooldown",5e3);M(this,"dialogueOverlay",null);M(this,"lastLightSystemLogTime",0);M(this,"campMates",[]);M(this,"lastDialogueCloseTime",0);M(this,"wombatsAtCamp",50);M(this,"wombatsOnPlaya",0);M(this,"performanceCache",{lastDistanceCalculation:null,lastWorldId:null,lastTimeScale:null});M(this,"tick",()=>{const t=this.clock.now(),e=(t-this.lastTime)/1e3;this.lastTime=t,this.update(e),this.render(),this.animationId=this.clock.requestAnimationFrame(this.tick)});this.canvas=t,this.clock=e,this.rng=i,this.audio=s,this.worldManager=o,this.config=a,this.renderer=new hi(t,{canvasWidth:a.canvasWidth,canvasHeight:a.canvasHeight,playerSize:a.playerSize}),this.inputHandler=new di,this.spatialIndex=nt(a.canvasWidth*2,a.canvasHeight*2,100),this.camera=ci({viewportWidth:a.canvasWidth,viewportHeight:a.canvasHeight,zoom:1,followSpeed:250,worldBounds:{minX:0,minY:0,maxX:1600,maxY:1200}}),this.initializeGameState()}initializeGameState(){this.worldManager.getCurrentWorld();const t=this.worldManager.getCurrentWorldDimensions(),e=T(800,600);console.log("🔋 Initializing game state with lightBattery: 0"),this.gameState={player:{position:e,stats:{coins:0,energy:100,mood:100,thirst:0,hunger:0,karma:0,speed:100,lightBattery:0,bathroom:0},drugs:{active:[],maxStack:5},inventory:(()=>{const i=oe();return H(i,"Water",3),H(i,"Grilled Cheese",1),H(i,"Energy Bar",1),H(i,"Totem",1),i})(),isResting:!1,lightsOn:!1,equippedItem:void 0,totalDrugsTaken:0,totalTimeOnDrugs:0,gameStartTime:Date.now(),actualPlayTime:0,achievements:new Set,totalDistanceTraveled:0,lastPosition:e,moodStreakHigh:0,moodStreakLow:0,lastMoodValue:100,lastMoodTime:Date.now(),balancedStatsTime:0,totalItemsGifted:0,totalKarmaGifted:0,totemUsedDuringManBurn:!1},seed:this.config.seed,time:de(),gameEnded:!1,weather:{type:"clear",intensity:0,duration:0,startTime:0},dustStorm:{active:!1,intensity:0,duration:0,startTime:0},coins:[],moop:[],hellStation:{id:"hell-station-main",aabb:{x:800,y:400,w:400,h:400},spawnIntervalMs:4e3,maxCans:6,lastSpawnAt:0},gasCans:[],artCars:[et(this.rng,{x:1600,y:1200}),et(this.rng,{x:2400,y:2e3}),et(this.rng,{x:1800,y:800}),et(this.rng,{x:2200,y:1600}),et(this.rng,{x:1400,y:1800})],portopotties:[{id:"porto-1",position:{x:1e3,y:500},aabb:{x:1e3,y:500,w:120,h:120},used:!1},{id:"porto-2",position:{x:1500,y:800},aabb:{x:1500,y:800,w:120,h:120},used:!1},{id:"porto-3",position:{x:2e3,y:1200},aabb:{x:2e3,y:1200,w:120,h:120},used:!1},{id:"porto-4",position:{x:1100,y:1650},aabb:{x:1100,y:1650,w:120,h:120},used:!1},{id:"porto-5",position:{x:1800,y:1800},aabb:{x:1800,y:1800,w:120,h:120},used:!1},{id:"porto-6",position:{x:800,y:1e3},aabb:{x:800,y:1e3,w:120,h:120},used:!1},{id:"porto-7",position:{x:2200,y:600},aabb:{x:2200,y:600,w:120,h:120},used:!1},{id:"porto-8",position:{x:1400,y:2e3},aabb:{x:1400,y:2e3,w:120,h:120},used:!1},{id:"porto-9",position:{x:2600,y:1400},aabb:{x:2600,y:1400,w:120,h:120},used:!1},{id:"porto-10",position:{x:900,y:1700},aabb:{x:900,y:1700,w:120,h:120},used:!1}]},this.rng.setSeed(this.config.seed),this.spatialIndex=nt(t.width,t.height,100),this.loadCoinsForCurrentWorld(),console.log("🔋 Game state initialized, lightBattery:",this.gameState.player.stats.lightBattery),this.lastPlayerPosition={...e},window.addEventListener("toggleMute",()=>this.handleMuteToggle()),window.addEventListener("useInventoryItem",i=>this.handleInventoryItemClick(i.detail.itemType)),window.addEventListener("toggleLights",()=>this.toggleLights()),window.addEventListener("togglePause",()=>this.handlePauseToggle()),window.addEventListener("toggleRest",()=>this.handleRestToggle()),window.addEventListener("openMenu",()=>{this.isPaused||this.handlePauseToggle()}),window.addEventListener("closeMenu",()=>{this.isPaused&&this.handlePauseToggle()}),window.addEventListener("playerAction",i=>this.handlePlayerAction(i.detail.action)),this.canvas.addEventListener("click",i=>{const s=this.canvas.getBoundingClientRect(),o=i.clientX-s.left,a=i.clientY-s.top;this.renderer.handleCanvasClick(o,a)}),this.actionSystem=ce(),this.generateCampMates()}generateCampMates(){const t={x:800,y:600},e=300,i=["#ff6b6b","#4ecdc4","#45b7d1","#96ceb4","#feca57","#ff9ff3","#54a0ff","#5f27cd","#00d2d3","#ff9f43","#10ac84","#ee5a24","#0984e3","#6c5ce7","#a29bfe","#fd79a8","#fdcb6e","#e17055","#81ecec","#74b9ff","#a29bfe","#fd79a8","#fdcb6e","#e17055","#81ecec","#74b9ff","#0984e3","#6c5ce7","#a29bfe","#fd79a8","#fdcb6e","#e17055","#81ecec","#74b9ff","#0984e3","#6c5ce7","#a29bfe","#fd79a8","#fdcb6e","#e17055","#81ecec","#74b9ff","#0984e3","#6c5ce7","#a29bfe","#fd79a8","#fdcb6e","#e17055","#81ecec","#74b9ff"],s=["Wombat Wally","Wombat Wendy","Wombat Walter","Wombat Willow","Wombat Winston","Wombat Wanda","Wombat Wesley","Wombat Whitney","Wombat Warren","Wombat Wren","Wombat Wade","Wombat Waverly","Wombat Waylon","Wombat Winona","Wombat Wyatt","Wombat Wylie","Wombat Wanda","Wombat Walker","Wombat Winter","Wombat Wilder","Wombat Wren","Wombat Wade","Wombat Waverly","Wombat Waylon","Wombat Winona","Wombat Wyatt","Wombat Wylie","Wombat Wanda","Wombat Walker","Wombat Winter","Wombat Wilder","Wombat Wren","Wombat Wade","Wombat Waverly","Wombat Waylon","Wombat Winona","Wombat Wyatt","Wombat Wylie","Wombat Wanda","Wombat Walker","Wombat Winter","Wombat Wilder","Wombat Wren","Wombat Wade","Wombat Waverly","Wombat Waylon","Wombat Winona","Wombat Wyatt","Wombat Wylie","Wombat Wanda"];for(let o=0;o<50;o++){const a=o/50*Math.PI*2+this.rng.random()*.5,n=this.rng.random()*e,r=t.x+Math.cos(a)*n,l=t.y+Math.sin(a)*n,d=this.rng.random()*Math.PI*2,h=this.rng.random()*e,u=t.x+Math.cos(d)*h,f=t.y+Math.sin(d)*h;this.campMates.push({id:`campmate-${o}`,position:T(r,l),color:i[o%i.length],name:s[o%s.length],targetPosition:T(u,f),speed:.5+this.rng.random()*1,mood:40+this.rng.random()*40})}console.log(`🏕️ Generated ${this.campMates.length} wombat camp mates at the camp!`)}cachedDistance(t,e){if(this.performanceCache.lastDistanceCalculation&&this.performanceCache.lastDistanceCalculation.from.x===t.x&&this.performanceCache.lastDistanceCalculation.from.y===t.y&&this.performanceCache.lastDistanceCalculation.to.x===e.x&&this.performanceCache.lastDistanceCalculation.to.y===e.y)return this.performanceCache.lastDistanceCalculation.result;const i=e.x-t.x,s=e.y-t.y,o=Math.sqrt(i*i+s*s);return this.performanceCache.lastDistanceCalculation={from:{...t},to:{...e},result:o},o}logLightSystemState(){const t=this.gameState.player,e=["Light Bulb Red","Light Bulb Green","Light Bulb Blue","Light Bulb Orange","Light Bulb Purple","Light Bulb Rainbow"];let i=0;e.forEach(s=>{const o=t.inventory.items.get(s)||0;o>0&&(i+=o)}),console.log("🔦 Light System State:",{lightsOn:t.lightsOn,batteryLevel:t.stats.lightBattery.toFixed(1)+"%",totalColoredBulbs:i,inventorySize:t.inventory.items.size})}start(){this.lastTime=this.clock.now(),this.tick()}stop(){this.animationId!==null&&(this.clock.cancelAnimationFrame(this.animationId),this.animationId=null)}update(t){if(this.isPaused||this.gameState.gameEnded)return;this.gameState.player.actualPlayTime+=t;const e=this.worldManager.getCurrentTimeScale(),i=bt(this.gameState.player.drugs),s=e*i;this.gameState.player.drugs.active.length>0;const o=this.worldManager.getCurrentWorldId();let a=o==="camp"?wt:he;if(o==="playa"){const r=this.gameState.player.position,l=this.isPlayerNearLandmark(r,"hell-station",100),d=this.isPlayerNearLandmark(r,"center-camp",100);(l||d)&&(a=wt,console.log(`⏰ Time slowed to 1s = 1 minute at ${l?"Hell Station":"Center Camp"}`))}if(this.gameState.time=ue(this.gameState.time,t,s,a),this.updateWeather(t),this.updateAchievementTracking(t),this.updateCampMates(t),this.gameState.player.mountedOn){const r=this.gameState.artCars.find(l=>l.id===this.gameState.player.mountedOn);if(r){const l={x:r.pos.x,y:r.pos.y-40*r.size},d=t*.5;this.gameState.player.stats.energy=Math.min(100,this.gameState.player.stats.energy+d),this.gameState.player.stats.mood=Math.min(100,this.gameState.player.stats.mood+d);const h=this.worldManager.getCurrentWorldId(),u=this.worldManager.checkWorldTransition(l,this.config.playerSize);if(u&&u.success)this.handleWorldTransition(u,h);else{const f=this.worldManager.getCurrentWorldDimensions();if(this.worldManager.getCurrentWorldId()==="playa"){const x=T(2e3,1500),p=l.x-x.x,m=l.y-x.y,g=p*p+m*m,y=1400;if(g>y*y){const S=Math.sqrt(g)||1,b=p/S,w=m/S;this.gameState.player.position=T(x.x+b*y,x.y+w*y)}else this.gameState.player.position=l}else this.gameState.player.position=yt(l,f.width,f.height,this.config.playerSize)}}}else{const r=this.inputHandler.getMovementDirection();if(r){const l={direction:r,deltaTime:t};if(!this.gameState.player.isResting){const d=this.calculateDrugSpeedMultiplier(),h=this.gameState.player.isOnBike||this.gameState.player.mountedOn?1.5:1,f=At(this.gameState.player.stats.speed,this.gameState.player.stats)*d*h,x=Yt(this.gameState.player.position,l,f),p=this.worldManager.getCurrentWorldId(),m=this.worldManager.checkWorldTransition(x,this.config.playerSize);if(m&&m.success)this.handleWorldTransition(m,p);else{const g=this.worldManager.getCurrentWorldDimensions();if(this.worldManager.getCurrentWorldId()==="playa"){const y=T(2e3,1500),S=x.x-y.x,b=x.y-y.y,w=S*S+b*b,v=1400-this.config.playerSize,k=v*v;if(w>k){const C=Math.sqrt(w)||1,B=S/C,I=b/C;this.gameState.player.position=T(y.x+B*v,y.y+I*v)}else this.gameState.player.position=x}else this.gameState.player.position=yt(x,g.width,g.height,this.config.playerSize)}Math.random()<.1&&this.audio.playSound("playerMove",.1)}}}if(this.gameState.player.isOnBike&&this.gameState.player.mountedBikeId){const r=this.worldManager.getWorldStateManager(),l=this.worldManager.getCurrentWorldId(),d=r.getWorldState(l),u=((d==null?void 0:d.items)||[]).find(f=>f.id===this.gameState.player.mountedBikeId);u&&r.updateWorldItem(l,u.id,{position:{...this.gameState.player.position}})}li(this.camera,this.gameState.player.position,t,this.camera.followSpeed);const n=this.lastPlayerPosition?this.cachedDistance(this.lastPlayerPosition,this.gameState.player.position):0;this.applyNaturalDecay(n,t),this.applyRestingEffects(t),this.lastPlayerPosition={...this.gameState.player.position},Math.floor(this.clock.now()/16)%2===0&&this.checkCoinPickups(),this.checkRestAction(),this.checkMuteToggle(),this.checkMenuToggle(),this.checkInventoryHotkeys(),this.checkActionHotkeys(),this.worldManager.getCurrentWorldId()==="playa"&&Math.floor(this.clock.now()/16)%3===0&&this.updateHellStationAndArtCars(t),this.updateNotifications(t),this.inputHandler.clearKeyPressed()}checkCoinPickups(){const t=this.gameState.player.position,e=this.config.playerSize/2,i=12;$t(this.spatialIndex,t,e+i).entities.forEach(o=>{const a=this.gameState.coins.find(n=>n.id===o.id);if(a&&!a.collected&&Xt(t,e,a.position,i)){const n=je(a.value);{a.collected=!0,this.gameState.player.stats=it(this.gameState.player.stats,n.statDelta),this.trackCoinChange(a.value),Ie(this.spatialIndex,a.id),ne(a.value,a.position);const r=this.worldManager.getCurrentWorldId();this.worldManager.getWorldStateManager().updateWorldItem(r,a.id,{collected:!0}),this.audio.playSound("coinPickup",.5)}}}),this.checkCollectibleCollection(t,e),this.checkMoopCollection(t,e)}checkMoopCollection(t,e){qe(t,e,this.gameState.moop).forEach(s=>{const o=Oe(s,this.gameState.player.stats);if(o.success){this.gameState.player.stats=o.newStats,this.trackKarmaChange(o.karmaGained);const a=this.getInventoryItemTypeFromMoop(s.type);if(a){H(this.gameState.player.inventory,a,1),this.totalMoopCollected++,this.totalMoopCollected===1&&(this.achievements.add("first-moop"),console.log("🏆 Achievement unlocked: First Cleanup")),this.totalMoopCollected>=50&&(this.achievements.add("moop-collector"),console.log("🏆 Achievement unlocked: Moop Collector"));const d=Q(this.gameState.player.inventory,this.gameState.player.position);d.length>0&&console.log(`🔨 Auto-crafted: ${d.join(", ")}`)}const n=this.gameState.moop.findIndex(d=>d.id===s.id);n!==-1&&(this.gameState.moop[n].collected=!0);const r=Ee(s.type);W().addNotification(`+1 ${r} (+${o.karmaGained} karma)`,"item",o.karmaGained,s.position),this.audio.playSound("coinPickup",.3)}})}getInventoryItemTypeFromMoop(t){return{ziptie:"Zip Tie",ducting:"Ducting",bucket:"Bucket",glitter:"Glitter",rope:"Rope","plastic-bag":"Plastic Bag","water-bottle":"Water",cup:"Water","flashing-light":"Light Bulb","furry-hat":"Furry Hat",boots:"Boots","cat-head":"Cat Head","cigarette-butt":"Trinket","light-bulb":"Light Bulb"}[t]||null}updateWeather(t){this.gameState.weather.duration>0&&(this.gameState.weather.duration-=t,this.gameState.weather.duration<=0&&(this.gameState.weather.type="clear",this.gameState.weather.intensity=0,this.gameState.weather.duration=0,this.renderer&&typeof this.renderer.clearThunderstormEffects=="function"&&this.renderer.clearThunderstormEffects()));const e=this.gameState.time.hour,i=this.gameState.time.minute;if(e===6&&i===0&&this.gameState.weather.duration<=0){const s=Math.random();s<.2?(this.gameState.weather.type="thunderstorm",this.gameState.weather.intensity=.8+Math.random()*.2,this.gameState.weather.duration=4*60*60,this.gameState.weather.startTime=this.gameState.time.totalMinutes):s<.7?(this.gameState.weather.type="nice",this.gameState.weather.intensity=.6+Math.random()*.4,this.gameState.weather.duration=8*60*60,this.gameState.weather.startTime=this.gameState.time.totalMinutes):(this.gameState.weather.type="overcast",this.gameState.weather.intensity=.3+Math.random()*.4,this.gameState.weather.duration=6*60*60,this.gameState.weather.startTime=this.gameState.time.totalMinutes)}}checkCollectibleCollection(t,e){const i=this.worldManager.getCurrentWorldId(),s=this.worldManager.getWorldStateManager(),o=s.getWorldState(i),a=(o==null?void 0:o.items)||[];this.checkBikeMount(a),i==="playa"&&this.checkArtCarMount(),a.forEach(n=>{var r,l;if(!n.collected&&n.type!=="coin"&&n.type!=="bike"){if(n.type==="light-bulb"&&n.dropTime&&Date.now()-n.dropTime<3e3)return;if(jt(t,e,n.position,15)){switch(s.updateWorldItem(i,n.id,{collected:!0}),n.type){case"water":H(this.gameState.player.inventory,"Water",1),J("Water",n.position);const d=Q(this.gameState.player.inventory,this.gameState.player.position);d.length>0&&console.log(`🔨 Auto-crafted: ${d.join(", ")}`);break;case"food":const h=(r=n.data)==null?void 0:r.subtype;if(h&&st[h]){H(this.gameState.player.inventory,h,1),J(h,n.position);const m=Q(this.gameState.player.inventory,this.gameState.player.position);m.length>0&&console.log(`🔨 Auto-crafted: ${m.join(", ")}`)}break;case"drug":const u=(l=n.data)==null?void 0:l.subtype;if(u){const m=te(u,1);this.gameState.player.drugs=ie(this.gameState.player.drugs,m),this.gameState.player.totalDrugsTaken++,J(u,n.position);const g=Wt[u];if(g&&g.effects){const y={energy:g.effects.energy,mood:g.effects.mood,thirst:g.effects.thirst,hunger:g.effects.hunger,karma:g.effects.karma};if(this.gameState.player.stats=it(this.gameState.player.stats,y),g.effects.mood&&g.effects.mood!==0&&L("mood",g.effects.mood,n.position),g.effects.energy&&g.effects.energy!==0&&L("energy",g.effects.energy,n.position),g.effects.thirst&&g.effects.thirst!==0&&L("thirst",g.effects.thirst,n.position),g.effects.hunger&&g.effects.hunger!==0&&L("hunger",g.effects.hunger,n.position),g.effects.karma&&g.effects.karma!==0&&L("karma",g.effects.karma,n.position),g.effects.speed&&g.effects.speed!==0&&L("speed",g.effects.speed,n.position),g.effects.timeScale&&g.effects.timeScale!==1){const S=((g.effects.timeScale-1)*100).toFixed(0);W().addNotification(`Time: ${parseFloat(S)>0?"+":""}${S}%`,"item",1,n.position)}}}break;case"battery":H(this.gameState.player.inventory,"Battery",1),J("Battery",n.position);const f=Q(this.gameState.player.inventory,this.gameState.player.position);f.length>0&&console.log(`🔨 Auto-crafted: ${f.join(", ")}`);break;case"light-bulb":case"light-bulb-white":case"light-bulb-red":case"light-bulb-green":case"light-bulb-blue":case"light-bulb-orange":case"light-bulb-purple":case"light-bulb-rainbow":let x;if(n.type==="light-bulb"&&n.lightBulbType)x=n.lightBulbType;else if(n.type==="light-bulb")x="Light Bulb";else{const m=n.type.replace("light-bulb-","");x=`Light Bulb ${m.charAt(0).toUpperCase()+m.slice(1)}`}if(H(this.gameState.player.inventory,x,1),J(x,n.position),this.gameState.player.stats.lightBattery>=100)H(this.gameState.player.inventory,"Battery",1),W().addNotification("Battery full! Got a spare battery instead.","item",2,n.position);else{const m=Math.min(100,this.gameState.player.stats.lightBattery+30);this.gameState.player.stats.lightBattery=m,W().addNotification(`Battery charged! (${m}%)`,"item",2,n.position)}this.gameState.player.achievements.has("not-a-darkwad")||(this.gameState.player.achievements.add("not-a-darkwad"),this.showAchievement("Not a Darkwad","💡 You found your first light!",n.position)),this.achievements.add("not-a-darkwad"),console.log("🏆 Achievement unlocked: Not a Darkwad");const p=Q(this.gameState.player.inventory,this.gameState.player.position);p.length>0&&console.log(`🔨 Auto-crafted: ${p.join(", ")}`);break}this.audio.playSound("coinPickup",.3)}}})}trackCoinChange(t){this.coinChangeHistory.push({amount:t,timestamp:Date.now()}),this.coinChangeHistory=this.coinChangeHistory.filter(e=>Date.now()-e.timestamp<5e3)}trackKarmaChange(t){this.karmaChangeHistory.push({amount:t,timestamp:Date.now()}),this.karmaChangeHistory=this.karmaChangeHistory.filter(e=>Date.now()-e.timestamp<5e3)}getRecentCoinChange(){const t=Date.now()-5e3;return this.coinChangeHistory.filter(e=>e.timestamp>t).reduce((e,i)=>e+i.amount,0)}getRecentKarmaChange(){const t=Date.now()-5e3;return this.karmaChangeHistory.filter(e=>e.timestamp>t).reduce((e,i)=>e+i.amount,0)}isPlayerAtRestArea(){const t=this.gameState.player.position,e=120,s=Z(this.worldManager.getCurrentWorldId(),this.gameState.time).filter(o=>o.type==="restArea"||o.id==="center-camp");for(const o of s)if(Math.sqrt(Math.pow(t.x-o.position.x,2)+Math.pow(t.y-o.position.y,2))<=e)return!0;return!1}applyRestingEffects(t){const e=this.isPlayerAtRestArea();if(this.gameState.player.isResting||e){const i=12*t,s=e?this.gameState.player.isResting?3:2:1,o=i*s,a=Math.min(100,this.gameState.player.stats.energy+o);if(a!==this.gameState.player.stats.energy){const n=Math.floor(this.gameState.player.stats.energy);this.gameState.player.stats.energy=a;const r=Math.floor(a);if(r>n){const l=r-n,d=W(),h=e?this.gameState.player.isResting?`⚡ +${l} Energy (3x Resting at Rest Area)`:`⚡ +${l} Energy (2x Rest Area)`:`+${l} Energy`;d.addNotification(h,"energy",l,this.gameState.player.position)}}this.gameState.player.isResting&&this.gameState.player.stats.energy>=100&&(this.gameState.player.isResting=!1,this.audio.playSound("buttonClick",.3))}}applyNaturalDecay(t,e){this.worldManager.getCurrentTimeScale();const i=e;this.gameState.player.drugs.active.length>0&&(this.gameState.player.totalTimeOnDrugs+=i),this.gameState.player.drugs=ee(this.gameState.player.drugs,i),this.updateDustStorm(e),this.gameState.time.day>=11&&!this.gameState.gameEnded&&this.endGame();const s=Zt(t,e,this.gameState.player.stats);if(s.bathroom>0&&Math.floor(this.clock.now()/5e3)!==Math.floor(this.lastTime/5e3)&&console.log(`🚽 Bathroom increasing by ${s.bathroom.toFixed(2)}, current: ${this.gameState.player.stats.bathroom.toFixed(1)}`),this.gameState.player.stats=it(this.gameState.player.stats,s),this.gameState.player.stats.lightBattery>0&&this.gameState.player.lightsOn){const o=e*1.67;this.gameState.player.stats.lightBattery=Math.max(0,this.gameState.player.stats.lightBattery-o),this.gameState.player.stats.lightBattery<=0&&(this.gameState.player.lightsOn=!1,window.dispatchEvent(new CustomEvent("lightStateUpdate",{detail:{lightsOn:!1}})),W().addNotification("Battery dead - lights turned off","persistent",0,this.gameState.player.position))}}checkRestAction(){typeof this.inputHandler.isGiftKeyPressed=="function"&&this.inputHandler.isGiftKeyPressed()&&window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"gift"}})),typeof this.inputHandler.isTotemTogglePressed=="function"&&this.inputHandler.isTotemTogglePressed()&&window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"toggleTotem"}})),this.inputHandler.isLightsKeyPressed()&&(console.log("🔑 L key pressed - dispatching toggleLights action"),window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:"toggleLights"}})))}checkMuteToggle(){if(this.inputHandler.isMuteKeyPressed()){const t=this.audio.isMuted();this.audio.setMuted(!t),this.audio.playSound("buttonClick",.2)}}checkMenuToggle(){this.inputHandler.isEscapeKeyPressed()&&(window.dispatchEvent(new CustomEvent("toggleMenu")),this.audio.playSound("buttonClick",.2))}handleMuteToggle(){const t=this.audio.isMuted();this.audio.setMuted(!t),this.audio.playSound("buttonClick",.2)}checkInventoryHotkeys(){Object.values(st).forEach(t=>{if(t.hotkey&&this.inputHandler.isKeyJustPressed(t.hotkey)){if(t.hotkey==="L"&&t.type.includes("Light Bulb"))return;const e=St(this.gameState.player.inventory,t.type,this.gameState.player.stats);if(e.success){const i=e.newStats.bathroom-this.gameState.player.stats.bathroom;i!==0&&console.log(`🍔 Used ${t.type}: bathroom changed by ${i.toFixed(1)}, new bathroom: ${e.newStats.bathroom.toFixed(1)}`),this.gameState.player.stats=e.newStats,this.audio.playSound("buttonClick",.3),this.showItemUsageNotifications(t.type)}}})}checkBikeMount(t){const e=this.gameState.player.position,i=W();if(this.gameState.player.isOnBike){this.inputHandler.isKeyJustPressed(" ")&&(this.gameState.player.isOnBike=!1,this.gameState.player.mountedBikeId=void 0,this.audio.playSound("dismount",.3),i.addNotification("Dismounted from bike","item",2,e));return}const s=t.find(o=>!o.collected&&o.type==="bike"&&ot(e,o.position)<40);s?(i.addNotification("Press Space to mount bike","persistent",0,s.position),i.updatePersistentNotificationPosition("Press Space to mount bike",s.position),this.inputHandler.isKeyJustPressed(" ")&&(this.gameState.player.isOnBike=!0,this.gameState.player.mountedBikeId=s.id,this.audio.playSound("mount",.3),i.removePersistentNotification("Press Space to mount bike"),i.addNotification("Mounted bike!","item",2,e))):i.removePersistentNotification("Press Space to mount bike")}checkArtCarMount(){const t=this.gameState.player.position,e=W();if(this.gameState.player.mountedOn){this.inputHandler.isKeyJustPressed(" ")&&(this.gameState.player.mountedOn=null,this.audio.playSound("dismount",.3),e.addNotification("Dismounted from art car","item",2,t));return}const i=this.gameState.artCars.find(s=>Math.hypot(t.x-s.pos.x,t.y-s.pos.y)<80);i?(e.addNotification("Press Space to board art car","persistent",0,i.pos),e.updatePersistentNotificationPosition("Press Space to board art car",i.pos),this.inputHandler.isKeyJustPressed(" ")&&(this.gameState.player.mountedOn=i.id,this.audio.playSound("mount",.3),e.removePersistentNotification("Press Space to board art car"),e.addNotification(`Boarded ${i.id==="art-car-1"?"Disco Bus":"Fire Dragon"}!`,"item",2,t),this.achievements.add("art-car-rider"),console.log("🏆 Achievement unlocked: Art Car Rider"))):e.removePersistentNotification("Press Space to board art car")}checkActionHotkeys(){if(this.gameState.player.isResting&&this.inputHandler.isAnyKeyPressed()){this.gameState.player.isResting=!1,this.audio.playSound("buttonClick",.3);return}this.inputHandler.isKeyJustPressed("r")&&this.handleRestAction(),this.inputHandler.isKeyJustPressed("p")&&this.handlePauseToggle()}handleRestAction(){this.gameState.player.isResting?(this.gameState.player.isResting=!1,this.audio.playSound("buttonClick",.3)):(this.gameState.player.isResting=!0,this.audio.playSound("playerRest",.5))}handleInventoryItemClick(t){if(this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to use item:",t)),t.includes("Light Bulb")){this.dropLightBulb(t);return}if(["Ducting","Bucket","Zip Tie","Glitter","Rope","Plastic Bag"].includes(t)){this.dropMoop(t);return}if(Dt(t)){this.handleEquipmentToggle(t);return}const i=St(this.gameState.player.inventory,t,this.gameState.player.stats);if(i.success){const s=i.newStats.bathroom-this.gameState.player.stats.bathroom;s!==0&&console.log(`🍔 Used ${t}: bathroom changed by ${s.toFixed(1)}, new bathroom: ${i.newStats.bathroom.toFixed(1)}`),this.gameState.player.stats=i.newStats,this.audio.playSound("buttonClick",.3),this.showItemUsageNotifications(t)}}handleEquipmentToggle(t){const e=this.gameState.player;e.equippedItem===t?(xt(e),W().addNotification(`Unequipped ${t}`,"item",2e3,e.position),console.log(`🔧 Unequipped ${t}`)):Et(e,t)?(W().addNotification(`Equipped ${t}`,"item",2e3,e.position),console.log(`🔧 Equipped ${t}`),this.audio.playSound("buttonClick",.5)):W().addNotification(`Cannot equip ${t}`,"warning",2e3,e.position)}dropLightBulb(t){const e=Date.now(),i=e-this.lastLightDropTime;if(i<2e3){const u=Math.ceil((2e3-i)/1e3);W().addNotification(`Light drop cooldown: ${u}s`,"warning",0,this.gameState.player.position);return}if((this.gameState.player.inventory.items.get(t)||0)<=0)return;rt(this.gameState.player.inventory,t,1);const o=(Math.random()-.5)*40,a=(Math.random()-.5)*40,n={id:`dropped-light-${Date.now()}-${Math.random()}`,type:"light-bulb",position:{x:this.gameState.player.position.x+o,y:this.gameState.player.position.y+a},radius:12,collected:!1,lightBulbType:t,dropTime:e},r=this.worldManager.getCurrentWorldId(),d=this.worldManager.getWorldStateManager().getWorldState(r);d&&d.items.push(n),W().addNotification(`Dropped ${t}`,"item",0,this.gameState.player.position),this.audio.playSound("buttonClick",.3),this.lastLightDropTime=e}dropMoop(t){const e=Date.now(),i=e-this.lastMoopDropTime;if(i<2e3){const d=Math.ceil((2e3-i)/1e3);W().addNotification(`Moop drop cooldown: ${d}s`,"warning",0,this.gameState.player.position);return}if((this.gameState.player.inventory.items.get(t)||0)<=0)return;rt(this.gameState.player.inventory,t,1);const a={Ducting:"ducting",Bucket:"bucket","Zip Tie":"ziptie",Glitter:"glitter",Rope:"rope","Plastic Bag":"plastic-bag"}[t],n=a?this.getMoopKarmaReward(a):0,r=n*2;this.gameState.player.stats.karma-=r,W().addNotification(`Littered ${t} • -${r} karma`,"warning",0,this.gameState.player.position),this.audio.playSound("buttonClick",.3),this.lastMoopDropTime=e,console.log(`🗑️ Dropped ${t}, karma reversed: ${n}`)}getMoopKarmaReward(t){return{ziptie:2,"water-bottle":3,cup:2,"flashing-light":5,"furry-hat":8,"cigarette-butt":1,"light-bulb":-5,ducting:3,bucket:4,glitter:2,rope:3,"plastic-bag":1}[t]||0}getMoopRadius(t){return{ziptie:8,"water-bottle":12,cup:10,"flashing-light":14,"furry-hat":16,"cigarette-butt":6,"light-bulb":8,ducting:10,bucket:14,glitter:6,rope:8,"plastic-bag":6}[t]||8}toggleLights(){const t=this.playerHasLightBulbs(),e=this.gameState.player.stats.lightBattery>0;if(!t){W().addNotification("No light bulbs! Find some to use lights.","warning",0,this.gameState.player.position),this.audio.playSound("buttonClick",.2);return}if(!e){W().addNotification("Battery dead! Find a battery to use lights.","warning",0,this.gameState.player.position),this.audio.playSound("buttonClick",.2);return}this.gameState.player.lightsOn=!this.gameState.player.lightsOn,window.dispatchEvent(new CustomEvent("lightStateUpdate",{detail:{lightsOn:this.gameState.player.lightsOn}})),this.audio.playSound("buttonClick",.3);const i=W(),s=this.gameState.player.lightsOn?"Lights turned on":"Lights turned off";i.addNotification(s,"persistent",0,this.gameState.player.position)}playerHasLightBulbs(){return Array.from(this.gameState.player.inventory.items.entries()).some(([t,e])=>e>0&&(t.includes("Light Bulb")||t==="Battery"))}checkBikeMountInteractions(){}handleRestToggle(){this.handleRestAction()}handlePauseToggle(){this.isPaused=!this.isPaused,this.audio.playSound("buttonClick",.2),this.isPaused?this.showDebugMenu():this.hideDebugMenu(),window.dispatchEvent(new CustomEvent("pauseStateUpdate",{detail:{isPaused:this.isPaused}}))}showDebugMenu(){this.debugMenuOverlay&&this.hideDebugMenu(),this.debugMenuOverlay=document.createElement("div"),this.debugMenuOverlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      font-family: 'Courier New', monospace;
      color: white;
    `;const t=document.createElement("div");t.style.cssText=`
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      padding: 30px;
      border-radius: 15px;
      border: 2px solid #4ecdc4;
      text-align: center;
      max-width: 500px;
      box-shadow: 0 0 30px rgba(78, 205, 196, 0.3);
    `,t.innerHTML=`
      <h1 style="color: #4ecdc4; font-size: 2em; margin-bottom: 20px;">🔧 Debug Menu</h1>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #ffd93d; margin-bottom: 10px;">Current State</h3>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <div>Day: ${this.gameState.time.day}</div>
          <div>Hour: ${this.gameState.time.hour}:${this.gameState.time.minute.toString().padStart(2,"0")}</div>
          <div>Weather: ${this.gameState.weather.type}</div>
          <div>World: ${this.worldManager.getCurrentWorldId()}</div>
        </div>
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="color: #ffd93d; margin-bottom: 10px;">Time Controls</h3>
        <button onclick="window.gameLoop.advanceDay()" style="
          background: linear-gradient(45deg, #4ecdc4, #44a08d);
          border: none;
          padding: 10px 20px;
          margin: 5px;
          font-size: 1em;
          color: white;
          border-radius: 20px;
          cursor: pointer;
          font-family: 'Courier New', monospace;
          font-weight: bold;
        ">⏭️ Advance Day</button>
        
        <button onclick="window.gameLoop.goBackDay()" style="
          background: linear-gradient(45deg, #e74c3c, #c0392b);
          border: none;
          padding: 10px 20px;
          margin: 5px;
          font-size: 1em;
          color: white;
          border-radius: 20px;
          cursor: pointer;
          font-family: 'Courier New', monospace;
          font-weight: bold;
        ">⏮️ Go Back Day</button>
        
        <button onclick="window.gameLoop.advanceHour()" style="
          background: linear-gradient(45deg, #4ecdc4, #44a08d);
          border: none;
          padding: 10px 20px;
          margin: 5px;
          font-size: 1em;
          color: white;
          border-radius: 20px;
          cursor: pointer;
          font-family: 'Courier New', monospace;
          font-weight: bold;
        ">⏰ Advance Hour</button>
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="color: #ffd93d; margin-bottom: 10px;">Weather Controls</h3>
        <button onclick="window.gameLoop.setWeather('clear')" style="
          background: linear-gradient(45deg, #87CEEB, #4682B4);
          border: none;
          padding: 8px 15px;
          margin: 3px;
          font-size: 0.9em;
          color: white;
          border-radius: 15px;
          cursor: pointer;
          font-family: 'Courier New', monospace;
        ">☀️ Clear</button>
        
        <button onclick="window.gameLoop.setWeather('nice')" style="
          background: linear-gradient(45deg, #98FB98, #32CD32);
          border: none;
          padding: 8px 15px;
          margin: 3px;
          font-size: 0.9em;
          color: white;
          border-radius: 15px;
          cursor: pointer;
          font-family: 'Courier New', monospace;
        ">🌤️ Nice</button>
        
        <button onclick="window.gameLoop.setWeather('overcast')" style="
          background: linear-gradient(45deg, #D3D3D3, #A9A9A9);
          border: none;
          padding: 8px 15px;
          margin: 3px;
          font-size: 0.9em;
          color: white;
          border-radius: 15px;
          cursor: pointer;
          font-family: 'Courier New', monospace;
        ">☁️ Overcast</button>
        
        <button onclick="window.gameLoop.setWeather('thunderstorm')" style="
          background: linear-gradient(45deg, #4169E1, #191970);
          border: none;
          padding: 8px 15px;
          margin: 3px;
          font-size: 0.9em;
          color: white;
          border-radius: 15px;
          cursor: pointer;
          font-family: 'Courier New', monospace;
        ">⛈️ Thunderstorm</button>
        
        <button onclick="window.gameLoop.setWeather('duststorm')" style="
          background: linear-gradient(45deg, #D2B48C, #8B4513);
          border: none;
          padding: 8px 15px;
          margin: 3px;
          font-size: 0.9em;
          color: white;
          border-radius: 15px;
          cursor: pointer;
          font-family: 'Courier New', monospace;
        ">🌪️ Duststorm</button>
      </div>

      <div style="margin-bottom: 20px;">
        <button onclick="window.gameLoop.hideDebugMenu(); window.gameLoop.handlePauseToggle();" style="
          background: linear-gradient(45deg, #ff6b6b, #ee5a52);
          border: none;
          padding: 15px 30px;
          font-size: 1.2em;
          color: white;
          border-radius: 25px;
          cursor: pointer;
          font-family: 'Courier New', monospace;
          font-weight: bold;
        ">▶️ Resume Game</button>
      </div>
    `,this.debugMenuOverlay.appendChild(t),document.body.appendChild(this.debugMenuOverlay),window.gameLoop=this}hideDebugMenu(){this.debugMenuOverlay&&(document.body.removeChild(this.debugMenuOverlay),this.debugMenuOverlay=null)}advanceDay(){this.gameState.time.day+=1,this.gameState.time.hour=0,this.gameState.time.minute=0;const t=24*60;this.gameState.time.totalMinutes=(this.gameState.time.day-1)*t,this.debugMenuOverlay&&(this.hideDebugMenu(),this.showDebugMenu())}goBackDay(){if(this.gameState.time.day>1){this.gameState.time.day-=1,this.gameState.time.hour=23,this.gameState.time.minute=59;const t=24*60;this.gameState.time.totalMinutes=(this.gameState.time.day-1)*t+23*60+59,this.debugMenuOverlay&&(this.hideDebugMenu(),this.showDebugMenu())}}advanceHour(){this.gameState.time.hour+=1,this.gameState.time.hour>=24&&(this.gameState.time.hour=0,this.gameState.time.day+=1),this.gameState.time.minute=0;const t=24*60;this.gameState.time.totalMinutes=(this.gameState.time.day-1)*t+this.gameState.time.hour*60+this.gameState.time.minute,this.debugMenuOverlay&&(this.hideDebugMenu(),this.showDebugMenu())}setWeather(t){this.gameState.weather.type=t,this.gameState.weather.intensity=.5,this.gameState.weather.duration=300,this.gameState.weather.startTime=Date.now(),this.renderer&&typeof this.renderer.clearThunderstormEffects=="function"&&this.renderer.clearThunderstormEffects()}handlePlayerAction(t){switch(console.log("Player action:",t),t){case"rest":this.handleRestAction();break;case"toggleTotem":(this.gameState.player.inventory.items.get("Totem")||0)>0&&(this.gameState.player.equippedItem==="Totem"?(this.gameState.player.equippedItem=void 0,console.log("🔧 Unequipped Totem")):(this.gameState.player.equippedItem="Totem",console.log("🔧 Equipped Totem")));break;case"toggleLights":this.toggleLights();break;case"mountBike":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to mount bike")),this.checkBikeMountInteractions();break;case"mountArtCar":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to mount art car")),this.checkArtCarMount();break;case"explore":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to explore"));break;case"gift":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to give gift")),this.showGiftDialogue();break;case"help":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to help stranger"));break;case"battle":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest for silly battle"));break;case"meditate":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to meditate"));break;default:console.log("Unknown action:",t)}this.audio.playSound("buttonClick",.2)}showGiftDialogue(){if(this.dialogueOverlay)return;Array.from(this.gameState.player.inventory.items.entries()).map(([r,l])=>({type:r,quantity:l})).filter(r=>r.quantity>0),this.dialogueOverlay=document.createElement("div"),this.dialogueOverlay.dataset.dialog="gift",this.dialogueOverlay.style.cssText=`
      position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 999999; pointer-events: auto;
      display: flex; align-items: center; justify-content: center; font-family: 'Courier New', monospace; color: #fff;`;const t=document.createElement("div");t.style.cssText=`
      background: #1e1e2f; border: 2px solid #8b5cf6; border-radius: 14px; width: 720px; max-width: 90vw; max-height: 80vh; overflow: auto; padding: 20px; position: relative;`;const e=document.createElement("button");e.textContent="✖",e.style.cssText="position:absolute; top:8px; right:10px; background: transparent; color:#fff; border:none; font-size: 18px; cursor:pointer;",e.addEventListener("click",()=>this.closeDialogue()),t.appendChild(e);const i=document.createElement("h2");i.textContent="Give Gift",i.style.cssText="margin: 0 0 10px 0; color:#ffd23f;",t.appendChild(i);const s=document.createElement("button");s.textContent="🎁 Gift All",s.style.cssText=`
      background: linear-gradient(45deg,#27ae60,#2ecc71); color:#fff; border:none; padding:10px 16px; border-radius:10px; font-weight:bold; cursor:pointer; margin: 0 0 12px 0;`,s.addEventListener("click",()=>{let r=0,l=0;for(const[d,h]of Array.from(this.gameState.player.inventory.items.entries()))if(h>0){const u=this.getGiftKarmaForItem(d)*h;this.gameState.player.inventory.items.delete(d),r+=h,l+=u}if(r>0){this.gameState.player.totalItemsGifted+=r,this.gameState.player.totalKarmaGifted+=l,this.applyKarmaChange(l,`Gave ${r} items`),W().addNotification(`🎁 Gifted All • +${Math.round(l)} karma`,"karma",2500,this.gameState.player.position),this.checkGiftingAchievements();const h=document.createElement("div");h.textContent=`+${Math.round(l)} karma`,h.style.cssText=`
          position:absolute; top:12px; left:50%; transform: translateX(-50%);
          background: rgba(39, 174, 96, 0.9); color:#fff; padding:6px 12px; border-radius:999px;
          font-weight:bold; box-shadow:0 0 12px rgba(39,174,96,.6); z-index: 1000000;`,t.appendChild(h),setTimeout(()=>{t.contains(h)&&t.removeChild(h)},1800),window.dispatchEvent(new CustomEvent("gameStateUpdate",{detail:{gameState:this.gameState}})),this.refreshGiftGrid(t)}}),t.appendChild(s);const o=document.createElement("div");o.className="gift-grid",o.style.cssText="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px;",t.appendChild(o);const a=document.createElement("div");a.style.cssText="margin-top:12px; display:flex; justify-content:flex-end; gap:10px;";const n=document.createElement("button");n.textContent="Stop Gifting",n.style.cssText="background:#e74c3c; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;",n.addEventListener("click",()=>this.closeDialogue()),a.appendChild(n),t.appendChild(a),this.dialogueOverlay.appendChild(t),document.body.appendChild(this.dialogueOverlay),this.populateGiftGrid(o)}populateGiftGrid(t){t.innerHTML="";const e=Array.from(this.gameState.player.inventory.items.entries()).map(([i,s])=>({type:i,quantity:s})).filter(i=>i.quantity>0).sort((i,s)=>s.quantity-i.quantity||i.type.localeCompare(s.type));for(const i of e){const s=document.createElement("button"),o=this.getGiftKarmaForItem(i.type),a=gt(i.type);s.style.cssText="background: rgba(45,45,68,0.85); color:#fff; border:1px solid #8b5cf6; border-radius:10px; padding:12px; text-align:left; cursor:pointer; backdrop-filter: blur(2px);",s.innerHTML=`<div style="display:flex; align-items:center; gap:8px; font-weight:bold;"><span style="font-size:18px;">${a}</span> ${i.type}</div>
        <div style="opacity:.85; font-size:12px; margin-top:4px; display:flex; justify-content:space-between;">
          <span>Qty: ${i.quantity}</span>
          <span>+${o} karma each</span>
        </div>`,s.addEventListener("click",()=>{this.giftItem(i.type,1),this.populateGiftGrid(t)}),t.appendChild(s)}if(e.length===0){const i=document.createElement("div");i.style.cssText="opacity:.7; grid-column: 1 / -1; padding:6px;",i.textContent="No items to gift",t.appendChild(i)}}refreshGiftGrid(t){const e=t.querySelector(".gift-grid");e&&this.populateGiftGrid(e)}giftItem(t,e){const i=this.gameState.player.inventory.items.get(t)||0;if(i<=0)return;const s=Math.min(i,e),o=i-s;o<=0?this.gameState.player.inventory.items.delete(t):this.gameState.player.inventory.items.set(t,o);const a=this.getGiftKarmaForItem(t)*s;this.gameState.player.totalItemsGifted+=s,this.gameState.player.totalKarmaGifted+=a,this.applyKarmaChange(a,`Gifted ${s} ${t}`),W().addNotification(`🎁 Gifted ${s} ${t} • +${Math.round(a)} karma`,"karma",2200,this.gameState.player.position),this.checkGiftingAchievements(),window.dispatchEvent(new CustomEvent("gameStateUpdate",{detail:{gameState:this.gameState}}))}getGiftKarmaForItem(t){const e=t.toLowerCase();return/light bulb|battery|bulb/.test(e)?5:/water|pizza|nachos|pickles|bacon|corn dog|energy bar|grilled cheese|burner burger|cotton candy|dusty donut|smoothie|popsicle|fruit salad|burrito/.test(e)?3:/trinket|clothing|hat|boots|cape|costume/.test(e)?2:1}applyKarmaChange(t,e){this.gameState.player.stats.karma=this.gameState.player.stats.karma+t,this.karmaChangeHistory.push({amount:t,timestamp:Date.now()})}updateDustStorm(t){const e=this.gameState.time.hour,i=e>=14&&e<=18||e>=2&&e<=6;if(this.gameState.dustStorm.active)if(this.gameState.dustStorm.duration-=t,this.gameState.dustStorm.duration<=0)this.gameState.dustStorm.active=!1,this.gameState.dustStorm.intensity=0,this.gameState.dustStorm.duration=0;else{const s=(Date.now()-this.gameState.dustStorm.startTime)/1e3,o=.7,a=Math.sin(s*.5)*.2;this.gameState.dustStorm.intensity=Math.max(.3,Math.min(1,o+a))}else i&&Math.random()<.001&&(this.gameState.dustStorm.active=!0,this.gameState.dustStorm.intensity=.8,this.gameState.dustStorm.duration=30+Math.random()*60,this.gameState.dustStorm.startTime=Date.now())}endGame(){this.gameState.gameEnded=!0;const t=(Date.now()-this.gameState.player.gameStartTime)/1e3,e=t>0?this.gameState.player.totalTimeOnDrugs/t*100:0;this.checkManBurnTotemAchievement(),this.showEndGameScreen({coins:this.gameState.player.stats.coins,karma:this.gameState.player.stats.karma,drugPercentage:e,totalDrugsTaken:this.gameState.player.totalDrugsTaken,totalGameTime:t})}showAchievement(t,e,i){const s=W();s.addNotification(`🏆 ${t}`,"achievement",3,i),setTimeout(()=>{s.addNotification(e,"achievement",2,i)},1e3)}showEndGameScreen(t){const e=this.gameState.time.totalMinutes/60,i=kt(this.gameState.player.stats,this.achievements,this.gameState.player.inventory,this.totalDrugsTaken,e),s=this.awards.filter(d=>d.unlocked),o=document.createElement("div");o.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      font-family: 'Courier New', monospace;
      color: white;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
    `;const a=document.createElement("div");a.style.cssText=`
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      padding: 40px;
      border-radius: 20px;
      border: 2px solid #ff6b6b;
      text-align: center;
      max-width: 800px;
      margin: 0 auto;
      box-shadow: 0 0 50px rgba(255, 107, 107, 0.3);
    `;const n=Math.floor(t.totalGameTime),r=t.totalDrugsTaken*5,l=n+r;a.innerHTML=`
      <h1 style="color: #ff6b6b; font-size: 2.5em; margin-bottom: 20px; text-shadow: 0 0 10px #ff6b6b;">
        🎉 YOU WIN BURNING MAN! 🎉
      </h1>
      <h2 style="color: #4ecdc4; margin-bottom: 30px;">Your Burning Man Journey Ends</h2>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px;">
          <h3 style="color: #ffd93d; margin-bottom: 10px;">💰 Coins Collected</h3>
          <div style="font-size: 2em; font-weight: bold;">${t.coins}</div>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px;">
          <h3 style="color: #ffd93d; margin-bottom: 10px;">🌟 Karma</h3>
          <div style="font-size: 2em; font-weight: bold;">${Math.round(t.karma)}</div>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px;">
          <h3 style="color: #ffd93d; margin-bottom: 10px;">💊 Time on Drugs</h3>
          <div style="font-size: 2em; font-weight: bold;">${t.drugPercentage.toFixed(1)}%</div>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px;">
          <h3 style="color: #ffd93d; margin-bottom: 10px;">🧪 Total Drugs Taken</h3>
          <div style="font-size: 2em; font-weight: bold;">${t.totalDrugsTaken}</div>
        </div>
      </div>
      
      <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
        <h3 style="color: #ffd93d; margin-bottom: 10px;">⏱️ Total Play Time</h3>
        <div style="font-size: 1.5em;">${l}s <span style="color:#aaa; font-size:0.9em;">(base ${n}s + bonus +${r}s)</span></div>
      </div>
      
      <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
        <h3 style="color: #ffd93d; margin-bottom: 15px;">🏆 Achievements Unlocked</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
          ${this.gameState.player.achievements.size>0?Array.from(this.gameState.player.achievements).map(d=>`<div style="background: rgba(255, 215, 0, 0.2); padding: 10px; border-radius: 8px; border: 1px solid #ffd700;">
                ${{"first-moop":"🗑️ First Cleanup","moop-collector":"🗑️ Moop Collector","not-a-darkwad":"💡 Not a Darkwad","art-car-rider":"🚗 Art Car Rider"}[d]||`🏆 ${d.replace(/-/g," ").replace(/\b\w/g,u=>u.toUpperCase())}`}
              </div>`).join(""):'<div style="color: #888; font-style: italic;">No achievements unlocked yet</div>'}
        </div>
        <div style="margin-top: 10px; color: #ffd93d; font-size: 0.9em;">
          Total: ${this.gameState.player.achievements.size} achievements
        </div>
      </div>
      
      <p style="color: #4ecdc4; font-size: 1.2em; margin-bottom: 30px;">
        ${t.drugPercentage>50?"You really embraced the psychedelic experience! 🌈":t.drugPercentage>25?"You had a balanced journey with some enhanced experiences! ✨":"You stayed mostly sober and focused on the experience! 🧘"}
      </p>
      
      <hr style="border: 1px solid #ff6b6b; margin: 30px 0;">
      
      <!-- Archetype Section -->
      <div style="margin-top: 30px;">
        <h2 style="color: #ffd23f; margin-bottom: 20px;">Your Burner Archetype</h2>
        ${i?`
          <div style="font-size: 4em; margin-bottom: 15px;">${i.emoji}</div>
          <h3 style="color: #ff6b6b; font-size: 2em; margin: 0 0 15px 0;">${i.name}</h3>
          <p style="color: #4ecdc4; font-size: 1.3em; margin: 10px 0;">${i.description}</p>
          <blockquote style="
            color: #ccc;
            font-style: italic;
            font-size: 1.1em;
            border-left: 3px solid #ff6b6b;
            padding-left: 20px;
            margin: 20px 0;
          ">"${i.quote}"</blockquote>
        `:`
          <p style="color: #888; font-size: 1.2em;">No archetype determined - explore more of your Burning Man journey!</p>
        `}
      </div>
      
      ${s.length>0?`
        <hr style="border: 1px solid #ff6b6b; margin: 30px 0;">
        <div style="margin-top: 30px;">
          <h2 style="color: #ffd23f; margin-bottom: 20px;">🏆 Awards Unlocked</h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            ${s.map(d=>`
              <div style="
                background: rgba(255, 215, 0, 0.2);
                padding: 15px;
                border-radius: 10px;
                border: 1px solid #ffd700;
              ">
                <div style="font-size: 2em; margin-bottom: 10px;">${d.emoji}</div>
                <h4 style="color: #ffd23f; margin: 0 0 8px 0;">${d.name}</h4>
                <p style="color: #ccc; font-size: 0.9em; margin: 0;">${d.description}</p>
              </div>
            `).join("")}
          </div>
        </div>
      `:""}
      
      <button onclick="window.gameLoop.resetAndStart()" style="
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        border: none;
        padding: 15px 30px;
        font-size: 1.2em;
        color: white;
        border-radius: 25px;
        cursor: pointer;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        transition: transform 0.3s ease;
        margin-top: 30px;
      " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        🔄 Play Again
      </button>
    `,o.appendChild(a),document.body.appendChild(o)}updateHellStationAndArtCars(t){if(!this.gameState.hellStation)return;const e=this.clock.now(),i=ei(this.gameState.hellStation,this.gameState.gasCans,e,this.rng);this.gameState.hellStation=i.station,this.gameState.gasCans=i.cans,this.gameState.artCars=this.gameState.artCars.map(s=>{const o=si(s,t),a=ai(o,this.gameState.gasCans);let n=a.car;a.collided&&a.canId&&(this.gameState.gasCans=this.gameState.gasCans.filter(h=>h.id!==a.canId));const r=ni(n,{cans:this.gameState.gasCans,station:this.gameState.hellStation,player:this.gameState.player}),l=ri(n,{cans:this.gameState.gasCans,station:this.gameState.hellStation,player:this.gameState.player});r==="seekFuel"&&console.log(`🚗 Art Car ${n.id}: seeking fuel, fuel level: ${n.fuel}/${n.fuelMax}`);let d={...n,state:r};if(l.targetPos&&r==="seekFuel"){const h=l.targetPos.x-d.pos.x,u=l.targetPos.y-d.pos.y,f=Math.hypot(h,u);if(f>5){const p=40*d.speed;d.vel.x=h/f*p,d.vel.y=u/f*p}}return ii(d,t)})}updateNotifications(t){W().updateNotifications(t)}calculateDrugSpeedMultiplier(){let t=1;for(const e of this.gameState.player.drugs.active)e.effects.speed&&(t+=e.effects.speed*e.intensity/100);return Math.max(.1,t)}showItemUsageNotifications(t){const e=st[t];if(!e)return;const i=this.gameState.player.position;e.effects.thirst&&L("thirst",e.effects.thirst,i),e.effects.hunger&&L("hunger",e.effects.hunger,i),e.effects.energy&&L("energy",e.effects.energy,i),e.effects.mood&&L("mood",e.effects.mood,i),e.effects.karma&&L("karma",e.effects.karma,i),e.effects.speed&&L("speed",e.effects.speed,i)}handleWorldTransition(t,e){if(this.gameState.player.isOnBike&&this.gameState.player.mountedBikeId){const s=this.worldManager.getWorldStateManager(),o=s.getWorldState(e),n=((o==null?void 0:o.items)||[]).find(r=>r.id===this.gameState.player.mountedBikeId);if(n){s.removeWorldItem(e,n.id);const r=t.newWorldId,l={...n,position:{...t.newPosition}};s.addWorldItem(r,l)}}this.gameState.player.position=t.newPosition;const i=this.worldManager.getCurrentWorldDimensions();this.camera.worldBounds={minX:0,minY:0,maxX:i.width,maxY:i.height},lt(this.camera,t.newPosition),this.spatialIndex=nt(i.width,i.height,100),this.loadCoinsForCurrentWorld(),this.audio.playSound("gameStart",.3),t.message&&console.log(t.message)}loadCoinsForCurrentWorld(){const t=this.worldManager.getCurrentWorldId(),s=this.worldManager.getWorldStateManager().getWorldState(t).items.filter(o=>o.type==="coin");s.length>0?(this.gameState.coins=s.map(o=>{var a;return{id:o.id,position:o.position,value:((a=o.data)==null?void 0:a.value)||1,collected:o.collected}}),this.gameState.coins.forEach(o=>{o.collected||q(this.spatialIndex,{id:o.id,position:o.position,radius:8})})):this.spawnCoinsForCurrentWorld()}spawnCoinsForCurrentWorld(){const t=this.worldManager.getCurrentWorldId(),e=this.worldManager.getCurrentWorldDimensions(),i=this.gameState.player.position,s=this.worldManager.getWorldStateManager();this.rng.setSeed(this.config.seed+t.length);const o=Ce(this.gameState.time.day),n=this.worldManager.getCurrentWorldId()==="playa"?4:1,r=Math.floor(this.config.coinCount*o*n*4),l=Math.floor(8*o*n*4),d=Math.floor(10*o*n*4),h=Math.floor(5*o*n*4),u=Math.floor(3.33*o*n*4),f=Math.floor(4*o*n*4),x=Math.floor(2*o*n*4),p=Re(this.rng,e.width,e.height,i,this.spatialIndex,r,l,d,h,u,f,x),g={count:Math.floor(120*o*n),minDistanceFromPlayer:100,minDistanceFromOtherMoop:30,worldBounds:{minX:0,maxX:e.width,minY:0,maxY:e.height}},y=He(g,i,[],this.rng);this.gameState.moop=y,this.gameState.coins=p.filter(S=>S.type==="coin").map(S=>({id:S.id,position:S.position,value:S.value,collected:S.collected})),p.forEach(S=>{s.addWorldItem(t,{id:S.id,type:S.type,position:S.position,collected:S.collected,data:{value:S.value,subtype:S.subtype}})})}render(){const t=this.worldManager.getCurrentWorldBackgroundColor(),e=fe(this.gameState.time,t),i=Z(this.worldManager.getCurrentWorldId(),this.gameState.time),s=this.audio.isMuted(),o=this.worldManager.getCurrentTimeScale(),a=bt(this.gameState.player.drugs),n=o*a,r=this.gameState.player.drugs.active,l=this.worldManager.getCurrentWorldId(),h=this.worldManager.getWorldStateManager().getWorldState(l),u=(h==null?void 0:h.items)||[];this.renderer.updateMousePosition(this.inputHandler.getMousePosition());const f=this.gameState.player.position,x=u.find(g=>!g.collected&&g.type==="bike"&&ot(f,g.position)<40),p=this.gameState.artCars.find(g=>Math.hypot(f.x-g.pos.x,f.y-g.pos.y)<80),m=!!this.gameState.player.mountedOn;this.renderer.render(this.gameState,this.camera,this.spatialIndex,e,i,s,n,r,this.worldManager.getCurrentWorldId(),u,this.gameState.moop,this.campMates,this.getRecentCoinChange(),this.getRecentKarmaChange(),x,p,m),this.checkPortalProximity(i),this.checkCampInteractions(i),this.checkPortopottyInteractions(),this.resetUsedPortopotties(),this.checkStatWarnings(),this.checkAndUnlockAwards(),window.dispatchEvent(new CustomEvent("gameStateUpdate",{detail:{...this.gameState,coinChange:this.getRecentCoinChange(),karmaChange:this.getRecentKarmaChange()}})),this.inputHandler.clearKeyPressed()}checkPortalProximity(t){const e=this.gameState.player.position,i=80;for(const s of t)if(s.type==="artCar"&&Math.sqrt(Math.pow(e.x-s.position.x,2)+Math.pow(e.y-s.position.y,2))<=i){this.handlePortalWarp(s.id);break}}handlePortalWarp(t){console.log("🌀 Portal warp triggered by proximity:",t);const e={minX:0,maxX:4e3,minY:0,maxY:4e3},i=Math.random()*(e.maxX-e.minX)+e.minX,s=Math.random()*(e.maxY-e.minY)+e.minY;this.gameState.player.position.x=i,this.gameState.player.position.y=s;const o=this.camera.followSpeed;this.camera.followSpeed=1e3,setTimeout(()=>{this.camera.followSpeed=o},1e3),console.log("🌀 Warped to:",{x:i,y:s})}resetUsedPortopotties(){const t=Date.now(),e=3e4;for(const i of this.gameState.portopotties)i.used&&i.usedTime&&t-i.usedTime>e&&(i.used=!1,i.usedTime=void 0)}checkPortopottyInteractions(){const t=this.gameState.player.position,e=80;for(const i of this.gameState.portopotties){const s=Math.sqrt(Math.pow(t.x-i.position.x,2)+Math.pow(t.y-i.position.y,2));if(s<=e+20&&s>e-10&&i.used,s<=e&&!i.used){this.gameState.player.stats.bathroom=0,i.used=!0,i.usedTime=Date.now(),W().addNotification("🚽 Bathroom break complete!","temporary",3e3,t),this.audio.playSound("buttonClick",.5),console.log(`🚽 Used portopotty ${i.id} at (${i.position.x}, ${i.position.y}), bathroom reset from ${this.gameState.player.stats.bathroom.toFixed(1)} to 0`);break}}}checkAndUnlockAwards(){const t=this.gameState.time.totalMinutes/60;this.awards=be(this.awards,this.gameState.player.stats,this.achievements,this.gameState.player.inventory,this.totalDrugsTaken,t,this.totalMoopCollected)}showArchetypeScreen(){const t=this.gameState.time.totalMinutes/60,e=kt(this.gameState.player.stats,this.achievements,this.gameState.player.inventory,this.totalDrugsTaken,t),i=this.awards.filter(g=>g.unlocked),s=document.createElement("div");s.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      color: white;
      font-family: 'Courier New', monospace;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    `;const o=document.createElement("div");o.style.cssText=`
      max-width: 800px;
      text-align: center;
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      border: 3px solid #8b5cf6;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 0 50px rgba(139, 92, 246, 0.5);
    `;const a=document.createElement("h1");a.style.cssText=`
      font-size: 3em;
      margin: 0 0 20px 0;
      background: linear-gradient(45deg, #FFD700, #FFA500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    `,a.textContent="🔥 BURNING MAN COMPLETE 🔥";const n=document.createElement("div");if(n.style.cssText=`
      margin: 30px 0;
      padding: 30px;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 15px;
      border: 2px solid ${(e==null?void 0:e.color)||"#8b5cf6"};
    `,e){const g=document.createElement("div");g.style.cssText="font-size: 4em; margin-bottom: 15px;",g.textContent=e.emoji;const y=document.createElement("h2");y.style.cssText=`
        font-size: 2em;
        margin: 0 0 10px 0;
        color: ${e.color};
        text-shadow: 0 0 10px ${e.color}50;
      `,y.textContent=e.name;const S=document.createElement("p");S.style.cssText="font-size: 1.2em; margin: 10px 0; color: #ccc;",S.textContent=e.description;const b=document.createElement("blockquote");b.style.cssText=`
        font-size: 1.1em;
        font-style: italic;
        margin: 20px 0;
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
        border-left: 4px solid ${e.color};
        border-radius: 5px;
      `,b.textContent=`"${e.quote}"`,n.appendChild(g),n.appendChild(y),n.appendChild(S),n.appendChild(b)}else{const g=document.createElement("p");g.style.cssText="font-size: 1.5em; color: #888;",g.textContent="🌟 Your Burning Man journey continues... 🌟",n.appendChild(g)}const r=document.createElement("div");r.style.cssText=`
      margin: 30px 0;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    `;const l=document.createElement("h3");l.style.cssText="color: #8b5cf6; margin-bottom: 15px;",l.textContent="📊 Your Journey Stats";const d=document.createElement("div");d.style.cssText=`
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    `;const h=this.gameState.time.totalMinutes*60,u=this.totalDrugsTaken*5;[{label:"⏰ Time Played",value:`${(h+u).toFixed(0)} seconds`},{label:"🌀 Time Distortion Bonus",value:`+${u.toFixed(0)}s from ${this.totalDrugsTaken} drugs`},{label:"🗑️ Moop Collected",value:`${this.totalMoopCollected} pieces`},{label:"✨ Karma Earned",value:`${this.gameState.player.stats.karma.toFixed(0)}`},{label:"🪙 Coins Found",value:`${this.gameState.player.stats.coins}`},{label:"🏆 Achievements",value:`${this.achievements.size}`},{label:"🎖️ Awards Unlocked",value:`${i.length}/${this.awards.length}`}].forEach(g=>{const y=document.createElement("div");y.style.cssText=`
        padding: 10px;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(139, 92, 246, 0.3);
      `;const S=document.createElement("div");S.style.cssText="font-size: 0.9em; color: #aaa; margin-bottom: 5px;",S.textContent=g.label;const b=document.createElement("div");b.style.cssText="font-size: 1.2em; font-weight: bold; color: #8b5cf6;",b.textContent=g.value,y.appendChild(S),y.appendChild(b),d.appendChild(y)}),r.appendChild(l),r.appendChild(d);const p=document.createElement("div");if(i.length>0){p.style.cssText=`
        margin: 30px 0;
        padding: 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
      `;const g=document.createElement("h3");g.style.cssText="color: #FFD700; margin-bottom: 15px;",g.textContent="🏆 Awards Unlocked";const y=document.createElement("div");y.style.cssText=`
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
        margin-top: 15px;
      `,i.forEach(S=>{const b=document.createElement("div");b.style.cssText=`
          padding: 10px;
          background: rgba(255, 215, 0, 0.1);
          border-radius: 8px;
          border: 1px solid rgba(255, 215, 0, 0.3);
          display: flex;
          align-items: center;
          gap: 10px;
        `;const w=document.createElement("span");w.style.cssText="font-size: 1.5em;",w.textContent=S.emoji;const v=document.createElement("div"),k=document.createElement("div");k.style.cssText="font-weight: bold; color: #FFD700;",k.textContent=S.name;const C=document.createElement("div");C.style.cssText="font-size: 0.9em; color: #ccc;",C.textContent=S.description,v.appendChild(k),v.appendChild(C),b.appendChild(w),b.appendChild(v),y.appendChild(b)}),p.appendChild(g),p.appendChild(y)}const m=document.createElement("button");m.style.cssText=`
      margin-top: 30px;
      padding: 15px 30px;
      font-size: 1.2em;
      background: linear-gradient(45deg, #8b5cf6, #7c3aed);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    `,m.textContent="Continue Your Journey",m.onclick=()=>{document.body.removeChild(s)},m.onmouseover=()=>{m.style.transform="scale(1.05)",m.style.boxShadow="0 0 20px rgba(139, 92, 246, 0.5)"},m.onmouseout=()=>{m.style.transform="scale(1)",m.style.boxShadow="none"},o.appendChild(a),o.appendChild(n),o.appendChild(r),i.length>0&&o.appendChild(p),o.appendChild(m),s.appendChild(o),document.body.appendChild(s)}checkStatWarnings(){const t=this.clock.now(),e=this.gameState.player.stats,i=W();t-this.lastStatWarningTime<this.statWarningCooldown||(e.energy<=15?(i.addNotification("⚡ You are exhausted! You need to get some rest!","temporary",4e3,this.gameState.player.position),this.lastStatWarningTime=t,this.audio.playSound("buttonClick",.3)):e.thirst>=85?(i.addNotification("💧 You are severely dehydrated! Find water immediately!","temporary",4e3,this.gameState.player.position),this.lastStatWarningTime=t,this.audio.playSound("buttonClick",.3)):e.hunger>=85?(i.addNotification("🍔 You are starving! You need food right now!","temporary",4e3,this.gameState.player.position),this.lastStatWarningTime=t,this.audio.playSound("buttonClick",.3)):e.mood<=15?(i.addNotification("😢 You are deeply depressed! Do something fun or eat some food!","temporary",4e3,this.gameState.player.position),this.lastStatWarningTime=t,this.audio.playSound("buttonClick",.3)):e.bathroom>=85&&(i.addNotification("🚽 You desperately need a bathroom! Find a portopotty!","temporary",4e3,this.gameState.player.position),this.lastStatWarningTime=t,this.audio.playSound("buttonClick",.3)))}checkCampInteractions(t){const e=this.gameState.player.position,i=100;let s=!1;const a=Date.now()-this.lastDialogueCloseTime,n=3e3;for(const r of t)if(r.type==="camp"&&(r.id==="hell-station"||r.id==="center-camp")&&Math.sqrt(Math.pow(e.x-r.position.x,2)+Math.pow(e.y-r.position.y,2))<=i&&(s=!0,!this.dialogueOverlay&&a>n)){this.showCampDialogue(r);break}!s&&this.dialogueOverlay&&this.dialogueOverlay.dataset.dialog!=="gift"&&this.closeDialogue()}showCampDialogue(t){if(this.dialogueOverlay)return;this.dialogueOverlay=document.createElement("div"),this.dialogueOverlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      font-family: system-ui, -apple-system, sans-serif;
    `;const e=document.createElement("div");e.style.cssText=`
      background: linear-gradient(135deg, #2c3e50, #34495e);
      border: 3px solid #f39c12;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    `;let i="";t.id==="hell-station"?i=`
        <h2 style="color: #f39c12; margin: 0 0 20px 0; font-size: 24px;">⛽ Hell Station</h2>
        <p style="color: #ecf0f1; margin: 0 0 20px 0; font-size: 16px;">
          Buy gas for the art cars?<br>
          <strong>Cost:</strong> 40 coins<br>
          <strong>Reward:</strong> 20 karma
        </p>
        <div style="display: flex; gap: 15px; justify-content: center;">
          <button id="buy-gas" style="
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
          ">Buy Gas (40 coins)</button>
          <button id="close-dialogue" style="
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
          ">Cancel</button>
        </div>
      `:t.id==="center-camp"&&(i=`
        <h2 style="color: #3498db; margin: 0 0 20px 0; font-size: 24px;">🏕️ Center Camp</h2>
        <p style="color: #ecf0f1; margin: 0 0 20px 0; font-size: 16px;">
          What would you like to buy?<br>
          <strong>Cost:</strong> 10 coins each<br>
          <strong>Ice:</strong> +5 karma<br>
          <strong>Tea:</strong> +20 energy
        </p>
        <div style="display: flex; gap: 15px; justify-content: center;">
          <button id="buy-ice" style="
            background: linear-gradient(135deg, #3498db, #5dade2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
          ">🧊 Buy Ice (10 coins)</button>
          <button id="buy-tea" style="
            background: linear-gradient(135deg, #8b4513, #a0522d);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
          ">🍵 Buy Tea (10 coins)</button>
          <button id="close-dialogue" style="
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
          ">Cancel</button>
        </div>
      `),e.innerHTML=i,this.dialogueOverlay.appendChild(e),document.body.appendChild(this.dialogueOverlay);const s=document.getElementById("buy-gas"),o=document.getElementById("buy-ice"),a=document.getElementById("buy-tea"),n=document.getElementById("close-dialogue");s&&s.addEventListener("click",()=>this.handleBuyGas()),o&&o.addEventListener("click",()=>this.handleBuyIce()),a&&a.addEventListener("click",()=>this.handleBuyTea()),n&&n.addEventListener("click",()=>this.closeDialogue()),this.dialogueOverlay.addEventListener("click",r=>{r.target===this.dialogueOverlay&&this.closeDialogue()})}handleBuyGas(){if(this.gameState.player.stats.coins>=40){this.gameState.player.stats.coins-=40,this.gameState.player.stats.karma+=20;const i=L("karma",20,"Gas purchase");W().addNotification(i),console.log("⛽ Bought gas: -40 coins, +20 karma"),this.closeDialogue()}else alert("Not enough coins! You need 40 coins to buy gas.")}handleBuyIce(){this.gameState.player.stats.coins>=10?(this.trackCoinChange(-10),this.trackKarmaChange(5),this.gameState.player.stats.coins-=10,this.gameState.player.stats.karma+=5,W().addNotification("🧊 Bought Ice: -10 coins, +5 karma","item",5,this.gameState.player.position),console.log("🧊 Bought ice: -10 coins, +5 karma"),this.closeDialogue()):alert("Not enough coins! You need 10 coins to buy ice.")}handleBuyTea(){this.gameState.player.stats.coins>=10?(this.trackCoinChange(-10),this.gameState.player.stats.coins-=10,this.gameState.player.stats.energy=Math.min(100,this.gameState.player.stats.energy+20),W().addNotification("🍵 Bought Tea: -10 coins, +20 energy","energy",20,this.gameState.player.position),console.log("🍵 Bought tea: -10 coins, +20 energy"),this.closeDialogue()):alert("Not enough coins! You need 10 coins to buy tea.")}closeDialogue(){this.dialogueOverlay&&(document.body.removeChild(this.dialogueOverlay),this.dialogueOverlay=null,this.lastDialogueCloseTime=Date.now())}updateCampMates(t){const e={x:800,y:600},i=300,s=40,o=2;this.gameState.player.equippedItem==="Totem"?this.worldManager.getCurrentWorldId()!=="camp"&&this.wombatsAtCamp>0&&(this.spawnWombatFromCamp(),this.wombatsAtCamp--,this.wombatsOnPlaya++,console.log(`🏕️ Wombat followed to playa! Camp: ${this.wombatsAtCamp}, Playa: ${this.wombatsOnPlaya}`)):this.worldManager.getCurrentWorldId()==="playa"&&this.checkForWombatsOverlappingCamp(),this.campMates.forEach(a=>{let n,r;if(this.gameState.player.equippedItem==="Totem"){const u=Math.atan2(this.gameState.player.position.y-a.position.y,this.gameState.player.position.x-a.position.x),f=parseInt(a.id.replace("campmate-","")),x=f*.5%(Math.PI*2),p=u+Math.PI+x,m=15+f%3*5;n=this.gameState.player.position.x+Math.cos(p)*m,r=this.gameState.player.position.y+Math.sin(p)*m}else{const u=this.worldManager.getCurrentWorldId();n=a.targetPosition.x,r=a.targetPosition.y}const l=n-a.position.x,d=r-a.position.y,h=Math.sqrt(l*l+d*d);if(h<10&&this.gameState.player.equippedItem!=="Totem")if(this.worldManager.getCurrentWorldId()==="playa"){const x=this.rng.random()*Math.PI*2,p=this.rng.random()*800;a.targetPosition.x=a.position.x+Math.cos(x)*p,a.targetPosition.y=a.position.y+Math.sin(x)*p}else{const f=this.rng.random()*Math.PI*2,x=this.rng.random()*i;a.targetPosition.x=e.x+Math.cos(f)*x,a.targetPosition.y=e.y+Math.sin(f)*x}else{const u=this.gameState.player.equippedItem==="Totem"?80:50,f=a.speed*t*u;let x=l/h*f,p=d/h*f,m=0,g=0;this.campMates.forEach(S=>{if(S.id!==a.id){const b=a.position.x-S.position.x,w=a.position.y-S.position.y,v=Math.sqrt(b*b+w*w);if(v<s&&v>0){const k=(s-v)/s,C=b/v,B=w/v;m+=C*k*o,g+=B*k*o}}}),x+=m*t*30,p+=g*t*30,a.position.x+=x,a.position.y+=p;const y=this.worldManager.getCurrentWorldId();if(this.gameState.player.equippedItem!=="Totem"&&y==="camp"){const S=Math.sqrt(Math.pow(a.position.x-e.x,2)+Math.pow(a.position.y-e.y,2));if(S>i){const b=(e.x-a.position.x)/S*5,w=(e.y-a.position.y)/S*5;a.position.x+=b,a.position.y+=w}}}})}checkForWombatsOverlappingCamp(){const e=Z(this.worldManager.getCurrentWorldId(),this.gameState.time).find(n=>n.id==="playa-camp");if(!e)return;const i=e.position.x,s=e.position.y,o=100,a=[];this.campMates.forEach((n,r)=>{Math.sqrt(Math.pow(n.position.x-i,2)+Math.pow(n.position.y-s,2))<=o&&a.push(r)}),a.length>0&&(a.reverse().forEach(n=>{this.campMates.splice(n,1),this.wombatsOnPlaya--,this.wombatsAtCamp++}),console.log(`🏕️ ${a.length} wombat(s) returned to camp due to overlap! Camp: ${this.wombatsAtCamp}, Playa: ${this.wombatsOnPlaya}`))}spawnWombatFromCamp(){const t=["#ff6b6b","#4ecdc4","#45b7d1","#96ceb4","#feca57","#ff9ff3","#54a0ff","#5f27cd","#00d2d3","#ff9f43","#10ac84","#ee5a24","#0984e3","#6c5ce7","#a29bfe","#fd79a8","#fdcb6e","#e17055","#74b9ff","#0984e3"],e=["Wally","Wendy","Winston","Willow","Wade","Wanda","Wesley","Whitney","Warren","Wren","Walker","Winter","Weston","Waverly","Wilder","Willa","Wells","Wynn","Wyatt","Willa","Wade","Willa","Wren","Wade"],s=Z(this.worldManager.getCurrentWorldId(),this.gameState.time).find(r=>r.id==="playa-camp");let o,a;if(s){const r=30+this.rng.random()*40,l=this.rng.random()*Math.PI*2;o=s.position.x+Math.cos(l)*r,a=s.position.y+Math.sin(l)*r}else{const r=50+this.rng.random()*50,l=this.rng.random()*Math.PI*2;o=this.gameState.player.position.x+Math.cos(l)*r,a=this.gameState.player.position.y+Math.sin(l)*r}const n={id:`campmate-${Date.now()}-${Math.random()}`,position:T(o,a),color:t[Math.floor(Math.random()*t.length)],name:e[Math.floor(Math.random()*e.length)],targetPosition:T(o,a),speed:.5+this.rng.random()*1,mood:40+this.rng.random()*40};this.campMates.push(n),console.log(s?`🏕️ Spawned wombat at (${o.toFixed(1)}, ${a.toFixed(1)}) from Boom Boom Womb`:`🏕️ Spawned wombat at (${o.toFixed(1)}, ${a.toFixed(1)}) near player`)}isPlayerNearLandmark(t,e,i){const o=Z(this.worldManager.getCurrentWorldId(),this.gameState.time).find(n=>n.id===e);return o?Math.sqrt(Math.pow(t.x-o.position.x,2)+Math.pow(t.y-o.position.y,2))<=i:!1}getGameState(){return{...this.gameState}}updateAchievementTracking(t){const e=this.gameState.player,i=Date.now(),s=e.position.x-e.lastPosition.x,o=e.position.y-e.lastPosition.y,a=Math.sqrt(s*s+o*o);this.worldManager.getCurrentWorldId()==="playa"&&(e.totalDistanceTraveled+=a),e.lastPosition={...e.position};const n=e.stats.mood,r=(i-e.lastMoodTime)/1e3;n>=80?(e.moodStreakHigh+=r,e.moodStreakLow=0):n<=20?(e.moodStreakLow+=r,e.moodStreakHigh=0):(e.lastMoodValue<=20&&n>=80&&this.checkMoodBounceAchievement(),e.moodStreakHigh=0,e.moodStreakLow=0),e.lastMoodValue=n,e.lastMoodTime=i,[e.stats.energy,e.stats.mood,e.stats.thirst,e.stats.hunger].every(h=>h>70)?e.balancedStatsTime+=r:e.balancedStatsTime=0,this.gameState.time.day===8&&this.gameState.time.hour>=18&&e.equippedItem==="Totem"&&(e.totemUsedDuringManBurn=!0),this.checkDistanceAchievements(),this.checkMoodStreakAchievements(),this.checkBalancedStatsAchievement()}checkDistanceAchievements(){const e=this.gameState.player.totalDistanceTraveled/1e3;e>=6&&!this.gameState.player.achievements.has("playa-wanderer")&&this.unlockAchievement("playa-wanderer","Playa Wanderer","🏃‍♂️ Traveled 6km across the playa"),e>=15&&!this.gameState.player.achievements.has("playa-explorer")&&this.unlockAchievement("playa-explorer","Playa Explorer","🗺️ Traveled 15km across the playa"),e>=30&&!this.gameState.player.achievements.has("playa-nomad")&&this.unlockAchievement("playa-nomad","Playa Nomad","🌵 Traveled 30km across the playa")}checkMoodStreakAchievements(){const t=this.gameState.player,e=t.moodStreakHigh/60;e>=5&&!t.achievements.has("mood-streak-5min")&&this.unlockAchievement("mood-streak-5min","Mood Master","😊 Stayed happy for 5 minutes straight"),e>=10&&!t.achievements.has("mood-streak-10min")&&this.unlockAchievement("mood-streak-10min","Zen Master","🧘 Stayed happy for 10 minutes straight"),e>=20&&!t.achievements.has("mood-streak-20min")&&this.unlockAchievement("mood-streak-20min","Bliss Master","✨ Stayed happy for 20 minutes straight")}checkMoodBounceAchievement(){this.gameState.player.achievements.has("mood-bounce")||this.unlockAchievement("mood-bounce","Mood Bouncer","🎢 Bounced from depressed to ecstatic")}checkBalancedStatsAchievement(){this.gameState.player.balancedStatsTime/60>=10&&!this.gameState.player.achievements.has("balanced-burner")&&this.unlockAchievement("balanced-burner","Balanced Burner","⚖️ Maintained all stats above 70 for 10 minutes")}checkGiftingAchievements(){const t=this.gameState.player;t.totalItemsGifted>=10&&!t.achievements.has("gifter-10")&&this.unlockAchievement("gifter-10","Generous Gifter","🎁 Gifted 10 items to others"),t.totalItemsGifted>=50&&!t.achievements.has("gifter-50")&&this.unlockAchievement("gifter-50","Radical Gifter","🎁 Gifted 50 items to others"),t.totalItemsGifted>=200&&!t.achievements.has("gifter-200")&&this.unlockAchievement("gifter-200","Gifting Legend","🎁 Gifted 200 items to others"),t.totalKarmaGifted>=50&&!t.achievements.has("karma-gifter-50")&&this.unlockAchievement("karma-gifter-50","Karma Builder","✨ Gave 50+ karma worth of gifts"),t.totalKarmaGifted>=250&&!t.achievements.has("karma-gifter-250")&&this.unlockAchievement("karma-gifter-250","Karma Master","✨ Gave 250+ karma worth of gifts"),t.totalKarmaGifted>=1e3&&!t.achievements.has("karma-gifter-1000")&&this.unlockAchievement("karma-gifter-1000","Karma Legend","✨ Gave 1000+ karma worth of gifts")}checkManBurnTotemAchievement(){this.gameState.player.totemUsedDuringManBurn&&!this.gameState.player.achievements.has("man-burn-totemist")&&this.unlockAchievement("man-burn-totemist","Man Burn Totemist","🪩 Used Totem during the Man Burn")}unlockAchievement(t,e,i){this.gameState.player.achievements.add(t),console.log(`🏆 Achievement unlocked: ${e} - ${i}`),W().addNotification(`🏆 ${e}`,"achievement",5e3,this.gameState.player.position),this.showAchievementCelebration(e,i)}showAchievementCelebration(t,e){const i=document.createElement("div");i.style.cssText=`
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100000;
      font-family: 'Courier New', monospace;
      pointer-events: none;
      text-align: center;
    `;const s=document.createElement("div");s.style.cssText=`
      text-align: center;
      animation: achievementPulse 2s ease-in-out;
      max-width: 400px;
      position: relative;
      overflow: hidden;
    `;const o=document.createElement("style");o.textContent=`
      @keyframes achievementPulse {
        0% { transform: scale(0.8); opacity: 0; }
        50% { transform: scale(1.05); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
      }
    `,document.head.appendChild(o),s.innerHTML=`
      <div style="font-size: 2em; margin-bottom: 10px;">🏆</div>
      <h2 style="color: #ffd700; font-size: 1.5em; margin: 0 0 8px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
        ${t}
      </h2>
      <p style="color: #fff; font-size: 1em; margin: 0; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
        ${e}
      </p>
    `,i.appendChild(s),document.body.appendChild(i),setTimeout(()=>{document.body.contains(i)&&document.body.removeChild(i),document.head.contains(o)&&document.head.removeChild(o)},3e3)}reset(){this.worldManager.forceTransitionToWorld("camp",T(800,600)),this.initializeGameState()}resetAndStart(){document.querySelectorAll('[style*="z-index: 10000"], [style*="z-index: 999999"]').forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),this.reset(),this.start()}loadGameState(t){this.gameState={...t},this.lastPlayerPosition={...t.player.position},this.spatialIndex=nt(this.config.canvasWidth*2,this.config.canvasHeight*2,100),t.coins.forEach(e=>{e.collected||q(this.spatialIndex,{id:e.id,position:e.position,radius:8})}),lt(this.camera,t.player.position)}}class fi{now(){return performance.now()}requestAnimationFrame(t){return requestAnimationFrame(t)}cancelAnimationFrame(t){cancelAnimationFrame(t)}}class xi{constructor(t=Date.now()){M(this,"seed");M(this,"current");this.seed=t,this.current=t}random(){return this.current=(this.current*1664525+1013904223)%4294967296,this.current/4294967296}randomInt(t,e){return Math.floor(this.randomRange(t,e))}randomRange(t,e){return t+this.random()*(e-t)}setSeed(t){this.seed=t,this.current=t}getSeed(){return this.seed}}class gi{constructor(t="wombat-quest-"){M(this,"prefix");this.prefix=t}getKey(t){return this.prefix+t}async save(t,e){try{const i=JSON.stringify(e);localStorage.setItem(this.getKey(t),i)}catch(i){throw new Error(`Failed to save data for key "${t}": ${i}`)}}async load(t){try{const e=localStorage.getItem(this.getKey(t));return e===null?null:JSON.parse(e)}catch(e){throw new Error(`Failed to load data for key "${t}": ${e}`)}}async remove(t){try{localStorage.removeItem(this.getKey(t))}catch(e){throw new Error(`Failed to remove data for key "${t}": ${e}`)}}async exists(t){try{return localStorage.getItem(this.getKey(t))!==null}catch(e){throw new Error(`Failed to check existence for key "${t}": ${e}`)}}async keys(){try{const t=[];for(let e=0;e<localStorage.length;e++){const i=localStorage.key(e);i&&i.startsWith(this.prefix)&&t.push(i.substring(this.prefix.length))}return t}catch(t){throw new Error(`Failed to get keys: ${t}`)}}}class mi{constructor(){M(this,"audioContext");M(this,"sounds",new Map);M(this,"masterVolume",.7);M(this,"muted",!0);M(this,"masterGainNode");this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGainNode=this.audioContext.createGain(),this.masterGainNode.connect(this.audioContext.destination),this.masterGainNode.gain.value=this.masterVolume;const t=()=>{this.audioContext.state==="suspended"&&this.audioContext.resume(),document.removeEventListener("click",t),document.removeEventListener("keydown",t)};document.addEventListener("click",t),document.addEventListener("keydown",t)}async loadSound(t,e){try{const s=await(await fetch(e)).arrayBuffer(),o=await this.audioContext.decodeAudioData(s);this.sounds.set(t,{buffer:o})}catch(i){console.warn(`Failed to load sound ${t}:`,i);const s=this.audioContext.createBuffer(1,1,22050);this.sounds.set(t,{buffer:s})}}playSound(t,e=1){if(this.muted)return;this.audioContext.state==="suspended"&&this.audioContext.resume();const i=this.sounds.get(t);if(!i){console.warn(`Sound ${t} not found`);return}try{const s=this.audioContext.createBufferSource();s.buffer=i.buffer;const o=this.audioContext.createGain();o.gain.value=e*this.masterVolume,s.connect(o),o.connect(this.masterGainNode),s.start(0)}catch(s){console.warn(`Failed to play sound ${t}:`,s)}}stopSound(t){const e=this.sounds.get(t);if(e&&e.source)try{e.source.stop(),e.source.disconnect(),e.source=void 0}catch{}}setMasterVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),this.masterGainNode.gain.value=this.muted?0:this.masterVolume}getMasterVolume(){return this.masterVolume}setMuted(t){this.muted=t,this.masterGainNode.gain.value=t?0:this.masterVolume}isMuted(){return this.muted}async preloadGameSounds(){const t={coinPickup:this.generateCoinPickupSound(),playerMove:this.generatePlayerMoveSound(),playerRest:this.generatePlayerRestSound(),buttonClick:this.generateButtonClickSound(),gameStart:this.generateGameStartSound(),gameOver:this.generateGameOverSound()},e=Object.entries(t).map(([i,s])=>this.loadSound(i,s));await Promise.all(e)}generateCoinPickupSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,.2*e,e),s=i.getChannelData(0);for(let o=0;o<s.length;o++){const a=o/e,n=Math.exp(-a*8),r=800+400*Math.sin(a*20);s[o]=n*.3*Math.sin(2*Math.PI*r*a)}return this.bufferToDataUrl(i)}generatePlayerMoveSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,.1*e,e),s=i.getChannelData(0);for(let o=0;o<s.length;o++){const a=o/e,n=Math.exp(-a*15),r=200+100*Math.random();s[o]=n*.1*Math.sin(2*Math.PI*r*a)}return this.bufferToDataUrl(i)}generatePlayerRestSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,.5*e,e),s=i.getChannelData(0);for(let o=0;o<s.length;o++){const a=o/e,n=Math.exp(-a*2),r=150-50*a;s[o]=n*.2*Math.sin(2*Math.PI*r*a)}return this.bufferToDataUrl(i)}generateButtonClickSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,.05*e,e),s=i.getChannelData(0);for(let o=0;o<s.length;o++){const a=o/e,n=Math.exp(-a*30),r=1e3;s[o]=n*.2*Math.sin(2*Math.PI*r*a)}return this.bufferToDataUrl(i)}generateGameStartSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,.8*e,e),s=i.getChannelData(0);for(let o=0;o<s.length;o++){const a=o/e,n=Math.exp(-a*1.5),r=400+200*a;s[o]=n*.3*Math.sin(2*Math.PI*r*a)}return this.bufferToDataUrl(i)}generateGameOverSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,1*e,e),s=i.getChannelData(0);for(let o=0;o<s.length;o++){const a=o/e,n=Math.exp(-a*1),r=600-400*a;s[o]=n*.25*Math.sin(2*Math.PI*r*a)}return this.bufferToDataUrl(i)}bufferToDataUrl(t){const e=t.length,i=t.sampleRate,s=new ArrayBuffer(44+e*2),o=new DataView(s),a=(d,h)=>{for(let u=0;u<h.length;u++)o.setUint8(d+u,h.charCodeAt(u))};a(0,"RIFF"),o.setUint32(4,36+e*2,!0),a(8,"WAVE"),a(12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,1,!0),o.setUint32(24,i,!0),o.setUint32(28,i*2,!0),o.setUint16(32,2,!0),o.setUint16(34,16,!0),a(36,"data"),o.setUint32(40,e*2,!0);const n=t.getChannelData(0);let r=44;for(let d=0;d<e;d++){const h=Math.max(-1,Math.min(1,n[d]));o.setInt16(r,h*32767,!0),r+=2}const l=new Blob([s],{type:"audio/wav"});return URL.createObjectURL(l)}}class pi{constructor(t={}){M(this,"gameLoop",null);M(this,"clock");M(this,"rng");M(this,"storage");M(this,"audio");M(this,"worldManager");this.clock=new fi,this.rng=new xi(t.seed),this.storage=new gi,this.audio=new mi;const e=new we(this.storage);this.worldManager=new ke("camp",e);const i={canvasWidth:t.canvasWidth??800,canvasHeight:t.canvasHeight??600,playerSize:t.playerSize??32,seed:this.rng.getSeed(),coinCount:t.coinCount??10};this.initializeGame(i)}initializeGame(t){const e=document.getElementById("gameCanvas");if(!e)throw new Error('Canvas element with id "gameCanvas" not found');this.gameLoop=new ui(e,this.clock,this.rng,this.audio,this.worldManager,t)}async start(){if(!this.gameLoop)throw new Error("Game loop not initialized");try{await this.audio.preloadGameSounds(),console.log("Audio system initialized successfully")}catch(t){console.warn("Audio initialization failed, continuing without audio:",t)}this.gameLoop.start()}stop(){this.gameLoop&&this.gameLoop.stop()}reset(){this.gameLoop&&this.gameLoop.reset()}getRng(){return this.rng}getClock(){return this.clock}getAudio(){return this.audio}getWorldManager(){return this.worldManager}getGameLoop(){if(!this.gameLoop)throw new Error("Game loop not initialized");return this.gameLoop}async saveGame(t="autosave"){if(!this.gameLoop)throw new Error("Game loop not initialized");const i={gameState:this.gameLoop.getGameState(),timestamp:Date.now(),version:"1.0.0"};await this.storage.save(t,i)}async loadGame(t="autosave"){if(!this.gameLoop)throw new Error("Game loop not initialized");try{const e=await this.storage.load(t);return e?(this.gameLoop.loadGameState(e.gameState),!0):!1}catch(e){return console.error("Failed to load game:",e),!1}}async hasSave(t="autosave"){return await this.storage.exists(t)}getStorage(){return this.storage}}const pt=new pi({canvasWidth:window.innerWidth,canvasHeight:window.innerHeight,playerSize:32,seed:Math.floor(Math.random()*1e6),coinCount:90});pt.start().catch(console.error);window.app=pt;window.gameLoop=pt.getGameLoop();window.equipItem=c=>{const t=window.gameLoop.getGameState();return Et(t.player,c)};window.unequipItem=()=>{const c=window.gameLoop.getGameState();return xt(c.player)};
